<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MMU-Monitoring Dashboard</title>

<!-- Self-hosted Excel parser (place xlsx.full.min.js next to this file) -->
<script src="./xlsx.full.min.js"></script>

<!-- PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

<!-- Charts + dates -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/dayjs.min.js"></script>

<style>
/* ------------------- Glassmorphic Light Theme ------------------- */
:root{
  --bg: #f3f5fb;               /* soft neutral */
  --glass: rgba(255,255,255,0.6);
  --glass-strong: rgba(255,255,255,0.75);
  --glass-hover: rgba(255,255,255,0.9);
  --blur: 14px;

  --ink: #0f172a;              /* slate-900 */
  --muted:#6b7280;             /* slate-500 */
  --border: rgba(15,23,42,.12);
  --shadow: 0 12px 40px rgba(2,6,23,.08);

  /* Brand & semantic color code */
  --brand:#9b1c24;             /* deep burgundy */
  --gold:#c89d2a;              /* accent gold */
  --ok:#16a34a;                /* green */
  --warn:#d97706;              /* amber */
  --info:#2563eb;              /* blue */
  --danger:#dc2626;            /* red */

  /* Status tones (pills/tags) */
  --st-delivered-bg:#ecfdf5; --st-delivered-fg:#166534; --st-delivered-bd:#86efac;
  --st-intransit-bg:#eff6ff; --st-intransit-fg:#1e3a8a; --st-intransit-bd:#bfdbfe;
  --st-pending-bg:#fffbeb;   --st-pending-fg:#7c2d12;  --st-pending-bd:#fde68a;
  --st-exception-bg:#fef2f2; --st-exception-fg:#7f1d1d;--st-exception-bd:#fecaca;

  --radius:16px;
}

/* Page background with subtle gradient + texture */
html,body{height:100%}
body{
  margin:0;
  color:var(--ink);
  font-family:system-ui, Segoe UI, Roboto, Arial, sans-serif;
  background:
    radial-gradient(1200px 700px at 20% -10%, #ffffff 0%, #eef2ff 45%, #e9f0ff00 60%),
    radial-gradient(1000px 800px at 110% 10%, #fff 0%, #f3f5fb 40%, #f3f5fb 100%);
}

/* Generic containers */
.wrap{max-width:1280px;margin:0 auto;padding:14px}
.card{
  background: var(--glass);
  backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur));
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px;
  box-shadow: var(--shadow);
}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.grid{display:grid;gap:14px}
.grow{flex:1 1 auto}
.hidden{display:none!important}
.right{margin-left:auto}

/* Inputs / Buttons */
input,select,textarea,button{
  background: var(--glass-strong);
  backdrop-filter: blur(calc(var(--blur) - 4px));
  -webkit-backdrop-filter: blur(calc(var(--blur) - 4px));
  color: var(--ink);
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px 12px;
}
input::placeholder{color:var(--muted)}
button.btn{
  background: linear-gradient(180deg, rgba(200,157,42,.18), rgba(200,157,42,.10));
  border-color: rgba(200,157,42,.45);
  color:#111827;
  font-weight:700;
}
.btn.ghost{background:var(--glass-strong);border-color:var(--border)}
.btn.red{background:linear-gradient(180deg,rgba(220,38,38,.12),rgba(220,38,38,.06));border-color:rgba(220,38,38,.35)}
.btn.gray{background:var(--glass-strong)}
.badge{font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid var(--border);color:#111827;background:var(--glass-strong)}

/* Header: glass bar */
.header{
  position:sticky;top:0;z-index:50;
  border-bottom:1px solid var(--border);
  background: var(--glass);
  backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur));
}
.header-inner{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:8px}
.brand{display:flex;gap:10px;align-items:center;font-weight:900;font-size:18px;color:#111827}
.head-actions{justify-self:end;display:flex;gap:8px;align-items:center}
.head-center{justify-self:center;display:flex;gap:8px;align-items:center}

/* Tabs BAR (now separate section BELOW header) */
.tabs-shell{ /* this sits BELOW the header for proper spacing */
  background: transparent;
}
.tabs-bar{
  display:flex;align-items:center;gap:8px;
  padding:10px 0 6px 0;
  margin-bottom:12px;
}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{
  padding:8px 12px;border-radius:999px;border:1px solid var(--border);
  background: var(--glass-strong);
  font-weight:700;color:#111827
}
.tab.active{
  border-color: rgba(200,157,42,.6);
  box-shadow: inset 0 0 0 2px rgba(200,157,42,.25);
}

#alertsSlot {margin-left:auto; position: relative; z-index: 50; }
#alertMenu{
  position:absolute; right:0; top:36px; min-width:320px; z-index: 9999;
}

/* Tables: full borders + inline filters row (glass) */
.table-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px;background:var(--glass-strong);backdrop-filter:blur(calc(var(--blur) - 4px))}
table{border-collapse:separate;border-spacing:0;width:100%;min-width:900px;background:transparent}
th,td{
  padding:10px 12px;
  border-right:1px solid var(--border);
  border-bottom:1px solid var(--border);
  background: transparent;
}
th{
  position:sticky;top:0;
  background: var(--glass-hover);
  backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur));
  font-size:12px;text-transform:uppercase;letter-spacing:.35px;color:#374151;z-index:1
}
tr:last-child td{border-bottom:none}
table tr th:first-child, table tr td:first-child{border-left:1px solid var(--border)}
table thead tr:first-child th{border-top:1px solid var(--border)}

/* Inline filter row (sticks below the header row) */
tr.filter-row th, tr.filter-row td{
  background: var(--glass-strong);
  backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur));
  position:sticky;
  top:38px;           /* directly under headers */
  z-index:1;
}
.inline-filter{
  width:100%;
  padding:6px 8px;
  border:1px solid var(--border);
  border-radius:8px;
  background: var(--glass-hover);
  font-size:12px;
}

/* Status pills with semantic color code */
.pill{padding:3px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;background:var(--glass-strong)}
.pill.delivered{border-color:var(--st-delivered-bd);color:var(--st-delivered-fg);background:var(--st-delivered-bg)}
.pill.intransit{border-color:var(--st-intransit-bd);color:var(--st-intransit-fg);background:var(--st-intransit-bg)}
.pill.pending{border-color:var(--st-pending-bd);color:var(--st-pending-fg);background:var(--st-pending-bg)}
.pill.exception{border-color:var(--st-exception-bd);color:var(--st-exception-fg);background:var(--st-exception-bg)}

/* KPI cards */
.kpi{font-size:28px;font-weight:900;color:#111827}

/* Login (glass) */
.login-host{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.login-card{
  width:min(640px,96vw);
  background: var(--glass);
  backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur));
  border:1px solid var(--border);
  border-radius:24px;
  padding:26px;
  box-shadow:var(--shadow)
}
.login-card .title{font-size:40px;font-weight:900;text-align:center;color:#111827;margin:4px 0 20px}
.field{margin:12px 0}
.field label{display:block;margin:0 0 8px 0;color:#374151;font-weight:700}
.input-wrap{display:flex;align-items:center;gap:8px;background:var(--glass-strong);border:1px solid var(--border);border-radius:12px;padding:10px}
.input-wrap input{background:transparent;border:none;outline:none;color:#111827;width:100%}
.input-wrap .icon{opacity:.7}
.login-actions{display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:center;margin-top:14px}
.login-actions .sub{color:#6b7280;text-align:left}
.err{color:#b91c1c;font-weight:700;margin-top:8px}
</style>
</head>
<body>
<!-- =================== LOGIN =================== -->
<div id="loginScreen" class="login-host">
  <div class="login-card">
    <div class="title">Welcome</div>

    <div class="field">
      <label>User ID</label>
      <div class="input-wrap">
        <span class="icon">üë§</span>
        <input id="lgUser" placeholder="User ID">
      </div>
    </div>

    <div class="field">
      <label>Password</label>
      <div class="input-wrap">
        <span class="icon">üîí</span>
        <input id="lgPass" type="password" placeholder="Password">
        <button class="btn ghost" style="padding:6px 10px" onclick="togglePw()" title="Show/Hide">üëÅÔ∏è</button>
      </div>
    </div>

    <div class="login-actions">
      <div class="sub">Change password</div>
      <div class="sub" style="text-align:right">Forgot password?</div>

      <button class="btn ghost" onclick="clearLogin()">Clear</button>
      <button class="btn" onclick="doLogin()">Log in</button>
    </div>

    <div id="lgErr" class="err hidden"></div>
  </div>
</div>

<!-- =================== HEADER (glass) =================== -->
<div id="appHeader" class="header hidden">
  <div class="wrap header-inner">
    <div class="brand">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="#c89d2a" aria-hidden="true">
        <path d="M12 2l4 4-4 4-4-4 4-4zm0 6l4 4-4 4-4-4 4-4zm0 6l4 4-4 4-4-4 4-4z"/>
      </svg>
      <div>MMU-Monitoring Dashboard</div>
    </div>

    <div class="head-center"><!-- intentionally empty for clean layout --></div>

    <div class="head-actions">
      <span id="chipUser" class="badge">‚Äî</span>
      <button class="btn red" onclick="doLogout()">Logout</button>
    </div>
  </div>
</div>

<!-- =================== TABS ROW (separate section below header) =================== -->
<div id="tabsShell" class="tabs-shell hidden">
  <div class="wrap tabs-bar">
    <div class="tabs" id="tabs"></div>
    <!-- Alerts at the far right (NOT in header) -->
    <div id="alertsSlot">
      <button id="alertBtn" class="btn">Alerts <span id="alertCount" class="badge hidden">0</span></button>
      <div id="alertMenu" class="card hidden"></div>
    </div>
  </div>
</div>

<!-- =================== MAIN =================== -->
<div id="appMain" class="wrap grid hidden">
  <!-- ===== Data management ===== -->
  <section class="card" data-tab="Data management">
    <h3>Data Management</h3>

    <div class="grid">
      <div class="card">
        <h4>Upload / Import (Excel or CSV)</h4>
        <div class="row">
          <input type="file" id="fileInput" accept=".xlsx,.xls,.csv"/>
          <input id="batchName" placeholder="Batch name e.g., Daily_2025-10-07"/>
          <select id="batchType">
            <option>ad-hoc</option><option>daily</option><option>weekly</option><option selected>monthly</option>
          </select>
          <select id="importMode">
            <option value="append" selected>Append</option>
            <option value="replace">Replace all</option>
          </select>
          <button type="button" class="btn" onclick="window.handleFile()">Import</button>
        </div>
        <div class="badge" style="margin-top:6px">
          Tip: header row can use hyphens or underscores; the importer maps to the template automatically.
          If network blocks external scripts, Excel is parsed via the self-hosted file or use CSV.
        </div>
      </div>

      <div class="card">
        <h4>Manual Entry</h4>
        <form id="manualForm" class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));"></form>
        <div class="row">
          <button class="btn" onclick="saveManual()">Save Row</button>
          <button class="btn ghost" onclick="document.getElementById('manualForm').reset()">Clear</button>
        </div>
      </div>

      <div class="card">
        <h4>Template</h4>
        <div id="templateEditor" class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr));"></div>
        <div class="row">
          <button class="btn" onclick="downloadTemplate('xlsx')">Download Template (XLSX)</button>
          <button class="btn" onclick="downloadTemplate('csv')">Download Template (CSV)</button>
          <button class="btn red" onclick="resetTemplate()">Reset</button>
        </div>
      </div>

      <div class="card">
        <h4>Backup & Restore</h4>
        <div class="row">
          <button class="btn" onclick="downloadBackup()">Backup JSON</button>
          <label class="row">Restore:
            <input type="file" accept=".json" onchange="restoreBackup(event)"/>
          </label>
        </div>
        <div class="badge" style="margin-top:6px">
          Backup includes rows, template, complaints, rules, audit, settings, and profile. Restore overwrites in-browser data.
        </div>
      </div>
    </div>
  </section>

  <!-- ===== Dashboard ===== -->
  <section class="card" data-tab="Dashboard">
    <h3>Analytics</h3>
    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(240px,1fr));">
      <div class="card"><div class="badge">Total (in scope)</div><div class="kpi" id="kpiTotal">0</div></div>
      <div class="card"><div class="badge">Delivered</div><div class="kpi" id="kpiDelivered">0</div></div>
      <div class="card"><div class="badge">Pending (&gt; SLA)</div><div class="kpi" id="kpiAged">0</div></div>
      <div class="card"><div class="badge">Exceptions</div><div class="kpi" id="kpiException">0</div></div>
    </div>
    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr));">
      <div class="card"><canvas id="chartStatus"></canvas></div>
      <div class="card"><canvas id="chartByRegion"></canvas></div>
      <div class="card"><canvas id="chartTrend"></canvas></div>
    </div>
  </section>

  <!-- ===== Bulk View & Update (details link column) ===== -->
  <section class="card" data-tab="Bulk View & Update">
    <h3>Bulk View & Update</h3>

    <!-- Bulk controls at the TOP -->
    <div class="row" style="margin-bottom:6px">
      <label class="row">Bulk Status:
        <select id="bulkStatus">
          <option value="">‚Äî choose ‚Äî</option>
          <option>DELIVERED</option><option>IN-TRANSIT</option><option>PENDING</option><option>EXCEPTION</option>
        </select>
      </label>
      <label class="row">Delivery Date: <input type="date" id="bulkDate"></label>
      <button class="btn" onclick="applyBulk()">Apply to Selected</button>
      <button class="btn gray" onclick="exportTable('xlsx')">Export</button>
      <button class="btn red right hidden" id="btnDelete" onclick="deleteSelected()">Delete Selected</button>
    </div>

    <!-- Table with full borders + inline filters generated by script -->
    <div class="table-wrap"><table id="dataTable"></table></div>
  </section>

  <!-- ===== Reports ===== -->
  <section class="card" data-tab="Reports">
    <h3>Reports</h3>
    <div class="row">
      <select id="reportType" class="grow">
        <option value="summary">Summary</option>
        <option value="trend">Trend (daily/weekly/monthly)</option>
        <option value="exceptions">Exceptions</option>
        <option value="performance">Performance (SLA, avg time)</option>
        <option value="compliance">Compliance (APT 2.0, mandatory)</option>
        <option value="custom">Custom / User-defined</option>
      </select>
      <button class="btn" onclick="buildReport()">Build</button>
      <button class="btn" onclick="reportExport('pdf')">PDF</button>
      <button class="btn" onclick="reportExport('xlsx')">Excel</button>
      <button class="btn" onclick="reportExport('csv')">CSV</button>
    </div>
    <div class="table-wrap" style="margin-top:8px"><table id="reportTable"></table></div>
  </section>

  <!-- ===== Complaints (dropdown Issue type + custom + date + bulk entry) ===== -->
  <section class="card" data-tab="Complaints">
    <h3>Complaints & Issues</h3>

    <!-- Single add/update row -->
    <div class="row">
      <input id="cmpArticle" placeholder="article-number"/>
      <label class="row">Issue type:
        <select id="cmpType" onchange="toggleCustomIssue()">
          <option value="">‚Äî choose ‚Äî</option>
          <option>COD</option>
          <option>COD Payment Issue</option>
          <option>Damage</option>
          <option>Delivery Details updation pending</option>
          <option>In-Transit</option>
          <option>Non-Delivery</option>
          <option>POD</option>
          <option>Pickup pending</option>
          <option>Picked-booking pending</option>
          <option>RTS</option>
          <option>Other/Custom</option>
        </select>
      </label>
      <input id="cmpTypeCustom" class="hidden" placeholder="Enter custom issue type"/>
      <input id="cmpDate" type="date" title="Date of event/update"/>
      <input id="cmpDesc" class="grow" placeholder="Latest update / note (timeline event)"/>
      <select id="cmpStatus">
        <option value="Open">Open</option>
        <option value="In-Progress">In-Progress</option>
        <option value="Escalated">Escalated</option>
        <option value="Resolved">Resolved</option>
        <option value="Closed">Closed</option>
        <option value="Re-opened">Re-opened</option>
      </select>
      <button class="btn" onclick="addComplaint()">Add / Update</button>
    </div>

    <!-- Bulk entry for multiple articles with the same issue -->
    <div class="card">
      <h4>Bulk Articles ‚Äì Same Issue</h4>
      <div class="row">
        <textarea id="cmpBulkArticles" class="grow" rows="3" placeholder="Paste article numbers here (comma or new line separated)"></textarea>
      </div>
      <div class="row">
        <label class="row">Issue type:
          <select id="cmpBulkType" onchange="toggleCustomIssueBulk()">
            <option value="">‚Äî choose ‚Äî</option>
            <option>COD</option>
            <option>COD Payment Issue</option>
            <option>Damage</option>
            <option>Delivery Details updation pending</option>
            <option>In-Transit</option>
            <option>Non-Delivery</option>
            <option>POD</option>
            <option>Pickup pending</option>
            <option>Picked-booking pending</option>
            <option>RTS</option>
            <option>Other/Custom</option>
          </select>
        </label>
        <input id="cmpBulkTypeCustom" class="hidden" placeholder="Enter custom issue type"/>
        <input id="cmpBulkDate" type="date" title="Date of event/update"/>
        <input id="cmpBulkDesc" class="grow" placeholder="Latest update / note"/>
        <label class="row">Bulk status:
          <select id="cmpBulkStatus">
            <option value="">‚Äî choose ‚Äî</option>
            <option>Open</option><option>In-Progress</option><option>Escalated</option>
            <option>Resolved</option><option>Closed</option><option>Re-opened</option>
            <option>Other/Custom</option>
          </select>
        </label>
        <input id="cmpBulkStatusCustom" class="hidden" placeholder="Enter custom status"/>
        <button class="btn" onclick="addComplaintBulk()">Apply to Articles</button>
        <button class="btn gray" onclick="clearComplaintBulk()">Clear / Reset</button>
      </div>
    </div>

    <!-- Bulk status change for selected complaint rows -->
    <div class="row" style="margin-top:6px">
      <label class="row">Bulk status (selected rows):
        <select id="cmpRowBulkStatus" onchange="toggleRowBulkCustom()">
          <option value="">‚Äî choose ‚Äî</option>
          <option>Open</option><option>In-Progress</option><option>Escalated</option>
          <option>Resolved</option><option>Closed</option><option>Re-opened</option>
          <option>Other/Custom</option>
        </select>
      </label>
      <input id="cmpRowBulkStatusCustom" class="hidden" placeholder="Enter custom status"/>
      <button class="btn" onclick="applyComplaintBulk()">Apply to selected</button>
      <button class="btn gray" onclick="exportComplaints()">Export</button>
    </div>

    <!-- One row per unique article; timeline rendered in same row -->
    <div class="table-wrap" style="margin-top:8px">
      <table id="cmpTable"></table>
    </div>
  </section>

  <!-- ===== SLA Rules ===== -->
  <section class="card" data-tab="SLA Rules">
    <h3>SLA & Compliance Rules</h3>
    <div class="row">
      <select id="ruleScope"><option>GLOBAL</option><option>REGION</option><option>DIVISION</option><option>CUSTOMER</option><option>ARTICLE-TYPE</option></select>
      <input id="ruleKey" placeholder="Scope value (e.g., South, Belagavi, customer-id‚Ä¶)"/>
      <input type="number" id="ruleHours" placeholder="SLA (hours)" min="1" style="width:140px"/>
      <button class="btn" onclick="addRule()">Add/Update</button>
      <button class="btn red" onclick="resetRules()">Reset</button>
    </div>
    <div class="table-wrap" style="margin-top:8px"><table id="ruleTable"></table></div>
  </section>

  <!-- ===== Audit (Superadmin only ‚Äî RBAC) ===== -->
  <section class="card" data-tab="Audit">
    <h3>Audit Log</h3>
    <div class="table-wrap"><table id="auditTable"></table></div>
    <div class="row" style="margin-top:6px">
      <button class="btn gray" onclick="downloadAudit()">Export Audit</button>
      <button class="btn red" onclick="clearAudit()">Clear Audit</button>
    </div>
  </section>

  <!-- ===== Settings ===== -->
  <section class="card" data-tab="Settings">
    <h3>Settings</h3>
    <div class="row">
      <label>Default Report Period:
        <select id="defaultPeriod" onchange="persistSettings()">
          <option value="daily">Daily</option><option value="weekly">Weekly</option>
          <option value="monthly" selected>Monthly</option><option value="quarterly">Quarterly</option><option value="annual">Annual</option>
        </select>
      </label>
      <label>Manual Delete Allowed:
        <select id="allowDelete" onchange="persistSettings()">
          <option value="role">By Role</option><option value="never">Never</option><option value="always">Always</option>
        </select>
      </label>
      <label>Default Scope ‚Äì Region:
        <select id="scopeRegion" onchange="persistProfile();refreshAll()"><option value="">All</option></select>
      </label>
      <label>Division:
        <select id="scopeDivision" onchange="persistProfile();refreshAll()"><option value="">All</option></select>
      </label>
    </div>
  </section>
</div>
<script>
/* =================== Utilities & Constants =================== */
const $ = (id)=>document.getElementById(id);

function _normKey(s){
  return String(s||"")
    .trim()
    .toLowerCase()
    .replace(/[._/]+/g,"-")
    .replace(/\s+/g,"-")
    .replace(/[^a-z0-9-]/g,"")
    .replace(/-+/g,"-");
}

const DEFAULT_COLUMNS = [
 "customer-id","customer-name","customer-type-id","customer-type","contract-id",
 "payment-mode-code","payment_mode_description","book-channel-id","book-channel-name",
 "book-type-id","book-type-name","user-id","user-name","article-number","article-type",
 "booking-date-time","booking-office-pin","booking-office-id","booking-office-name",
 "destination-country","destination-pin","Region","Division","destination-office-name",
 "DELIVERY STATUS","DELIVERY DATE","APT 2.O updation","sender-name","sender-address",
 "receiver-name","receiver-address","event-code","event-description","tariff","weight",
 "vp-cod-type","vp-cod-value","remarks"
];
const REQUIRED = ["article-number","booking-date-time","booking-office-name","Region","Division","DELIVERY STATUS"];

const ROLE = { Viewer:0, Operator:1, Supervisor:2, Admin:3, Superadmin:4 };
const LS = {
  ROWS:"as_rows_v3",
  TEMPLATE:"as_template_v3",
  COMPLAINTS:"as_complaints_v4",
  SETTINGS:"as_settings_v3",
  RULES:"as_rules_v2",
  AUDIT:"as_audit_v2",
  PROFILE:"as_profile_v2",
  USERS:"as_users_v2",
  SESSION:"as_session_v2"
};

/* State */
let rows=[], template=[], complaints=[], rules=[], audit=[];
let profile={username:"", role:"Operator", region:"", division:""};
let settings={ defaultPeriod:"monthly", allowDelete:"role" };
let charts={}, alertTimer=null;

/* =================== Theme (fixed light ‚Äî no toggle) =================== */
function loadTheme(){ /* kept for future; currently always light */ }

/* =================== Auth =================== */
function enc(s){return new TextEncoder().encode(s)}
async function sha256(text){ const buf=await crypto.subtle.digest("SHA-256",enc(text)); return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("") }
function seedUsersIfEmpty(){
  const cur = JSON.parse(localStorage.getItem(LS.USERS)||"[]");
  if(cur.length) return;
  const seeds=[
    {u:"superadmin",r:"Superadmin",p:"Super@123"},
    {u:"admin",r:"Admin",p:"Admin@123"},
    {u:"supervisor",r:"Supervisor",p:"Supv@123"},
    {u:"operator",r:"Operator",p:"Oper@123"},
    {u:"viewer",r:"Viewer",p:"View@123"}
  ];
  Promise.all(seeds.map(async s=>({user:s.u, role:s.r, hash:await sha256(s.p)})))
    .then(list=>localStorage.setItem(LS.USERS, JSON.stringify(list)));
}

function showApp(show){
  $("loginScreen").classList.toggle("hidden", show);
  $("appHeader").classList.toggle("hidden", !show);
  $("tabsShell").classList.toggle("hidden", !show);   // tabs row sits BELOW header
  $("appMain").classList.toggle("hidden", !show);
}
function togglePw(){ const i=$("lgPass"); i.type = (i.type==="password"?"text":"password"); }
function clearLogin(){ $("lgUser").value=""; $("lgPass").value=""; }
function showLgErr(msg){ const el=$("lgErr"); el.textContent=msg; el.classList.remove("hidden"); setTimeout(()=>el.classList.add("hidden"),4000); }

async function doLogin(){
  const u=$("lgUser").value.trim(), p=$("lgPass").value;
  const users=JSON.parse(localStorage.getItem(LS.USERS)||"[]");
  const found=users.find(x=>x.user===u);
  if(!found) return showLgErr("Invalid username or password.");
  const h=await sha256(p);
  if(h!==found.hash) return showLgErr("Invalid username or password.");
  profile.username=u; profile.role=found.role;
  localStorage.setItem(LS.PROFILE, JSON.stringify(profile));
  localStorage.setItem(LS.SESSION, JSON.stringify({user:u, ts:Date.now()}));
  $("chipUser").textContent=u;
  showApp(true); buildTabs(); applyRole(); refreshAll();
  logAudit("auth.login",{user:u});
}
function doLogout(){ localStorage.removeItem(LS.SESSION); logAudit("auth.logout",{user:profile.username}); location.reload(); }

/* =================== Load/Save =================== */
function loadAll(){
  rows=JSON.parse(localStorage.getItem(LS.ROWS)||"[]");
  template=JSON.parse(localStorage.getItem(LS.TEMPLATE)||"null") || DEFAULT_COLUMNS.map(k=>({key:k,label:k,enabled:true}));
  complaints=JSON.parse(localStorage.getItem(LS.COMPLAINTS)||"[]");
  if(complaints.length && !complaints[0].timeline){
    complaints = complaints.map(c=>({
      article:c.article, type:c.type, status:c.status||"Open",
      timeline:[{ts:c.ts||new Date().toISOString(), note:c.desc||""}]
    }));
    localStorage.setItem(LS.COMPLAINTS, JSON.stringify(complaints));
  }
  rules=JSON.parse(localStorage.getItem(LS.RULES)||"[]");
  audit=JSON.parse(localStorage.getItem(LS.AUDIT)||"[]");
  Object.assign(settings, JSON.parse(localStorage.getItem(LS.SETTINGS)||"{}"));
}
function persist(){ localStorage.setItem(LS.ROWS, JSON.stringify(rows)); }
function saveTemplate(){ localStorage.setItem(LS.TEMPLATE, JSON.stringify(template)); }
function saveComplaints(){ localStorage.setItem(LS.COMPLAINTS, JSON.stringify(complaints)); }
function saveRules(){ localStorage.setItem(LS.RULES, JSON.stringify(rules)); }
function saveAudit(){ localStorage.setItem(LS.AUDIT, JSON.stringify(audit)); }
function persistSettings(){
  settings.defaultPeriod = $("defaultPeriod").value;
  settings.allowDelete = $("allowDelete").value;
  localStorage.setItem(LS.SETTINGS, JSON.stringify(settings));
  logAudit("settings.update", settings);
  refreshAll();
}
function persistProfile(){
  profile.region = $("scopeRegion").value;
  profile.division = $("scopeDivision").value;
  localStorage.setItem(LS.PROFILE, JSON.stringify(profile));
}

/* =================== RBAC =================== */
function roleLevel(){ return ROLE[profile.role] ?? ROLE.Operator; }
function can(action){
  const lvl = roleLevel();
  const matrix = {
    import:1, manualAdd:1, bulkUpdate:1,
    delete: (settings.allowDelete==="always")?0:(settings.allowDelete==="never"?99:3),
    templateEdit:3, rulesEdit:3,
    auditClear:4, seeAudit:4, seeSettings:3
  };
  return lvl >= (matrix[action] ?? 99);
}
function applyRole(){
  $("chipUser").textContent = profile.username || "‚Äî";
  toggleTab("Audit", can("seeAudit"));
  toggleTab("Settings", can("seeSettings"));
  const delBtn=$("btnDelete"); if(delBtn) delBtn.classList.toggle("hidden", !can("delete"));
  buildTemplateEditor();
}
function toggleTab(name, show){
  const allTabs=[...document.querySelectorAll("#tabs .tab")];
  const btn=allTabs.find(b=>b.textContent===name);
  const sec=document.querySelector(`[data-tab="${name}"]`);
  if(btn) btn.classList.toggle("hidden", !show);
  if(sec) sec.classList.toggle("hidden", !show);
}

/* =================== Tabs =================== */
const TAB_ORDER = ["Dashboard","Data management","Bulk View & Update","Reports","Complaints","SLA Rules","Audit","Settings"];
function buildTabs(){
  const host=$("tabs"); host.innerHTML="";
  TAB_ORDER.forEach((name,i)=>{
    const b=document.createElement("button");
    b.className="tab"+(i===0?" active":"");
    b.textContent=name;
    b.onclick=()=>activateTab(name,b);
    host.appendChild(b);
  });
  activateTab("Dashboard", host.children[0]);
}
function activateTab(name, btn){
  document.querySelectorAll("#tabs .tab").forEach(t=>t.classList.remove("active"));
  if(btn) btn.classList.add("active");
  document.querySelectorAll("[data-tab]").forEach(sec=>{
    sec.style.display = (sec.getAttribute("data-tab")===name) ? "block" : "none";
  });
}

/* =================== INLINE FILTERS ‚Äî FIXED =================== */
/* Build a filter row with inputs carrying data-col=<absolute column index>.
   Filtering reads each input's data-col so action/checkbox columns don't shift indices. */
function addInlineFilters(tableEl){
  const thead = tableEl.querySelector("thead");
  if(!thead) return;
  // Remove existing filter row if rebuilding
  const prev = thead.querySelector("tr.filter-row"); if(prev) prev.remove();

  const headerCells = [...thead.querySelectorAll("tr:first-child th")];
  const filterTr = document.createElement("tr"); filterTr.className="filter-row";

  headerCells.forEach((th, idx)=>{
    const fth = document.createElement("th");
    const headerText = th.textContent.trim().toLowerCase();
    const isCheckbox = th.querySelector('input[type="checkbox"]') || headerText==="#" || headerText==="details";
    if(isCheckbox){
      // Keep a placeholder (no input) to preserve correct column count
      fth.innerHTML = ""; // no input
    }else{
      fth.innerHTML = `<input class="inline-filter" data-col="${idx}" placeholder="Filter‚Ä¶">`;
    }
    filterTr.appendChild(fth);
  });
  thead.appendChild(filterTr);

  // Hook inputs
  thead.querySelectorAll(".inline-filter").forEach(inp=>{
    inp.addEventListener("input", ()=>applyTableFilters(tableEl));
  });
}
function applyTableFilters(tableEl){
  const thead = tableEl.querySelector("thead");
  const inputs = [...thead.querySelectorAll(".inline-filter")];
  const tbody = tableEl.querySelector("tbody");
  if(!tbody) return;
  const rowsTR = [...tbody.querySelectorAll("tr")];

  rowsTR.forEach(tr=>{
    const tds=[...tr.children];
    let ok=true;
    for(const inp of inputs){
      const f = inp.value.trim().toLowerCase();
      if(!f) continue;
      const colIdx = +inp.dataset.col;
      const td = tds[colIdx];
      const txt = (td?.textContent || "").toLowerCase();
      if(!txt.includes(f)){ ok=false; break; }
    }
    tr.style.display = ok ? "" : "none";
  });
}

/* =================== Alerts (in tabs row, right) =================== */
function computeAlerts(){
  const missing = rows.filter(r => REQUIRED.some(k=>!String(r[k]||"").trim()));
  const dupKeys = new Set(), seen=new Set();
  rows.forEach(r=>{
    const k=String(r["article-number"]||"");
    if(!k) return;
    if(seen.has(k)) dupKeys.add(k); else seen.add(k);
  });
  const aged = rows.filter(r=>{
    const st=(r["DELIVERY STATUS"]||"").toUpperCase();
    if(st==="DELIVERED"||st==="EXCEPTION") return false;
    const d = dayjs(r["booking-date-time"]);
    if(!d.isValid()) return false;
    return dayjs().diff(d,"hour") > slaHoursFor(r);
  });
  return [
    {label:`Missing required fields: ${missing.length}`, action:()=>{ activateTab("Reports", document.querySelector('#tabs .tab:nth-child(4)')); $("reportType").value="exceptions"; buildReport(); }},
    {label:`Duplicate article-number: ${dupKeys.size}`, action:()=>{ activateTab("Reports", document.querySelector('#tabs .tab:nth-child(4)')); $("reportType").value="exceptions"; buildReport(); }},
    {label:`Aged pending (> SLA): ${aged.length}`, action:()=>{ activateTab("Bulk View & Update", document.querySelector('#tabs .tab:nth-child(3)')); }}
  ];
}
function renderAlertsHeader(){
  const menu=$("alertMenu");
  const items=computeAlerts();
  menu.innerHTML = items.map(i=>`<div class="row" style="justify-content:space-between; padding:6px 4px;">
    <div>${i.label}</div><button class="btn gray" style="padding:4px 8px">Go</button>
  </div>`).join("");
  const total=items.reduce((a,i)=> a + (parseInt(i.label.match(/(\d+)/)?.[1]||0)), 0);
  const c=$("alertCount");
  if(total>0){ c.textContent=total; c.classList.remove("hidden"); } else { c.classList.add("hidden"); }
  [...menu.querySelectorAll(".row")].forEach((el,idx)=> el.querySelector("button").onclick=()=>{ items[idx].action(); menu.classList.add("hidden"); });
}
$("alertBtn").onclick = ()=>{ $("alertMenu").classList.toggle("hidden"); };

/* =================== Data Management: Template & Manual Entry =================== */
function buildTemplateEditor(){
  const host=$("templateEditor"); if(!host) return; host.innerHTML="";
  template.forEach((col,idx)=>{
    const card=document.createElement("div"); card.className="card";
    const disabled=!can("templateEdit");
    card.innerHTML=`<div class="row" style="justify-content:space-between">
      <strong>${col.key}</strong>
      <label class="row">Enabled <input type="checkbox" ${col.enabled?"checked":""} data-idx="${idx}" ${disabled?"disabled":""}></label>
    </div>
    <div class="row"><label class="grow">Label <input data-lbl="${idx}" value="${col.label}" ${disabled?"disabled":""}></label></div>
    <div class="row">
      <button class="btn gray" data-up="${idx}" ${disabled?"disabled":""}>‚Üë</button>
      <button class="btn gray" data-down="${idx}" ${disabled?"disabled":""}>‚Üì</button>
      <button class="btn red" data-del="${idx}" ${disabled?"disabled":""}>Remove</button>
    </div>`;
    host.appendChild(card);
  });
  if(!can("templateEdit")) return;
  host.querySelectorAll("input[type=checkbox]").forEach(ch=> ch.onchange=(e)=>{ const i=+e.target.dataset.idx; template[i].enabled=e.target.checked; saveTemplate(); refreshAll(); logAudit("template.toggle",{key:template[i].key,enabled:e.target.checked});});
  host.querySelectorAll("[data-lbl]").forEach(inp=> inp.oninput=(e)=>{ const i=+e.target.dataset.lbl; template[i].label=e.target.value; saveTemplate(); logAudit("template.label",{key:template[i].key,label:e.target.value});});
  host.querySelectorAll("[data-up]").forEach(b=> b.onclick=()=>{ const i=+b.dataset.up; if(i>0){[template[i-1],template[i]]=[template[i],template[i-1]]; saveTemplate(); buildTemplateEditor(); refreshAll(); logAudit("template.reorder",{from:i,to:i-1});}});
  host.querySelectorAll("[data-down]").forEach(b=> b.onclick=()=>{ const i=+b.dataset.down; if(i<template.length-1){[template[i+1],template[i]]=[template[i],template[i+1]]; saveTemplate(); buildTemplateEditor(); refreshAll(); logAudit("template.reorder",{from:i,to:i+1});}});
  host.querySelectorAll("[data-del]").forEach(b=> b.onclick=()=>{ const i=+b.dataset.del; if(!confirm(`Remove ${template[i].key}?`)) return; const key=template[i].key; template.splice(i,1); saveTemplate(); buildTemplateEditor(); refreshAll(); logAudit("template.remove",{key});});
}

function buildManualForm(){
  const host=$("manualForm"); if(!host) return; host.innerHTML="";
  template.filter(c=>c.enabled).forEach(col=>{
    const el=document.createElement("label"); el.className="grow";
    const ph=col.label||col.key; const type=/date/i.test(col.key)?"datetime-local":"text";
    el.innerHTML=`<div style="font-size:12px;color:var(--muted);margin-bottom:4px">${ph}${REQUIRED.includes(col.key)?" *":""}</div>
      <input name="${col.key}" placeholder="${ph}" type="${type}"/>`;
    host.appendChild(el);
  });
}
function saveManual(e){
  if(e) e.preventDefault();
  if(!can("manualAdd")) return alert("Not allowed by role.");
  const form=$("manualForm");
  const rec={};
  template.filter(c=>c.enabled).forEach(c=>{
    let v=(form.querySelector(`[name="${c.key}"]`)?.value ?? "").trim();
    if(c.key==="DELIVERY STATUS") v=v.toUpperCase();
    rec[c.key]=v;
  });
  const miss=REQUIRED.filter(k=>!String(rec[k]||"").trim());
  if(miss.length) return alert("Missing: "+miss.join(", "));
  const k=String(rec["article-number"]||"");
  if(k && rows.some(r=>String(r["article-number"]||"")===k)){
    if(!confirm("Duplicate article-number. Add anyway?")) return;
  }
  rec._batchId="Manual_"+new Date().toISOString();
  rec._batchType="manual";
  rows.push(rec); persist(); form.reset(); refreshAll();
  logAudit("manual.add",{article:k}); alert("Saved.");
}

/* =================== Browse / Bulk View =================== */
function buildOptions(){
  const regs=[...new Set(rows.map(r=>r.Region).filter(Boolean))].sort();
  const divs=[...new Set(rows.map(r=>r.Division).filter(Boolean))].sort();
  $("scopeRegion").innerHTML='<option value="">All</option>'+regs.map(x=>`<option ${x===profile.region?"selected":""}>${x}</option>`).join("");
  $("scopeDivision").innerHTML='<option value="">All</option>'+divs.map(x=>`<option ${x===profile.division?"selected":""}>${x}</option>`).join("");
}
function scopeFilter(r){
  if(profile.region && r.Region!==profile.region) return false;
  if(profile.division && r.Division!==profile.division) return false;
  return true;
}

function renderTable(){
  const cols = template.filter(c=>c.enabled).map(c=>c.key);
  const tbl = $("dataTable");
  tbl.innerHTML = "";

  // Header
  const thead = document.createElement("thead");
  const ths = ["<th><input type='checkbox' onclick='toggleAll(this)'></th>",
               "<th>Details</th>",
               ...cols.map(k=>`<th>${k}</th>`)].join("");
  thead.innerHTML = `<tr>${ths}</tr>`;
  tbl.appendChild(thead);

  // Body
  const tbody = document.createElement("tbody");
  rows.filter(scopeFilter).forEach((r, idx)=>{
    const status = String(r["DELIVERY STATUS"]||"").toUpperCase();
    const cls = status==="DELIVERED"?"delivered":status==="IN-TRANSIT"?"intransit":status==="EXCEPTION"?"exception":"pending";
    let html = `<td><input type="checkbox" data-id="${idx}"></td>`;
    html += `<td><a href="javascript:void(0)" onclick='showDetails(${idx})'>‚ÑπÔ∏è</a></td>`;
    cols.forEach(c=>{
      let v = r[c] ?? "";
      if(c==="DELIVERY STATUS") v = `<span class="pill ${cls}">${status||"‚Äî"}</span>`;
      html += `<td>${v}</td>`;
    });
    const tr = document.createElement("tr");
    tr.innerHTML = html;
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);

  // Add inline filter row & hook (fixed)
  addInlineFilters(tbl);
}

function toggleAll(master){
  document.querySelectorAll('#dataTable tbody input[type="checkbox"]').forEach(ch=> ch.checked=master.checked);
}
function showDetails(idx){
  const r = rows[idx];
  const keys = template.filter(c=>c.enabled).map(c=>c.key);
  const msg = keys.map(k=>`${k}: ${r[k]??""}`).join("\n");
  alert(`Record (Batch: ${r._batchId||"‚Äî"}):\n\n${msg}`);
}
function applyBulk(){
  if(!can("bulkUpdate")) return alert("Not allowed by role.");
  const status=$("bulkStatus").value;
  const d=$("bulkDate").value;
  const ids=[...document.querySelectorAll('#dataTable tbody input[type="checkbox"]:checked')].map(ch=>+ch.dataset.id);
  if(!ids.length) return alert("Select rows first.");
  ids.forEach(i=>{ if(status) rows[i]["DELIVERY STATUS"]=status; if(d) rows[i]["DELIVERY DATE"]=d; });
  persist(); refreshAll();
  logAudit("bulk.update",{count:ids.length,status,date:d});
  alert("Bulk update applied.");
}
function deleteSelected(){
  if(!can("delete")) return alert("Not allowed by role.");
  const ids=new Set([...document.querySelectorAll('#dataTable tbody input[type="checkbox"]:checked')].map(ch=>+ch.dataset.id));
  if(!ids.size) return alert("Select rows first.");
  if(!confirm(`Delete ${ids.size} selected row(s)?`)) return;
  rows=rows.filter((_,idx)=>!ids.has(idx));
  persist(); refreshAll(); logAudit("rows.delete",{count:ids.size});
}

/* Export (Browse) */
function exportTable(fmt){
  const cols = template.filter(c=>c.enabled).map(c=>c.key);
  const data = rows.filter(scopeFilter).map(r=>{ const o={}; cols.forEach(k=>o[k]=r[k]??""); o._batchId=r._batchId||""; return o; });
  if(fmt==="csv"){
    const ws=XLSX.utils.json_to_sheet(data);
    const csv=XLSX.utils.sheet_to_csv(ws);
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="browse_export.csv"; a.click();
  }else{
    const ws=XLSX.utils.json_to_sheet(data);
    const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Browse"); XLSX.writeFile(wb,"browse_export.xlsx");
  }
}

/* =================== Reports (with inline filters) =================== */
function countBy(key, arr){ const map={}; (arr||rows).forEach(r=>{ const k=r[key]||"‚Äî"; map[k]=(map[k]||0)+1; }); return Object.entries(map).sort((a,b)=>a[0].localeCompare(b[0])); }
function slaHoursFor(r){ const look=[["CUSTOMER",r["customer-id"]],["ARTICLE-TYPE",r["article-type"]],["DIVISION",r["Division"]],["REGION",r["Region"]],["GLOBAL","GLOBAL"]]; for(const [scope,key] of look){ const hit=rules.find(x=>x.scope===scope && String(x.key||"")===String(key||"")); if(hit) return +hit.hours; } return 72; }

function buildReport(){
  const host=$("reportTable"); host.innerHTML="";
  const makeRow=arr=>"<tr>"+arr.map(x=>`<td>${x}</td>`).join("")+"</tr>";
  const inScope=rows.filter(scopeFilter);
  const type=document.getElementById("reportType").value;

  if(type==="summary"){
    const total=inScope.length;
    const byStatus=["DELIVERED","IN-TRANSIT","PENDING","EXCEPTION"].map(s=>[s,inScope.filter(r=>String(r["DELIVERY STATUS"]||"").toUpperCase()===s).length]);
    const byRegion=countBy("Region",inScope);
    const byDivision=countBy("Division",inScope);
    host.innerHTML=`<thead><tr><th>Metric</th><th>Value</th></tr></thead>
      <tbody>
        ${makeRow(["Total",total])}
        ${byStatus.map(x=>makeRow(x)).join("")}
        <tr><th colspan="2">By Region</th></tr>
        ${byRegion.map(x=>makeRow(x)).join("")}
        <tr><th colspan="2">By Division</th></tr>
        ${byDivision.map(x=>makeRow(x)).join("")}
      </tbody>`;
  }else if(type==="trend"){
    const period=settings.defaultPeriod;
    const buckets={};
    inScope.forEach(r=>{
      const d=dayjs(r["booking-date-time"]); if(!d.isValid()) return;
      let key=d.format("YYYY-MM-DD");
      if(period==="weekly") key=d.startOf("week").format("YYYY-[W]WW");
      if(period==="monthly") key=d.format("YYYY-MM");
      if(period==="quarterly") key=d.format("YYYY-[Q]Q");
      if(period==="annual") key=d.format("YYYY");
      buckets[key]=(buckets[key]||0)+1;
    });
    const keys=Object.keys(buckets).sort();
    host.innerHTML=`<thead><tr><th>Period</th><th>Articles</th></tr></thead>
      <tbody>${keys.map(k=>makeRow([k,buckets[k]])).join("")}</tbody>`;
  }else if(type==="exceptions"){
    const missing=inScope.filter(r=> REQUIRED.some(k=>!String(r[k]||"").trim()));
    const seen=new Set(); const dups=[];
    inScope.forEach(r=>{ const k=String(r["article-number"]||""); if(!k) return; if(seen.has(k)) dups.push(r); else seen.add(k); });
    const aged=inScope.filter(r=>{
      const st=String(r["DELIVERY STATUS"]||"").toUpperCase(); if(st==="DELIVERED"||st==="EXCEPTION") return false;
      const d=dayjs(r["booking-date-time"]); if(!d.isValid()) return false;
      return dayjs().diff(d,"hour")>slaHoursFor(r);
    });
    host.innerHTML=`<thead><tr><th>Exception</th><th>Count</th></tr></thead>
      <tbody>${makeRow(["Missing requireds",missing.length])}${makeRow(["Duplicates (article-number)",dups.length])}${makeRow(["Aged pending (> SLA)",aged.length])}</tbody>`;
  }else if(type==="performance"){
    const delivered=inScope.filter(r=>String(r["DELIVERY STATUS"]||"").toUpperCase()==="DELIVERED");
    const deltas=delivered.map(r=>{
      const b=dayjs(r["booking-date-time"]); const d=dayjs(r["DELIVERY DATE"]);
      if(!b.isValid()||!d.isValid()) return null; return d.diff(b,"hour");
    }).filter(x=>x!=null);
    const avg=deltas.length?Math.round(deltas.reduce((a,b)=>a+b,0)/deltas.length):0;
    host.innerHTML=`<thead><tr><th>Metric</th><th>Value</th></tr></thead>
      <tbody>${makeRow(["Delivered count",delivered.length])}${makeRow(["Avg hours to deliver",avg])}</tbody>`;
  }else if(type==="compliance"){
    const aptMissing=inScope.filter(r=> String(r["APT 2.O updation"]||"").trim()==="");
    const mandatoryMissing=inScope.filter(r=> REQUIRED.some(k=>!String(r[k]||"").trim()));
    host.innerHTML=`<thead><tr><th>Check</th><th>Fail Count</th></tr></thead>
      <tbody>${makeRow(["APT 2.0 empty",aptMissing.length])}${makeRow(["Mandatory empty",mandatoryMissing.length])}</tbody>`;
  }else{
    const cols=template.filter(c=>c.enabled).map(c=>c.key);
    const head="<thead><tr>"+cols.map(c=>`<th>${c}</th>`).join("")+"</tr></thead>";
    const body="<tbody>"+inScope.map(r=>"<tr>"+cols.map(c=>`<td>${r[c]??""}</td>`).join("")+"</tr>").join("")+"</tbody>";
    host.innerHTML=head+body;
  }
  addInlineFilters($("reportTable"));
}
function reportExport(fmt){
  const tbl=$("reportTable");
  if(!tbl.rows.length) return alert("Build a report first.");
  const headers=[...tbl.querySelectorAll("thead tr:first-child th")].map(th=>th.textContent);
  const body=[...tbl.querySelectorAll("tbody tr")].filter(tr=>tr.style.display!=="none")
    .map(tr=>[...tr.children].map(td=>td.textContent));
  if(fmt==="pdf"){
    const {jsPDF}=window.jspdf; const doc=new jsPDF({orientation:"landscape"});
    doc.text("Report",14,12); doc.autoTable({head:[headers],body,startY:16,styles:{fontSize:8}}); doc.save("report.pdf");
  } else if(fmt==="xlsx"){
    const json=body.map(row=>Object.fromEntries(row.map((v,i)=>[headers[i],v])));
    const ws=XLSX.utils.json_to_sheet(json); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Report"); XLSX.writeFile(wb,"report.xlsx");
  } else {
    const ws=XLSX.utils.aoa_to_sheet([headers,...body]); const csv=XLSX.utils.sheet_to_csv(ws);
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="report.csv"; a.click();
  }
}

/* =================== Complaints =================== */
function toggleCustomIssue(){
  const sel=$("cmpType"); const cust=$("cmpTypeCustom");
  cust.classList.toggle("hidden", sel.value!=="Other/Custom");
}
function toggleCustomIssueBulk(){
  const sel=$("cmpBulkType"); const cust=$("cmpBulkTypeCustom");
  cust.classList.toggle("hidden", sel.value!=="Other/Custom");
}
function toggleRowBulkCustom(){
  const sel=$("cmpRowBulkStatus"); const cust=$("cmpRowBulkStatusCustom");
  cust.classList.toggle("hidden", sel.value!=="Other/Custom");
}
function pillForStatus(s){
  const map={Open:'#f59e0b','In-Progress':'#60a5fa',Escalated:'#ef4444',Resolved:'#16a34a',Closed:'#6b7280','Re-opened':'#c2410c'};
  const c=map[s]||'#6b7280';
  return `<span class="pill" style="border-color:${c};color:${c}">${s}</span>`;
}
function renderComplaints(){
  const tbl=$("cmpTable");
  tbl.innerHTML=`<thead><tr>
    <th><input type="checkbox" onclick="toggleAllCmp(this)"></th>
    <th>Article</th><th>Issue type</th><th>Status</th><th>Updates/Remarks</th>
  </tr></thead><tbody>`+
  complaints.map((c,i)=>`<tr>
    <td><input type="checkbox" data-id="${i}"></td>
    <td>${c.article}</td>
    <td>${c.type}</td>
    <td>${pillForStatus(c.status||"Open")}</td>
    <td>${(c.timeline||[]).map(ev=>`<div>‚Ä¢ ${(ev.date||ev.ts||"").toString()} ‚Äî ${ev.note||""}</div>`).join("")}</td>
  </tr>`).join("") + `</tbody>`;
  addInlineFilters(tbl);
}
function toggleAllCmp(master){
  document.querySelectorAll('#cmpTable tbody input[type="checkbox"]').forEach(ch=> ch.checked=master.checked);
}
function addComplaint(){
  const article=$("cmpArticle").value.trim();
  let type=$("cmpType").value;
  if(type==="Other/Custom") type=$("cmpTypeCustom").value.trim();
  const note=$("cmpDesc").value.trim();
  const status=$("cmpStatus").value;
  const dateVal=$("cmpDate").value;

  if(!article) return alert("article-number is required.");
  if(!type) return alert("Issue type is required.");

  const idx = complaints.findIndex(c=>c.article===article);
  const event = {date: dateVal || new Date().toLocaleDateString(), ts:new Date().toLocaleString(), note};

  if(idx>=0){
    complaints[idx].type = type;
    complaints[idx].status = status;
    complaints[idx].timeline = complaints[idx].timeline || [];
    complaints[idx].timeline.push(event);
  }else{
    complaints.push({article, type, status, timeline:[event]});
  }
  saveComplaints(); renderComplaints();
  $("cmpArticle").value=""; $("cmpType").value=""; $("cmpTypeCustom").value=""; $("cmpDate").value=""; $("cmpDesc").value="";
  $("cmpTypeCustom").classList.add("hidden");
  logAudit("complaint.upsert",{article,status});
}

/* Bulk apply same issue to multiple pasted articles */
function parseBulkArticles(txt){
  return txt.split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
}
function addComplaintBulk(){
  const list=parseBulkArticles($("cmpBulkArticles").value||"");
  if(!list.length) return alert("Paste article numbers first.");
  let type=$("cmpBulkType").value;
  if(type==="Other/Custom") type=$("cmpBulkTypeCustom").value.trim();
  if(!type) return alert("Choose an Issue type.");
  const dateVal=$("cmpBulkDate").value;
  const note=$("cmpBulkDesc").value.trim();
  let status=$("cmpBulkStatus").value;
  if(status==="Other/Custom") status=$("cmpBulkStatusCustom").value.trim()||"Open";

  const ev = {date: dateVal || new Date().toLocaleDateString(), ts:new Date().toLocaleString(), note};
  list.forEach(article=>{
    const idx = complaints.findIndex(c=>c.article===article);
    if(idx>=0){
      complaints[idx].type=type; complaints[idx].status=status;
      complaints[idx].timeline = complaints[idx].timeline||[]; complaints[idx].timeline.push(ev);
    }else{
      complaints.push({article, type, status, timeline:[ev]});
    }
  });
  saveComplaints(); renderComplaints(); logAudit("complaint.bulkAdd",{count:list.length,type,status});
  alert(`Applied to ${list.length} article(s).`);
}
function clearComplaintBulk(){
  $("cmpBulkArticles").value=""; $("cmpBulkType").value=""; $("cmpBulkTypeCustom").value="";
  $("cmpBulkDate").value=""; $("cmpBulkDesc").value="";
  $("cmpBulkStatus").value=""; $("cmpBulkStatusCustom").value="";
  $("cmpBulkTypeCustom").classList.add("hidden"); $("cmpBulkStatusCustom").classList.add("hidden");
}

/* Bulk change status for selected complaint rows (with Other/Custom) */
function applyComplaintBulk(){
  let s=$("cmpRowBulkStatus").value;
  if(!s) return alert("Choose a status.");
  if(s==="Other/Custom") s=$("cmpRowBulkStatusCustom").value.trim()||"Open";
  const ids=[...document.querySelectorAll('#cmpTable tbody input[type="checkbox"]:checked')].map(ch=>+ch.dataset.id);
  ids.forEach(i=> complaints[i].status=s);
  saveComplaints(); renderComplaints(); logAudit("complaint.bulkStatus",{count:ids.length,status:s});
}

/* Export complaints */
function exportComplaints(){
  const ws=XLSX.utils.json_to_sheet(complaints.map(c=>({
    article:c.article, type:c.type, status:c.status,
    timeline:(c.timeline||[]).map(ev=>`${(ev.date||"")} ${ev.ts?`(${ev.ts})`:""}: ${ev.note}`).join(" | ")
  })));
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Complaints"); XLSX.writeFile(wb,"complaints.xlsx");
}

/* =================== SLA Rules & Audit (with inline filters) =================== */
function buildRuleTable(){
  const tbl=$("ruleTable");
  tbl.innerHTML=`<thead><tr><th>Scope</th><th>Key</th><th>SLA (h)</th><th>#</th></tr></thead>
    <tbody>`+ rules.map((r,i)=>`<tr>
      <td>${r.scope}</td><td>${r.key}</td><td>${r.hours}</td>
      <td><button class="btn red" onclick="delRule(${i})" ${can("rulesEdit")?"":"disabled"}>Delete</button></td>
    </tr>`).join("")+`</tbody>`;
  addInlineFilters(tbl);
}
function addRule(){
  if(!can("rulesEdit")) return alert("Not allowed by role.");
  const scope=$("ruleScope").value;
  const key=$("ruleKey").value.trim()||(scope==="GLOBAL"?"GLOBAL":"");
  const hours=+($("ruleHours").value||"0");
  if(!hours) return alert("Enter SLA hours.");
  const i=rules.findIndex(r=>r.scope===scope && String(r.key)===String(key));
  const rec={scope,key,hours};
  if(i>=0) rules[i]=rec; else rules.push(rec);
  saveRules(); buildRuleTable(); refreshAll();
  logAudit("rules.upsert",{scope,key,hours});
}
function delRule(i){
  if(!can("rulesEdit")) return alert("Not allowed by role.");
  const {scope,key}=rules[i]||{};
  rules.splice(i,1); saveRules(); buildRuleTable(); refreshAll();
  logAudit("rules.delete",{scope,key});
}
function resetRules(){
  if(!can("rulesEdit")) return alert("Not allowed by role.");
  rules=[{scope:"GLOBAL",key:"GLOBAL",hours:72}]; saveRules(); buildRuleTable(); refreshAll();
  logAudit("rules.reset",{});
}

function logAudit(event,detail){
  const row={ts:new Date().toISOString(), user:profile.username, role:profile.role, region:profile.region, division:profile.division, event, detail};
  audit.unshift(row); saveAudit(); renderAudit();
}
function renderAudit(){
  const tbl=$("auditTable");
  tbl.innerHTML=`<thead><tr><th>Timestamp</th><th>User</th><th>Role</th><th>Region</th><th>Division</th><th>Event</th><th>Detail</th></tr></thead>
    <tbody>`+ audit.map(a=>`<tr>
      <td>${a.ts}</td><td>${a.user||"‚Äî"}</td><td>${a.role}</td>
      <td>${a.region||"‚Äî"}</td><td>${a.division||"‚Äî"}</td>
      <td>${a.event}</td><td>${JSON.stringify(a.detail||{})}</td>
    </tr>`).join("") + `</tbody>`;
  addInlineFilters(tbl);
}

/* =================== Import: Self-hosted XLSX + CSV fallback =================== */
async function ensureXLSX(){ return !!window.XLSX; } // local file loaded in <head>

/* Lightweight RFC4180 CSV parser */
function parseCSV(text){
  const rows = [];
  let row = [], field = '';
  let i = 0, inQuotes = false;
  while (i < text.length){
    const c = text[i];
    if (inQuotes){
      if (c === '"'){
        if (text[i+1] === '"'){ field += '"'; i += 2; continue; }
        inQuotes = false; i++; continue;
      } else { field += c; i++; continue; }
    } else {
      if (c === '"'){ inQuotes = true; i++; continue; }
      if (c === ','){ row.push(field); field = ''; i++; continue; }
      if (c === '\r'){ if (text[i+1] === '\n') i++; row.push(field); rows.push(row); row = []; field = ''; i++; continue; }
      if (c === '\n'){ row.push(field); rows.push(row); row = []; field = ''; i++; continue; }
      field += c; i++;
    }
  }
  row.push(field); rows.push(row);
  if (rows.length && rows[rows.length-1].length === 1 && rows[rows.length-1][0] === '') rows.pop();
  return rows;
}

window.handleFile = async function handleFile(){
  try {
    const input = $("fileInput");
    const f = input && input.files && input.files[0];
    if(!f) { alert("Choose a file first."); return; }

    const isCSV = /\.csv$/i.test(f.name) || (f.type && f.type.includes('csv'));
    const xlsxReady = await ensureXLSX();

    if (isCSV || !xlsxReady){
      const reader = new FileReader();
      reader.onerror = () => alert("Could not read the CSV file.");
      reader.onload = (e) => {
        try{
          const text = e.target.result;
          const aoa = parseCSV(text);
          if (!aoa.length) throw new Error("CSV appears empty.");
          let headerRow = -1;
          for(let i=0;i<aoa.length;i++){
            const nonEmpty = aoa[i].filter(v => String(v).trim() !== "");
            if(nonEmpty.length >= 3){ headerRow = i; break; }
          }
          if(headerRow === -1) throw new Error("No plausible header row found in CSV.");
          const headers = aoa[headerRow].map(h => String(h||"").trim());
          const rowsAOA = aoa.slice(headerRow+1).filter(r => r.some(v => String(v).trim() !== ""));
          const arr = rowsAOA.map(r => { const o={}; headers.forEach((h,idx)=> o[h] = r[idx] ?? ""); return o; });
          importRows(arr);
        }catch(err){
          console.error("CSV import error:", err);
          alert(`CSV parse error: ${err.message || err}`);
        }
      };
      reader.readAsText(f);
      return;
    }

    const reader = new FileReader();
    reader.onerror = () => alert("Could not read the Excel file.");
    reader.onload = (e) => {
      try{
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, { type: "array", cellDates: true, raw: false });
        let ws = null, chosenSheet = null;
        for(const name of wb.SheetNames){
          const w = wb.Sheets[name];
          if (w && w['!ref']) { ws = w; chosenSheet = name; break; }
        }
        if(!ws) throw new Error("Workbook has no populated sheets.");
        const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "", blankrows: false, raw: false });
        if(!aoa || !aoa.length) throw new Error(`Sheet "${chosenSheet}" is empty.`);
        let headerRow = -1;
        for(let i=0;i<aoa.length;i++){
          const nonEmpty = aoa[i].filter(v => String(v).trim() !== "");
          if(nonEmpty.length >= 3){ headerRow = i; break; }
        }
        if(headerRow === -1) throw new Error(`No plausible header row found in "${chosenSheet}".`);
        const headers = aoa[headerRow].map(h => String(h||"").trim());
        const rowsAOA = aoa.slice(headerRow+1).filter(r => r.some(v => String(v).trim() !== ""));
        const arr = rowsAOA.map(r => { const o={}; headers.forEach((h,idx)=> o[h]=r[idx] ?? ""); return o; });
        importRows(arr);
      }catch(err){
        console.error("Excel import error:", err);
        alert(`File parse error: ${err.message || err}`);
      }
    };
    reader.readAsArrayBuffer(f);

  } catch (e) {
    console.error(e);
    alert(e.message || String(e));
  }
};

function importRows(arr){
  const batchId = $("batchName").value.trim() || ("Batch_"+new Date().toISOString().slice(0,10));
  const batchType = $("batchType").value;
  const mode = $("importMode").value;
  if(mode==="replace" && !confirm("Replace ALL rows?")) return;
  if(mode==="replace") rows = [];

  const enabled = template.filter(c=>c.enabled).map(c=>c.key);
  const aliases = {
    "bookingdatetime":"booking-date-time","booking-date":"booking-date-time",
    "deliverystatus":"DELIVERY STATUS","deliverydate":"DELIVERY DATE",
    "paymentmodedescription":"payment_mode_description","payment-mode-description":"payment_mode_description",
    "paymentmodecode":"payment-mode-code","bookchannelid":"book-channel-id","bookchannelname":"book-channel-name",
    "booktypeid":"book-type-id","booktypename":"book-type-name","customerid":"customer-id","customername":"customer-name",
    "customertypeid":"customer-type-id","customertype":"customer-type","destinationpin":"destination-pin",
    "vpcodtype":"vp-cod-type","vpcodvalue":"vp-cod-value"
  };
  const norm = s=>_normKey(s);
  const normTemplate = enabled.map(k=>({key:k, n:norm(k)}));
  const sample = arr[0] || {};
  const headerMap = {};
  Object.keys(sample).forEach(sc=>{
    const ns = norm(sc);
    const aliasKey = aliases[ns];
    if (aliasKey && enabled.includes(aliasKey)) { headerMap[sc] = aliasKey; return; }
    const exact = normTemplate.find(t=>t.n===ns);
    if (exact) { headerMap[sc]=exact.key; return; }
    const soft = normTemplate.find(t=> t.n.startsWith(ns) || ns.startsWith(t.n));
    headerMap[sc] = soft ? soft.key : sc;
  });

  let dup=0, miss=0, add=0;
  const existing = new Set(rows.map(r=>String(r["article-number"]||"")));

  arr.forEach(src=>{
    const r={};
    for(const [k,v] of Object.entries(src)){
      const mapped = headerMap[k] || k;
      r[mapped] = v;
    }
    r._batchId = batchId; r._batchType = batchType;
    if(r["DELIVERY STATUS"]) r["DELIVERY STATUS"] = String(r["DELIVERY STATUS"]).toUpperCase();
    if(REQUIRED.some(k=>!String(r[k]||"").trim())) miss++;
    const key = String(r["article-number"]||"");
    if(key && existing.has(key)){ dup++; }
    else { if(key) existing.add(key); rows.push(r); add++; }
  });

  persist(); refreshAll();
  logAudit("import", {batchId,batchType,mode,added:add,duplicates:dup,missing:miss});
  alert(`Imported ${add} row(s).\nDuplicates: ${dup}\nMissing requireds flagged: ${miss}\nBatch: ${batchId} (${batchType})`);
}

/* =================== Dashboard / Charts =================== */
function refreshKPIs(){
  const inScope=rows.filter(scopeFilter);
  const total=inScope.length;
  const delivered=inScope.filter(r=>String(r["DELIVERY STATUS"]||"").toUpperCase()==="DELIVERED").length;
  const aged=inScope.filter(r=>{
    const st=String(r["DELIVERY STATUS"]||"").toUpperCase();
    if(st==="DELIVERED"||st==="EXCEPTION") return false;
    const dt=dayjs(r["booking-date-time"]); if(!dt.isValid()) return false;
    return dayjs().diff(dt,"hour")>slaHoursFor(r);
  }).length;
  const exception=inScope.filter(r=>String(r["DELIVERY STATUS"]||"").toUpperCase()==="EXCEPTION").length;
  $("kpiTotal").textContent=total; $("kpiDelivered").textContent=delivered; $("kpiAged").textContent=aged; $("kpiException").textContent=exception;
}
function chart(id,cfg){ if(charts[id]) charts[id].destroy(); charts[id]=new Chart(document.getElementById(id),cfg); }
function refreshCharts(){
  const inScope=rows.filter(scopeFilter);
  const st=["DELIVERED","IN-TRANSIT","PENDING","EXCEPTION"];
  const cnt=st.map(s=> inScope.filter(r=>String(r["DELIVERY STATUS"]||"").toUpperCase()===s).length);
  chart("chartStatus",{type:"doughnut",data:{labels:st,datasets:[{data:cnt}]},options:{plugins:{legend:{position:"bottom"}}}});
  const regs=[...new Set(inScope.map(r=>r.Region).filter(Boolean))].sort(); const byReg=regs.map(reg=> inScope.filter(r=>r.Region===reg).length);
  chart("chartByRegion",{type:"bar",data:{labels:regs,datasets:[{label:"Articles",data:byReg}]},options:{plugins:{legend:{display:false}}}});
  const map={}; inScope.forEach(r=>{ const d=(String(r["booking-date-time"]||"").substring(0,10))||""; if(!d) return; map[d]=(map[d]||0)+1; }); const dates=Object.keys(map).sort();
  chart("chartTrend",{type:"line",data:{labels:dates,datasets:[{label:"Articles",data:dates.map(d=>map[d])}]},options:{plugins:{legend:{display:false}}}});
}

/* =================== Backup / Restore =================== */
function downloadBackup(){
  const payload={rows,template,complaints,settings,rules,audit,profile,ts:new Date().toISOString()};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="article_status_backup.json"; a.click();
}
function restoreBackup(e){
  const f=e.target.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      const o=JSON.parse(reader.result);
      if(o.rows) rows=o.rows;
      if(o.template) template=o.template;
      if(o.complaints) complaints=o.complaints;
      if(o.settings) Object.assign(settings,o.settings);
      if(o.rules) rules=o.rules;
      if(o.audit) audit=o.audit;
      if(o.profile) profile=o.profile;
      persist(); saveTemplate(); saveComplaints(); saveRules(); saveAudit(); persistSettings();
      localStorage.setItem(LS.PROFILE, JSON.stringify(profile));
      refreshAll(); logAudit("backup.restore",{});
      alert("Backup restored.");
    }catch(err){ alert("Invalid JSON."); }
  };
  reader.readAsText(f);
}

/* =================== Init =================== */
function renderAuditIfVisible(){ if(can("seeAudit")) renderAudit(); }
function refreshAll(){
  buildOptions(); buildManualForm(); renderTable(); renderComplaints(); buildRuleTable(); renderAuditIfVisible();
  refreshKPIs(); refreshCharts(); renderAlertsHeader();
}
function boot(){
  loadTheme(); seedUsersIfEmpty();
  const session=JSON.parse(localStorage.getItem(LS.SESSION)||"null");
  if(session){
    const p=JSON.parse(localStorage.getItem(LS.PROFILE)||"{}");
    profile=Object.assign({username:session.user, role:"Operator", region:"", division:""}, p);
    $("chipUser").textContent=profile.username;
    showApp(true);
  } else {
    showApp(false);
  }
  loadAll();
  if(!rules.length){ rules=[{scope:"GLOBAL",key:"GLOBAL",hours:72}]; saveRules(); }
  buildTabs(); applyRole(); buildTemplateEditor(); refreshAll();
  if(alertTimer) clearInterval(alertTimer);
  alertTimer=setInterval(renderAlertsHeader, 5000);
}
boot();
</script>
</body>
</html>
