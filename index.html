<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MMU-Monitoring Dashboard</title>

<!-- Self-hosted Excel parser (place xlsx.full.min.js next to this file) -->
<script src="./xlsx.full.min.js"></script>

<!-- PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

<!-- Charts + dates -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/dayjs.min.js"></script>

<style>
/* ------------------- Glassmorphic Light Theme ------------------- */
:root{
  --bg: #f3f5fb;               /* soft neutral */
  --glass: rgba(255,255,255,0.6);
  --glass-strong: rgba(255,255,255,0.75);
  --glass-hover: rgba(255,255,255,0.9);
  --blur: 14px;

  --ink: #0f172a;              /* slate-900 */
  --muted:#6b7280;             /* slate-500 */
  --border: rgba(15,23,42,.12);
  --shadow: 0 12px 40px rgba(2,6,23,.08);

  /* Brand & semantic color code */
  --brand:#9b1c24;             /* deep burgundy */
  --gold:#c89d2a;              /* accent gold */
  --ok:#16a34a;                /* green */
  --warn:#d97706;              /* amber */
  --info:#2563eb;              /* blue */
  --danger:#dc2626;            /* red */

  /* Status tones (pills/tags) */
  --st-delivered-bg:#ecfdf5; --st-delivered-fg:#166534; --st-delivered-bd:#86efac;
  --st-intransit-bg:#eff6ff; --st-intransit-fg:#1e3a8a; --st-intransit-bd:#bfdbfe;
  --st-pending-bg:#fffbeb;   --st-pending-fg:#7c2d12;  --st-pending-bd:#fde68a;
  --st-exception-bg:#fef2f2; --st-exception-fg:#7f1d1d;--st-exception-bd:#fecaca;

  --radius:16px;
}

/* Page background with subtle gradient + texture */
html,body{height:100%}
body{
  margin:0;
  color:var(--ink);
  font-family:system-ui, Segoe UI, Roboto, Arial, sans-serif;
  background:
    radial-gradient(1200px 700px at 20% -10%, #ffffff 0%, #eef2ff 45%, #e9f0ff00 60%),
    radial-gradient(1000px 800px at 110% 10%, #fff 0%, #f3f5fb 40%, #f3f5fb 100%);
}

/* Generic containers */
.wrap{max-width:1280px;margin:0 auto;padding:14px}
.card{
  background: var(--glass);
  backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur));
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px;
  box-shadow: var(--shadow);
}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.grid{display:grid;gap:14px}
.grow{flex:1 1 auto}
.hidden{display:none!important}
.right{margin-left:auto}

/* ====== KPI widgets ====== */
.kpi-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px }
.kpi-card{
  background: var(--glass-strong);
  border:1px solid var(--border); border-radius:14px; padding:12px;
  position:relative; min-height:84px;
}
.kpi-title{ font-size:12px; color:#374151; display:flex; align-items:center; gap:6px }
.kpi-value{ font-size:26px; font-weight:900; color:#111827; margin-top:6px }
.kpi-sub{ font-size:12px; color:#6b7280; margin-top:2px }

/* Info icon + tooltip (click-to-open, top-right) */
.info{
  position:absolute; top:8px; right:8px;
  display:inline-flex; align-items:center; justify-content:center;
  width:18px; height:18px; border-radius:999px; font-size:12px;
  background:var(--glass-hover); border:1px solid var(--border); cursor:pointer;
  z-index:1;
}
.tooltip{
  position:absolute; top:32px; right:8px; z-index:9999;
  max-width:320px;
  background:var(--glass); border:1px solid var(--border);
  border-radius:10px; padding:10px; box-shadow:var(--shadow);
  color:#111827; font-size:12px; display:none;
}
/* click only (no hover): show when .show is present */
.kpi-card .tooltip.show{ display:block }


/* KPI chart block header (with toggle) */
.block-head{ display:flex; align-items:center; gap:10px; justify-content:space-between; margin-bottom:6px }
.view-toggle button{ padding:6px 10px }
.view-toggle .active{ box-shadow: inset 0 0 0 2px rgba(200,157,42,.25); border-color:rgba(200,157,42,.5) }

/* Expand/collapse (office stats) */
.disclosure{ cursor:pointer; user-select:none; }
.disclosure .chev{ transition:.2s transform ease }
.disclosure[aria-expanded="true"] .chev{ transform:rotate(90deg) }
.collapsible{ display:none }
.collapsible.show{ display:block }

  
/* Inputs / Buttons */
input,select,textarea,button{
  background: var(--glass-strong);
  backdrop-filter: blur(calc(var(--blur) - 4px));
  -webkit-backdrop-filter: blur(calc(var(--blur) - 4px));
  color: var(--ink);
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px 12px;
}
input::placeholder{color:var(--muted)}
button.btn{
  background: linear-gradient(180deg, rgba(200,157,42,.18), rgba(200,157,42,.10));
  border-color: rgba(200,157,42,.45);
  color:#111827;
  font-weight:700;
}
.btn.ghost{background:var(--glass-strong);border-color:var(--border)}
.btn.red{background:linear-gradient(180deg,rgba(220,38,38,.12),rgba(220,38,38,.06));border-color:rgba(220,38,38,.35)}
.btn.gray{background:var(--glass-strong)}
.badge{font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid var(--border);color:#111827;background:var(--glass-strong)}

/* Header: glass bar */
.header{
  position:sticky;top:0;z-index:50;
  border-bottom:1px solid var(--border);
  background: var(--glass);
  backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur));
}
.header-inner{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:8px}
.brand{display:flex;gap:10px;align-items:center;font-weight:900;font-size:18px;color:#111827}
.head-actions{justify-self:end;display:flex;gap:8px;align-items:center}
.head-center{justify-self:center;display:flex;gap:8px;align-items:center}

/* Tabs BAR (now separate section BELOW header) */
.tabs-shell{ /* this sits BELOW the header for proper spacing */
  background: transparent;
}
.tabs-bar{
  display:flex;align-items:center;gap:8px;
  padding:10px 0 6px 0;
  margin-bottom:12px;
}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{
  padding:8px 12px;border-radius:999px;border:1px solid var(--border);
  background: var(--glass-strong);
  font-weight:700;color:#111827
}
.tab.active{
  border-color: rgba(200,157,42,.6);
  box-shadow: inset 0 0 0 2px rgba(200,157,42,.25);
}

#alertsSlot {margin-left:auto; position: relative; z-index: 50; }
#alertMenu{
  position:absolute; right:0; top:36px; min-width:320px; z-index: 9999;
}

/* Tables: full borders + inline filters row (glass) */
.table-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px;background:var(--glass-strong);backdrop-filter:blur(calc(var(--blur) - 4px))}
table{border-collapse:separate;border-spacing:0;width:100%;min-width:900px;background:transparent}
th,td{
  padding:10px 12px;
  border-right:1px solid var(--border);
  border-bottom:1px solid var(--border);
  background: transparent;
}
th{
  position:sticky;top:0;
  background: var(--glass-hover);
  backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur));
  font-size:12px;text-transform:uppercase;letter-spacing:.35px;color:#374151;z-index:1
}
tr:last-child td{border-bottom:none}
table tr th:first-child, table tr td:first-child{border-left:1px solid var(--border)}
table thead tr:first-child th{border-top:1px solid var(--border)}

/* Inline filter row (sticks below the header row) */
tr.filter-row th, tr.filter-row td{
  background: var(--glass-strong);
  backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur));
  position:sticky;
  top:38px;           /* directly under headers */
  z-index:1;
}
.inline-filter{
  width:100%;
  padding:6px 8px;
  border:1px solid var(--border);
  border-radius:8px;
  background: var(--glass-hover);
  font-size:12px;
}

/* Status pills with semantic color code */
.pill{padding:3px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;background:var(--glass-strong)}
.pill.delivered{border-color:var(--st-delivered-bd);color:var(--st-delivered-fg);background:var(--st-delivered-bg)}
.pill.intransit{border-color:var(--st-intransit-bd);color:var(--st-intransit-fg);background:var(--st-intransit-bg)}
.pill.pending{border-color:var(--st-pending-bd);color:var(--st-pending-fg);background:var(--st-pending-bg)}
.pill.exception{border-color:var(--st-exception-bd);color:var(--st-exception-fg);background:var(--st-exception-bg)}

/* KPI cards */
.kpi{font-size:28px;font-weight:900;color:#111827}

/* Login (glass) */
.login-host{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.login-card{
  width:min(640px,96vw);
  background: var(--glass);
  backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur));
  border:1px solid var(--border);
  border-radius:24px;
  padding:26px;
  box-shadow:var(--shadow)
}
.login-card .title{font-size:40px;font-weight:900;text-align:center;color:#111827;margin:4px 0 20px}
.field{margin:12px 0}
.field label{display:block;margin:0 0 8px 0;color:#374151;font-weight:700}
.input-wrap{display:flex;align-items:center;gap:8px;background:var(--glass-strong);border:1px solid var(--border);border-radius:12px;padding:10px}
.input-wrap input{background:transparent;border:none;outline:none;color:#111827;width:100%}
.input-wrap .icon{opacity:.7}
.login-actions{display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:center;margin-top:14px}
.login-actions .sub{color:#6b7280;text-align:left}
.err{color:#b91c1c;font-weight:700;margin-top:8px}

/* ===== Dynamic Color Coding (Global) ===== */
:root{
  --ok-bg:#ecfdf5;     --ok-br:#bbf7d0;
  --warn-bg:#fff7ed;   --warn-br:#fde68a;
  --err-bg:#fef2f2;    --err-br:#fecaca;
  --info-bg:#eef2ff;   --info-br:#c7d2fe;
}

/* KPI tiles (Dashboard quick KPIs) */
.tile.k-ok   { background:var(--ok-bg);   border-color:var(--ok-br); }
.tile.k-warn { background:var(--warn-bg); border-color:var(--warn-br); }
.tile.k-err  { background:var(--err-bg);  border-color:var(--err-br); }
.tile.k-info { background:var(--info-bg); border-color:var(--info-br); }

/* KPI cards (KPIs tab – if you’re using .kpi-card) */
.kpi-card.k-ok   { background:var(--ok-bg);   border-color:var(--ok-br); }
.kpi-card.k-warn { background:var(--warn-bg); border-color:var(--warn-br); }
.kpi-card.k-err  { background:var(--err-bg);  border-color:var(--err-br); }
.kpi-card.k-info { background:var(--info-bg); border-color:var(--info-br); }

/* Table row coloring (Bulk View & Update / Reports / any table with DELIVERY STATUS) */
tr.row-ok   { background:var(--ok-bg);   }
tr.row-warn { background:var(--warn-bg); }
tr.row-err  { background:var(--err-bg);  }
tr.row-info { background:var(--info-bg); }

/* Slightly tint borders for colored rows */
tr.row-ok   > td { border-color:var(--ok-br); }
tr.row-warn > td { border-color:var(--warn-br); }
tr.row-err  > td { border-color:var(--err-br); }
tr.row-info > td { border-color:var(--info-br); }

/* Optional: small legend badge you can reuse if desired */
.badge-legend{
  display:inline-block; padding:2px 8px; border-radius:999px; font-weight:700; font-size:12px; margin-right:6px;
  border:1px solid currentColor; color:#111827; background:#fff;
}
.badge-ok{   background:var(--ok-bg);   color:#065f46; border-color:var(--ok-br);}
.badge-warn{ background:var(--warn-bg); color:#92400e; border-color:var(--warn-br);}
.badge-err{  background:var(--err-bg);  color:#991b1b; border-color:var(--err-br);}
.badge-info{ background:var(--info-bg); color:#1e3a8a; border-color:var(--info-br);}

/* === Force KPI tooltips to be opaque for readability (surgical override) === */
.kpi-card .tooltip{
  background: #ffffff !important;     /* solid, no transparency */
  border-color: #e5e7eb !important;   /* soft gray border */
  color: #111827 !important;          /* high contrast text */
  backdrop-filter: none !important;   /* remove glass blur */
  -webkit-backdrop-filter: none !important;
  box-shadow: 0 12px 40px rgba(2,6,23,.12); /* slightly stronger shadow for separation */
}

/* KPI cards */
.kpi-card .kpi-title{
  /* allow natural & forced wraps */
  overflow-wrap: anywhere;
  word-break: break-word;
  hyphens: auto;

  /* show max 2 lines then ellipsis */
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;

  /* responsive size that won’t shout */
  font-size: clamp(14px, 1.6vw, 16px);
  line-height: 1.25;
}

.kpi-card .kpi-value{
  /* scale with card width but never too tiny/huge */
  font-size: clamp(22px, 3.2vw, 38px);
  line-height: 1.05;
  letter-spacing: -0.02em; /* tiny tighten for large digits */
}

.kpi-card .kpi-sub{
  overflow-wrap: anywhere;
  word-break: break-word;
  hyphens: auto;

  /* up to 2 lines */
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;

  font-size: clamp(11px, 1.2vw, 12px);
  line-height: 1.25;
}

/* If you also want this on the quick KPI tiles on the Dashboard */
.tile .badge{
  overflow-wrap: anywhere;
  word-break: break-word;
  hyphens: auto;

  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.tile .kpi{
  font-size: clamp(22px, 3vw, 36px);
  letter-spacing: -0.02em;
  line-height: 1.05;
}


/* ——— KPIs header legend ——— */
.section-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
.legend-inline{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.legend-item{
  display:inline-flex;align-items:center;gap:6px;
  padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;
  background:var(--glass-strong);border:1px solid var(--border);color:#111827
}
.legend-item svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2}

/* Color skins (re-use your existing variables) */
.legend-ok   { background:var(--ok-bg);   border-color:var(--ok-br);   color:#166534; }
.legend-warn { background:var(--warn-bg); border-color:var(--warn-br); color:#92400e; }
.legend-err  { background:var(--err-bg);  border-color:var(--err-br);  color:#991b1b; }
.legend-info { background:var(--info-bg); border-color:var(--info-br); color:#1e3a8a; }

.section-head{ margin-bottom:48px; }
#kpiSubTabs{ margin-bottom:48px; }

</style>
</head>
<body>
<!-- =================== LOGIN =================== -->
<div id="loginScreen" class="login-host">
  <div class="login-card">
    <div class="title">Welcome</div>

    <div class="field">
      <label>User ID</label>
      <div class="input-wrap">
        <span class="icon">👤</span>
        <input id="lgUser" placeholder="User ID">
      </div>
    </div>

    <div class="field">
      <label>Password</label>
      <div class="input-wrap">
        <span class="icon">🔒</span>
        <input id="lgPass" type="password" placeholder="Password">
        <button class="btn ghost" style="padding:6px 10px" onclick="togglePw()" title="Show/Hide">👁️</button>
      </div>
    </div>

<div class="login-actions">
  <div class="sub">
    <a href="javascript:void(0)" onclick="startChangePassword()">Change password</a>
  </div>
  <div class="sub" style="text-align:right">
    <a href="javascript:void(0)" onclick="startForgot()">Forgot password?</a>
  </div>

  <button class="btn ghost" onclick="clearLogin()">Clear</button>
  <button class="btn" onclick="doLogin()">Log in</button>
</div>


    <div id="lgErr" class="err hidden"></div>
  </div>
</div>

<!-- =================== HEADER (glass) =================== -->
<div id="appHeader" class="header hidden">
  <div class="wrap header-inner">
    <div class="brand">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="#c89d2a" aria-hidden="true">
        <path d="M12 2l4 4-4 4-4-4 4-4zm0 6l4 4-4 4-4-4 4-4zm0 6l4 4-4 4-4-4 4-4z"/>
      </svg>
      <div>MMU-Monitoring Dashboard</div>
    </div>

    <div class="head-center"><!-- intentionally empty for clean layout --></div>

    <div class="head-actions">
      <span id="chipUser" class="badge">—</span>
      <button class="btn red" onclick="doLogout()">Logout</button>
    </div>
  </div>
</div>

<!-- =================== TABS ROW (separate section below header) =================== -->
<div id="tabsShell" class="tabs-shell hidden">
  <div class="wrap tabs-bar">
    <div class="tabs" id="tabs"></div>
    <!-- Alerts at the far right (NOT in header) -->
    <div id="alertsSlot">
      <button id="alertBtn" class="btn">Alerts <span id="alertCount" class="badge hidden">0</span></button>
      <div id="alertMenu" class="card hidden"></div>
    </div>
  </div>
</div>

<!-- =================== MAIN =================== -->
<div id="appMain" class="wrap grid hidden">
  <!-- ===== Data management ===== -->
  <section class="card" data-tab="Data management">
    <h3>Data Management</h3>

    <div class="grid">
      <div class="card">
        <h4>Upload / Import (Excel or CSV)</h4>
        <div class="row">
          <input type="file" id="fileInput" accept=".xlsx,.xls,.csv"/>
          <input id="batchName" placeholder="Batch name e.g., Daily_2025-10-07"/>
          <select id="batchType">
            <option>ad-hoc</option><option>daily</option><option>weekly</option><option selected>monthly</option>
          </select>
          <select id="importMode">
            <option value="append" selected>Append</option>
            <option value="replace">Replace all</option>
          </select>
          <button type="button" class="btn" onclick="window.handleFile()">Import</button>
        </div>
        <div class="badge" style="margin-top:6px">
          Tip: header row can use hyphens or underscores; the importer maps to the template automatically.
          If network blocks external scripts, Excel is parsed via the self-hosted file or use CSV.
        </div>
      </div>

      <div class="card">
        <h4>Manual Entry</h4>
        <form id="manualForm" class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));"></form>
        <div class="row">
          <button class="btn" onclick="saveManual()">Save Row</button>
          <button class="btn ghost" onclick="document.getElementById('manualForm').reset()">Clear</button>
        </div>
      </div>

      <div class="card">
        <h4>Template</h4>
        <div id="templateEditor" class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr));"></div>
        <div class="row">
          <button class="btn" onclick="downloadTemplate('xlsx')">Download Template (XLSX)</button>
          <button class="btn" onclick="downloadTemplate('csv')">Download Template (CSV)</button>
          <button class="btn red" onclick="resetTemplate()">Reset</button>
        </div>
      </div>

      <div class="card">
        <h4>Backup & Restore</h4>
        <div class="row">
          <button class="btn" onclick="downloadBackup()">Backup JSON</button>
          <label class="row">Restore:
            <input type="file" accept=".json" onchange="restoreBackup(event)"/>
          </label>
        </div>
        <div class="badge" style="margin-top:6px">
          Backup includes rows, template, complaints, rules, audit, settings, and profile. Restore overwrites in-browser data.
        </div>
      </div>
    </div>
  </section>

  <!-- ===== Dashboard ===== -->
  <section class="card" data-tab="Dashboard">
    <h3>Analytics</h3>
    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(240px,1fr));">
      <div class="card"><div class="badge">Total (in scope)</div><div class="kpi" id="kpiTotal">0</div></div>
      <div class="card"><div class="badge">Delivered</div><div class="kpi" id="kpiDelivered">0</div></div>
      <div class="card"><div class="badge">Pending (&gt; SLA)</div><div class="kpi" id="kpiAged">0</div></div>
      <div class="card"><div class="badge">Exceptions</div><div class="kpi" id="kpiException">0</div></div>
    </div>
    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr));">
      <div class="card"><canvas id="chartStatus"></canvas></div>
      <div class="card"><canvas id="chartByRegion"></canvas></div>
      <div class="card"><canvas id="chartTrend"></canvas></div>
    </div>
  </section>

  <!-- ===== Bulk View & Update (details link column) ===== -->
  <section class="card" data-tab="Bulk View & Update">
    <h3>Bulk View & Update</h3>

    <!-- Bulk controls at the TOP -->
    <div class="row" style="margin-bottom:6px">
      <label class="row">Bulk Status:
        <select id="bulkStatus">
          <option value="">— choose —</option>
          <option>DELIVERED</option><option>IN-TRANSIT</option><option>PENDING</option><option>EXCEPTION</option>
        </select>
      </label>
      <label class="row">Delivery Date: <input type="date" id="bulkDate"></label>
      <button class="btn" onclick="applyBulk()">Apply to Selected</button>
      <button class="btn gray" onclick="exportTable('xlsx')">Export</button>
      <button class="btn red right hidden" id="btnDelete" onclick="deleteSelected()">Delete Selected</button>
    </div>

    <!-- Table with full borders + inline filters generated by script -->
    <div class="table-wrap"><table id="dataTable"></table></div>
  </section>

  <!-- ===== Reports ===== -->
  <section class="card" data-tab="Reports">
    <h3>Reports</h3>
    <div class="row">
      <select id="reportType" class="grow">
        <option value="summary">Summary</option>
        <option value="trend">Trend (daily/weekly/monthly)</option>
        <option value="exceptions">Exceptions</option>
        <option value="performance">Performance (SLA, avg time)</option>
        <option value="compliance">Compliance (APT 2.0, mandatory)</option>
        <option value="custom">Custom / User-defined</option>
      </select>
      <button class="btn" onclick="buildReport()">Build</button>
      <button class="btn" onclick="reportExport('pdf')">PDF</button>
      <button class="btn" onclick="reportExport('xlsx')">Excel</button>
      <button class="btn" onclick="reportExport('csv')">CSV</button>
    </div>
    <div class="table-wrap" style="margin-top:8px"><table id="reportTable"></table></div>
  </section>

  <!-- ===== KPIs (Admin+ only via RBAC) ===== -->
<section class="card" data-tab="KPIs">
<div class="section-head">
  <h3 style="margin:0">KPIs</h3>

  <div class="legend-inline" aria-label="Color legend">
    <span class="legend-label">Color code:</span>
    <!-- Delivered -->
    <span class="legend-item legend-ok" title="Delivered / On-time">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M8 12l3 3 5-6"></path>
      </svg>
      Delivered
    </span>

    <!-- Pending > SLA -->
    <span class="legend-item legend-warn" title="Pending beyond SLA">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M12 6v6l4 2"></path>
      </svg>
      Pending&nbsp;>&nbsp;SLA
    </span>

    <!-- Exception -->
    <span class="legend-item legend-err" title="Exception / Return / Breach">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M12 3l9 16H3z"></path>
        <path d="M12 9v4M12 17h.01"></path>
      </svg>
      Exception
    </span>

    <!-- Info / Neutral -->
    <span class="legend-item legend-info" title="Totals / Neutral">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M12 8h.01M11 12h2v4h-2z"></path>
      </svg>
      Info
    </span>
  </div>
</div>


  <!-- Sub-tabs for KPI domains -->
  <div class="row" id="kpiSubTabs" style="margin-bottom:48px"></div>

  <!-- Panel host -->
  <div id="kpiPanel" class="grid"></div>

  <!-- Office-wise stats (collapsed by default) -->
  <div class="card" style="margin-top:10px">
    <div id="officeDisclosure" class="disclosure row" aria-expanded="false" onclick="toggleOfficeBlock()">
      <span class="chev">▶</span>
      <strong>Office-wise Statistics (Booking & Delivery)</strong>
      <span class="badge">collapsed</span>
    </div>
    <div id="officeBlock" class="collapsible">
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); margin-top:10px">
        <div class="card">
          <div class="block-head"><strong>Booking Offices — Volume & Trend</strong><div class="view-toggle" id="bookViewTog"></div></div>
          <canvas id="chartOfficeBook"></canvas>
        </div>
        <div class="card">
          <div class="block-head"><strong>Delivery Offices — Performance</strong><div class="view-toggle" id="delivViewTog"></div></div>
          <canvas id="chartOfficeDeliv"></canvas>
        </div>
      </div>
      <div class="table-wrap" style="margin-top:10px"><table id="officeTable"></table></div>
    </div>
  </div>
</section>

  
  <!-- ===== Complaints (dropdown Issue type + custom + date + bulk entry) ===== -->
  <section class="card" data-tab="Complaints">
    <h3>Complaints & Issues</h3>

    <!-- Single add/update row -->
    <div class="row">
      <input id="cmpArticle" placeholder="article-number"/>
      <label class="row">Issue type:
        <select id="cmpType" onchange="toggleCustomIssue()">
          <option value="">— choose —</option>
          <option>COD</option>
          <option>COD Payment Issue</option>
          <option>Damage</option>
          <option>Delivery Details updation pending</option>
          <option>In-Transit</option>
          <option>Non-Delivery</option>
          <option>POD</option>
          <option>Pickup pending</option>
          <option>Picked-booking pending</option>
          <option>RTS</option>
          <option>Other/Custom</option>
        </select>
      </label>
      <input id="cmpTypeCustom" class="hidden" placeholder="Enter custom issue type"/>
      <input id="cmpDate" type="date" title="Date of event/update"/>
      <input id="cmpDesc" class="grow" placeholder="Latest update / note (timeline event)"/>
      <select id="cmpStatus">
        <option value="Open">Open</option>
        <option value="In-Progress">In-Progress</option>
        <option value="Escalated">Escalated</option>
        <option value="Resolved">Resolved</option>
        <option value="Closed">Closed</option>
        <option value="Re-opened">Re-opened</option>
      </select>
      <button class="btn" onclick="addComplaint()">Add / Update</button>
    </div>

    <!-- Bulk entry for multiple articles with the same issue -->
    <div class="card">
      <h4>Bulk Articles – Same Issue</h4>
      <div class="row">
        <textarea id="cmpBulkArticles" class="grow" rows="3" placeholder="Paste article numbers here (comma or new line separated)"></textarea>
      </div>
      <div class="row">
        <label class="row">Issue type:
          <select id="cmpBulkType" onchange="toggleCustomIssueBulk()">
            <option value="">— choose —</option>
            <option>COD</option>
            <option>COD Payment Issue</option>
            <option>Damage</option>
            <option>Delivery Details updation pending</option>
            <option>In-Transit</option>
            <option>Non-Delivery</option>
            <option>POD</option>
            <option>Pickup pending</option>
            <option>Picked-booking pending</option>
            <option>RTS</option>
            <option>Other/Custom</option>
          </select>
        </label>
        <input id="cmpBulkTypeCustom" class="hidden" placeholder="Enter custom issue type"/>
        <input id="cmpBulkDate" type="date" title="Date of event/update"/>
        <input id="cmpBulkDesc" class="grow" placeholder="Latest update / note"/>
        <label class="row">Bulk status:
          <select id="cmpBulkStatus">
            <option value="">— choose —</option>
            <option>Open</option><option>In-Progress</option><option>Escalated</option>
            <option>Resolved</option><option>Closed</option><option>Re-opened</option>
            <option>Other/Custom</option>
          </select>
        </label>
        <input id="cmpBulkStatusCustom" class="hidden" placeholder="Enter custom status"/>
        <button class="btn" onclick="addComplaintBulk()">Apply to Articles</button>
        <button class="btn gray" onclick="clearComplaintBulk()">Clear / Reset</button>
      </div>
    </div>

    <!-- Bulk status change for selected complaint rows -->
    <div class="row" style="margin-top:6px">
      <label class="row">Bulk status (selected rows):
        <select id="cmpRowBulkStatus" onchange="toggleRowBulkCustom()">
          <option value="">— choose —</option>
          <option>Open</option><option>In-Progress</option><option>Escalated</option>
          <option>Resolved</option><option>Closed</option><option>Re-opened</option>
          <option>Other/Custom</option>
        </select>
      </label>
      <input id="cmpRowBulkStatusCustom" class="hidden" placeholder="Enter custom status"/>
      <button class="btn" onclick="applyComplaintBulk()">Apply to selected</button>
      <button class="btn gray" onclick="exportComplaints()">Export</button>
    </div>

    <!-- One row per unique article; timeline rendered in same row -->
    <div class="table-wrap" style="margin-top:8px">
      <table id="cmpTable"></table>
    </div>
  </section>

  <!-- ===== SLA Rules ===== -->
  <section class="card" data-tab="SLA Rules">
    <h3>SLA & Compliance Rules</h3>
    <div class="row">
      <select id="ruleScope"><option>GLOBAL</option><option>REGION</option><option>DIVISION</option><option>CUSTOMER</option><option>ARTICLE-TYPE</option></select>
      <input id="ruleKey" placeholder="Scope value (e.g., South, Belagavi, customer-id…)"/>
      <input type="number" id="ruleHours" placeholder="SLA (hours)" min="1" style="width:140px"/>
      <button class="btn" onclick="addRule()">Add/Update</button>
      <button class="btn red" onclick="resetRules()">Reset</button>
    </div>
    <div class="table-wrap" style="margin-top:8px"><table id="ruleTable"></table></div>
  </section>

  <!-- ===== Audit (Superadmin only — RBAC) ===== -->
  <section class="card" data-tab="Audit">
    <h3>Audit Log</h3>
    <div class="table-wrap"><table id="auditTable"></table></div>
    <div class="row" style="margin-top:6px">
      <button class="btn gray" onclick="downloadAudit()">Export Audit</button>
      <button class="btn red" onclick="clearAudit()">Clear Audit</button>
    </div>
  </section>

  <!-- ===== Settings ===== -->
  <section class="card" data-tab="Settings">
    <h3>Settings</h3>
    <div class="row">
      <label>Default Report Period:
        <select id="defaultPeriod" onchange="persistSettings()">
          <option value="daily">Daily</option><option value="weekly">Weekly</option>
          <option value="monthly" selected>Monthly</option><option value="quarterly">Quarterly</option><option value="annual">Annual</option>
        </select>
      </label>
      <label>Manual Delete Allowed:
        <select id="allowDelete" onchange="persistSettings()">
          <option value="role">By Role</option><option value="never">Never</option><option value="always">Always</option>
        </select>
      </label>
      <label>Default Scope – Region:
        <select id="scopeRegion" onchange="persistProfile();refreshAll()"><option value="">All</option></select>
      </label>
      <label>Division:
        <select id="scopeDivision" onchange="persistProfile();refreshAll()"><option value="">All</option></select>
      </label>
    </div>
  </section>
</div>
<script>
/* =================== Utilities & Constants =================== */
const $ = (id)=>document.getElementById(id);

function _normKey(s){
  return String(s||"")
    .trim()
    .toLowerCase()
    .replace(/[._/]+/g,"-")
    .replace(/\s+/g,"-")
    .replace(/[^a-z0-9-]/g,"")
    .replace(/-+/g,"-");
}

const DEFAULT_COLUMNS = [
 "customer-id","customer-name","customer-type-id","customer-type","contract-id",
 "payment-mode-code","payment_mode_description","book-channel-id","book-channel-name",
 "book-type-id","book-type-name","user-id","user-name","article-number","article-type",
 "booking-date-time","booking-office-pin","booking-office-id","booking-office-name",
 "destination-country","destination-pin","Region","Division","destination-office-name",
 "DELIVERY STATUS","DELIVERY DATE","APT 2.O updation","sender-name","sender-address",
 "receiver-name","receiver-address","event-code","event-description","tariff","weight",
 "vp-cod-type","vp-cod-value","remarks"
];
const REQUIRED = ["article-number","booking-date-time","booking-office-name","Region","Division","DELIVERY STATUS"];

const ROLE = { Viewer:0, Operator:1, Supervisor:2, Admin:3, Superadmin:4 };
const LS = {
  ROWS:"as_rows_v3",
  TEMPLATE:"as_template_v3",
  COMPLAINTS:"as_complaints_v4",
  SETTINGS:"as_settings_v3",
  RULES:"as_rules_v2",
  AUDIT:"as_audit_v2",
  PROFILE:"as_profile_v2",
  USERS:"as_users_v2",
  SESSION:"as_session_v2"
};

/* State */
let rows=[], template=[], complaints=[], rules=[], audit=[];
let profile={username:"", role:"Operator", region:"", division:""};
let settings={ defaultPeriod:"monthly", allowDelete:"role" };
let charts={}, alertTimer=null;

/* =================== Theme (fixed light — no toggle) =================== */
function loadTheme(){ /* kept for future; currently always light */ }

/* =================== Auth =================== */
function enc(s){return new TextEncoder().encode(s)}
async function sha256(text){
  try{
    if (window.crypto && crypto.subtle) {
      const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(text));
      return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
    }
  }catch(e){ /* ignore and fall back */ }
  // Fallback for non-HTTPS or blocked crypto: mark as plain
  return "PLAIN:" + text;
}

function seedUsersIfEmpty(){
  const cur = JSON.parse(localStorage.getItem(LS.USERS)||"[]");
  if(cur.length) return; // already seeded

  const seeds=[
    {u:"superadmin",r:"Superadmin",p:"Super@123"},
    {u:"admin",r:"Admin",p:"Admin@123"},
    {u:"supervisor",r:"Supervisor",p:"Supv@123"},
    {u:"operator",r:"Operator",p:"Oper@123"},
    {u:"viewer",r:"Viewer",p:"View@123"}
  ];

  Promise.all(seeds.map(async s=>({
    user: s.u,
    role: s.r,
    hash: await sha256(s.p)   // uses secure or fallback hashing depending on context
  }))).then(list => localStorage.setItem(LS.USERS, JSON.stringify(list)));
}


function showApp(show){
  $("loginScreen").classList.toggle("hidden", show);
  $("appHeader").classList.toggle("hidden", !show);
  $("tabsShell").classList.toggle("hidden", !show);   // tabs row sits BELOW header
  $("appMain").classList.toggle("hidden", !show);
}
function togglePw(){ const i=$("lgPass"); i.type = (i.type==="password"?"text":"password"); }
function clearLogin(){ $("lgUser").value=""; $("lgPass").value=""; }
function showLgErr(msg){ const el=$("lgErr"); el.textContent=msg; el.classList.remove("hidden"); setTimeout(()=>el.classList.add("hidden"),4000); }

function startChangePassword(){
  showLgErr("Change password will be enabled in Phase 2 (server-backed).");
}
function startForgot(){
  showLgErr("Forgot password will be enabled in Phase 2 (email/OTP).");
}
  
async function doLogin(){
  const u = $("lgUser").value.trim(), p = $("lgPass").value;
  const users = JSON.parse(localStorage.getItem(LS.USERS) || "[]");
  const found = users.find(x => x.user === u);
  if (!found) return showLgErr("Invalid username or password.");

  const h = await sha256(p);

  // Accept both hashed and fallback ("PLAIN:password") user records
  if (found.hash.startsWith("PLAIN:")) {
    if ("PLAIN:" + p !== found.hash) return showLgErr("Invalid username or password.");
  } else {
    if (h !== found.hash) return showLgErr("Invalid username or password.");
  }

  // Success → set session/profile
  profile.username = u; 
  profile.role = found.role;
  localStorage.setItem(LS.PROFILE, JSON.stringify(profile));
  localStorage.setItem(LS.SESSION, JSON.stringify({ user: u, ts: Date.now() }));

  $("chipUser").textContent = u;
  showApp(true); buildTabs(); applyRole(); refreshAll();
  logAudit("auth.login", { user: u });
}

function doLogout(){ localStorage.removeItem(LS.SESSION); logAudit("auth.logout",{user:profile.username}); location.reload(); }

/* =================== Load/Save =================== */
function loadAll(){
  rows=JSON.parse(localStorage.getItem(LS.ROWS)||"[]");
  template=JSON.parse(localStorage.getItem(LS.TEMPLATE)||"null") || DEFAULT_COLUMNS.map(k=>({key:k,label:k,enabled:true}));
  complaints=JSON.parse(localStorage.getItem(LS.COMPLAINTS)||"[]");
  if(complaints.length && !complaints[0].timeline){
    complaints = complaints.map(c=>({
      article:c.article, type:c.type, status:c.status||"Open",
      timeline:[{ts:c.ts||new Date().toISOString(), note:c.desc||""}]
    }));
    localStorage.setItem(LS.COMPLAINTS, JSON.stringify(complaints));
  }
  rules=JSON.parse(localStorage.getItem(LS.RULES)||"[]");
  audit=JSON.parse(localStorage.getItem(LS.AUDIT)||"[]");
  Object.assign(settings, JSON.parse(localStorage.getItem(LS.SETTINGS)||"{}"));
}
function persist(){ localStorage.setItem(LS.ROWS, JSON.stringify(rows)); }
function saveTemplate(){ localStorage.setItem(LS.TEMPLATE, JSON.stringify(template)); }
function saveComplaints(){ localStorage.setItem(LS.COMPLAINTS, JSON.stringify(complaints)); }
function saveRules(){ localStorage.setItem(LS.RULES, JSON.stringify(rules)); }
function saveAudit(){ localStorage.setItem(LS.AUDIT, JSON.stringify(audit)); }
function persistSettings(){
  settings.defaultPeriod = $("defaultPeriod").value;
  settings.allowDelete = $("allowDelete").value;
  localStorage.setItem(LS.SETTINGS, JSON.stringify(settings));
  logAudit("settings.update", settings);
  refreshAll();
}
function persistProfile(){
  profile.region = $("scopeRegion").value;
  profile.division = $("scopeDivision").value;
  localStorage.setItem(LS.PROFILE, JSON.stringify(profile));
}

/* =================== RBAC =================== */
function roleLevel(){ return ROLE[profile.role] ?? ROLE.Operator; }
function can(action){
  const lvl = roleLevel();
  const matrix = {
    import:1, manualAdd:1, bulkUpdate:1,
    delete: (settings.allowDelete==="always")?0:(settings.allowDelete==="never"?99:3),
    templateEdit:3, rulesEdit:3,
    auditClear:4, seeAudit:4, seeSettings:3
  };
  return lvl >= (matrix[action] ?? 99);
}
function applyRole(){
  $("chipUser").textContent = profile.username || "—";
  // KPIs only for Admin & Superadmin
  const isAdminPlus = (ROLE[profile.role] >= ROLE.Admin);
  toggleTab("KPIs", isAdminPlus);

  toggleTab("Audit", can("seeAudit"));
  toggleTab("Settings", can("seeSettings"));
  const delBtn=$("btnDelete"); if(delBtn) delBtn.classList.toggle("hidden", !can("delete"));
  buildTemplateEditor();
}
function toggleTab(name, show){
  const allTabs=[...document.querySelectorAll("#tabs .tab")];
  const btn=allTabs.find(b=>b.textContent===name);
  const sec=document.querySelector(`[data-tab="${name}"]`);
  if(btn) btn.classList.toggle("hidden", !show);
  if(sec) sec.classList.toggle("hidden", !show);
}

/* =================== Tabs =================== */
const TAB_ORDER = ["Dashboard","KPIs","Data management","Bulk View & Update","Reports","Complaints","SLA Rules","Audit","Settings"];
function buildTabs(){
  const host=$("tabs"); host.innerHTML="";
  TAB_ORDER.forEach((name,i)=>{
    const b=document.createElement("button");
    b.className="tab"+(i===0?" active":"");
    b.textContent=name;
    b.onclick=()=>activateTab(name,b);
    host.appendChild(b);
  });
  activateTab("Dashboard", host.children[0]);
}
function activateTab(name, btn){
  document.querySelectorAll("#tabs .tab").forEach(t=>t.classList.remove("active"));
  if(btn) btn.classList.add("active");

  document.querySelectorAll("[data-tab]").forEach(sec=>{
    sec.style.display = (sec.getAttribute("data-tab")===name) ? "block" : "none";
  });

  // NEW: initialize the KPI sub-UI the first time KPIs tab is opened
  if (name === "KPIs") { initKpiTabOnce(); }
}


/* =================== INLINE FILTERS — FIXED =================== */
/* Build a filter row with inputs carrying data-col=<absolute column index>.
   Filtering reads each input's data-col so action/checkbox columns don't shift indices. */
function addInlineFilters(tableEl){
  const thead = tableEl.querySelector("thead");
  if(!thead) return;
  // Remove existing filter row if rebuilding
  const prev = thead.querySelector("tr.filter-row"); if(prev) prev.remove();

  const headerCells = [...thead.querySelectorAll("tr:first-child th")];
  const filterTr = document.createElement("tr"); filterTr.className="filter-row";

  headerCells.forEach((th, idx)=>{
    const fth = document.createElement("th");
    const headerText = th.textContent.trim().toLowerCase();
    const isCheckbox = th.querySelector('input[type="checkbox"]') || headerText==="#" || headerText==="details";
    if(isCheckbox){
      // Keep a placeholder (no input) to preserve correct column count
      fth.innerHTML = ""; // no input
    }else{
      fth.innerHTML = `<input class="inline-filter" data-col="${idx}" placeholder="Filter…">`;
    }
    filterTr.appendChild(fth);
  });
  thead.appendChild(filterTr);

  // Hook inputs
  thead.querySelectorAll(".inline-filter").forEach(inp=>{
    inp.addEventListener("input", ()=>applyTableFilters(tableEl));
  });
}
function applyTableFilters(tableEl){
  const thead = tableEl.querySelector("thead");
  const inputs = [...thead.querySelectorAll(".inline-filter")];
  const tbody = tableEl.querySelector("tbody");
  if(!tbody) return;
  const rowsTR = [...tbody.querySelectorAll("tr")];

  rowsTR.forEach(tr=>{
    const tds=[...tr.children];
    let ok=true;
    for(const inp of inputs){
      const f = inp.value.trim().toLowerCase();
      if(!f) continue;
      const colIdx = +inp.dataset.col;
      const td = tds[colIdx];
      const txt = (td?.textContent || "").toLowerCase();
      if(!txt.includes(f)){ ok=false; break; }
    }
    tr.style.display = ok ? "" : "none";
  });
}

/* =================== Alerts (in tabs row, right) =================== */
function computeAlerts(){
  const missing = rows.filter(r => REQUIRED.some(k=>!String(r[k]||"").trim()));
  const dupKeys = new Set(), seen=new Set();
  rows.forEach(r=>{
    const k=String(r["article-number"]||"");
    if(!k) return;
    if(seen.has(k)) dupKeys.add(k); else seen.add(k);
  });
  const aged = rows.filter(r=>{
    const st=(r["DELIVERY STATUS"]||"").toUpperCase();
    if(st==="DELIVERED"||st==="EXCEPTION") return false;
    const d = dayjs(r["booking-date-time"]);
    if(!d.isValid()) return false;
    return dayjs().diff(d,"hour") > slaHoursFor(r);
  });
  return [
    {label:`Missing required fields: ${missing.length}`, action:()=>{ activateTab("Reports", document.querySelector('#tabs .tab:nth-child(4)')); $("reportType").value="exceptions"; buildReport(); }},
    {label:`Duplicate article-number: ${dupKeys.size}`, action:()=>{ activateTab("Reports", document.querySelector('#tabs .tab:nth-child(4)')); $("reportType").value="exceptions"; buildReport(); }},
    {label:`Aged pending (> SLA): ${aged.length}`, action:()=>{ activateTab("Bulk View & Update", document.querySelector('#tabs .tab:nth-child(3)')); }}
  ];
}
function renderAlertsHeader(){
  const menu=$("alertMenu");
  const items=computeAlerts();
  menu.innerHTML = items.map(i=>`<div class="row" style="justify-content:space-between; padding:6px 4px;">
    <div>${i.label}</div><button class="btn gray" style="padding:4px 8px">Go</button>
  </div>`).join("");
  const total=items.reduce((a,i)=> a + (parseInt(i.label.match(/(\d+)/)?.[1]||0)), 0);
  const c=$("alertCount");
  if(total>0){ c.textContent=total; c.classList.remove("hidden"); } else { c.classList.add("hidden"); }
  [...menu.querySelectorAll(".row")].forEach((el,idx)=> el.querySelector("button").onclick=()=>{ items[idx].action(); menu.classList.add("hidden"); });
}
$("alertBtn").onclick = ()=>{ $("alertMenu").classList.toggle("hidden"); };

/* =================== Data Management: Template & Manual Entry =================== */
function buildTemplateEditor(){
  const host=$("templateEditor"); if(!host) return; host.innerHTML="";
  template.forEach((col,idx)=>{
    const card=document.createElement("div"); card.className="card";
    const disabled=!can("templateEdit");
    card.innerHTML=`<div class="row" style="justify-content:space-between">
      <strong>${col.key}</strong>
      <label class="row">Enabled <input type="checkbox" ${col.enabled?"checked":""} data-idx="${idx}" ${disabled?"disabled":""}></label>
    </div>
    <div class="row"><label class="grow">Label <input data-lbl="${idx}" value="${col.label}" ${disabled?"disabled":""}></label></div>
    <div class="row">
      <button class="btn gray" data-up="${idx}" ${disabled?"disabled":""}>↑</button>
      <button class="btn gray" data-down="${idx}" ${disabled?"disabled":""}>↓</button>
      <button class="btn red" data-del="${idx}" ${disabled?"disabled":""}>Remove</button>
    </div>`;
    host.appendChild(card);
  });
  if(!can("templateEdit")) return;
  host.querySelectorAll("input[type=checkbox]").forEach(ch=> ch.onchange=(e)=>{ const i=+e.target.dataset.idx; template[i].enabled=e.target.checked; saveTemplate(); refreshAll(); logAudit("template.toggle",{key:template[i].key,enabled:e.target.checked});});
  host.querySelectorAll("[data-lbl]").forEach(inp=> inp.oninput=(e)=>{ const i=+e.target.dataset.lbl; template[i].label=e.target.value; saveTemplate(); logAudit("template.label",{key:template[i].key,label:e.target.value});});
  host.querySelectorAll("[data-up]").forEach(b=> b.onclick=()=>{ const i=+b.dataset.up; if(i>0){[template[i-1],template[i]]=[template[i],template[i-1]]; saveTemplate(); buildTemplateEditor(); refreshAll(); logAudit("template.reorder",{from:i,to:i-1});}});
  host.querySelectorAll("[data-down]").forEach(b=> b.onclick=()=>{ const i=+b.dataset.down; if(i<template.length-1){[template[i+1],template[i]]=[template[i],template[i+1]]; saveTemplate(); buildTemplateEditor(); refreshAll(); logAudit("template.reorder",{from:i,to:i+1});}});
  host.querySelectorAll("[data-del]").forEach(b=> b.onclick=()=>{ const i=+b.dataset.del; if(!confirm(`Remove ${template[i].key}?`)) return; const key=template[i].key; template.splice(i,1); saveTemplate(); buildTemplateEditor(); refreshAll(); logAudit("template.remove",{key});});
}

function buildManualForm(){
  const host=$("manualForm"); if(!host) return; host.innerHTML="";
  template.filter(c=>c.enabled).forEach(col=>{
    const el=document.createElement("label"); el.className="grow";
    const ph=col.label||col.key; const type=/date/i.test(col.key)?"datetime-local":"text";
    el.innerHTML=`<div style="font-size:12px;color:var(--muted);margin-bottom:4px">${ph}${REQUIRED.includes(col.key)?" *":""}</div>
      <input name="${col.key}" placeholder="${ph}" type="${type}"/>`;
    host.appendChild(el);
  });
}
function saveManual(e){
  if(e) e.preventDefault();
  if(!can("manualAdd")) return alert("Not allowed by role.");
  const form=$("manualForm");
  const rec={};
  template.filter(c=>c.enabled).forEach(c=>{
    let v=(form.querySelector(`[name="${c.key}"]`)?.value ?? "").trim();
    if(c.key==="DELIVERY STATUS") v=v.toUpperCase();
    rec[c.key]=v;
  });
  const miss=REQUIRED.filter(k=>!String(rec[k]||"").trim());
  if(miss.length) return alert("Missing: "+miss.join(", "));
  const k=String(rec["article-number"]||"");
  if(k && rows.some(r=>String(r["article-number"]||"")===k)){
    if(!confirm("Duplicate article-number. Add anyway?")) return;
  }
  rec._batchId="Manual_"+new Date().toISOString();
  rec._batchType="manual";
  rows.push(rec); persist(); form.reset(); refreshAll();
  logAudit("manual.add",{article:k}); alert("Saved.");
}

/* =================== Browse / Bulk View =================== */
function buildOptions(){
  const regs=[...new Set(rows.map(r=>r.Region).filter(Boolean))].sort();
  const divs=[...new Set(rows.map(r=>r.Division).filter(Boolean))].sort();
  $("scopeRegion").innerHTML='<option value="">All</option>'+regs.map(x=>`<option ${x===profile.region?"selected":""}>${x}</option>`).join("");
  $("scopeDivision").innerHTML='<option value="">All</option>'+divs.map(x=>`<option ${x===profile.division?"selected":""}>${x}</option>`).join("");
}
function scopeFilter(r){
  if(profile.region && r.Region!==profile.region) return false;
  if(profile.division && r.Division!==profile.division) return false;
  return true;
}

function renderTable(){
  const cols = template.filter(c=>c.enabled).map(c=>c.key);
  const tbl = $("dataTable");
  tbl.innerHTML = "";

  // Header
  const thead = document.createElement("thead");
  const ths = ["<th><input type='checkbox' onclick='toggleAll(this)'></th>",
               "<th>Details</th>",
               ...cols.map(k=>`<th>${k}</th>`)].join("");
  thead.innerHTML = `<tr>${ths}</tr>`;
  tbl.appendChild(thead);

  // Body
  const tbody = document.createElement("tbody");
  rows.filter(scopeFilter).forEach((r, idx)=>{
    const status = String(r["DELIVERY STATUS"]||"").toUpperCase();
    const cls = status==="DELIVERED"?"delivered":status==="IN-TRANSIT"?"intransit":status==="EXCEPTION"?"exception":"pending";
    let html = `<td><input type="checkbox" data-id="${idx}"></td>`;
    html += `<td><a href="javascript:void(0)" onclick='showDetails(${idx})'>ℹ️</a></td>`;
    cols.forEach(c=>{
      let v = r[c] ?? "";
      if(c==="DELIVERY STATUS") v = `<span class="pill ${cls}">${status||"—"}</span>`;
      html += `<td>${v}</td>`;
    });
    const tr = document.createElement("tr");
    tr.innerHTML = html;
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);

  // Add inline filter row & hook (fixed)
  addInlineFilters(tbl);
}

function toggleAll(master){
  document.querySelectorAll('#dataTable tbody input[type="checkbox"]').forEach(ch=> ch.checked=master.checked);
}
function showDetails(idx){
  const r = rows[idx];
  const keys = template.filter(c=>c.enabled).map(c=>c.key);
  const msg = keys.map(k=>`${k}: ${r[k]??""}`).join("\n");
  alert(`Record (Batch: ${r._batchId||"—"}):\n\n${msg}`);
}
function applyBulk(){
  if(!can("bulkUpdate")) return alert("Not allowed by role.");
  const status=$("bulkStatus").value;
  const d=$("bulkDate").value;
  const ids=[...document.querySelectorAll('#dataTable tbody input[type="checkbox"]:checked')].map(ch=>+ch.dataset.id);
  if(!ids.length) return alert("Select rows first.");
  ids.forEach(i=>{ if(status) rows[i]["DELIVERY STATUS"]=status; if(d) rows[i]["DELIVERY DATE"]=d; });
  persist(); refreshAll();
  logAudit("bulk.update",{count:ids.length,status,date:d});
  alert("Bulk update applied.");
}
function deleteSelected(){
  if(!can("delete")) return alert("Not allowed by role.");
  const ids=new Set([...document.querySelectorAll('#dataTable tbody input[type="checkbox"]:checked')].map(ch=>+ch.dataset.id));
  if(!ids.size) return alert("Select rows first.");
  if(!confirm(`Delete ${ids.size} selected row(s)?`)) return;
  rows=rows.filter((_,idx)=>!ids.has(idx));
  persist(); refreshAll(); logAudit("rows.delete",{count:ids.size});
}

/* Export (Browse) */
function exportTable(fmt){
  const cols = template.filter(c=>c.enabled).map(c=>c.key);
  const data = rows.filter(scopeFilter).map(r=>{ const o={}; cols.forEach(k=>o[k]=r[k]??""); o._batchId=r._batchId||""; return o; });
  if(fmt==="csv"){
    const ws=XLSX.utils.json_to_sheet(data);
    const csv=XLSX.utils.sheet_to_csv(ws);
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="browse_export.csv"; a.click();
  }else{
    const ws=XLSX.utils.json_to_sheet(data);
    const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Browse"); XLSX.writeFile(wb,"browse_export.xlsx");
  }
}

/* =================== Reports (with inline filters) =================== */
function countBy(key, arr){ const map={}; (arr||rows).forEach(r=>{ const k=r[key]||"—"; map[k]=(map[k]||0)+1; }); return Object.entries(map).sort((a,b)=>a[0].localeCompare(b[0])); }
function slaHoursFor(r){ const look=[["CUSTOMER",r["customer-id"]],["ARTICLE-TYPE",r["article-type"]],["DIVISION",r["Division"]],["REGION",r["Region"]],["GLOBAL","GLOBAL"]]; for(const [scope,key] of look){ const hit=rules.find(x=>x.scope===scope && String(x.key||"")===String(key||"")); if(hit) return +hit.hours; } return 72; }

function buildReport(){
  const host=$("reportTable"); host.innerHTML="";
  const makeRow=arr=>"<tr>"+arr.map(x=>`<td>${x}</td>`).join("")+"</tr>";
  const inScope=rows.filter(scopeFilter);
  const type=document.getElementById("reportType").value;

  if(type==="summary"){
    const total=inScope.length;
    const byStatus=["DELIVERED","IN-TRANSIT","PENDING","EXCEPTION"].map(s=>[s,inScope.filter(r=>String(r["DELIVERY STATUS"]||"").toUpperCase()===s).length]);
    const byRegion=countBy("Region",inScope);
    const byDivision=countBy("Division",inScope);
    host.innerHTML=`<thead><tr><th>Metric</th><th>Value</th></tr></thead>
      <tbody>
        ${makeRow(["Total",total])}
        ${byStatus.map(x=>makeRow(x)).join("")}
        <tr><th colspan="2">By Region</th></tr>
        ${byRegion.map(x=>makeRow(x)).join("")}
        <tr><th colspan="2">By Division</th></tr>
        ${byDivision.map(x=>makeRow(x)).join("")}
      </tbody>`;
  }else if(type==="trend"){
    const period=settings.defaultPeriod;
    const buckets={};
    inScope.forEach(r=>{
      const d=dayjs(r["booking-date-time"]); if(!d.isValid()) return;
      let key=d.format("YYYY-MM-DD");
      if(period==="weekly") key=d.startOf("week").format("YYYY-[W]WW");
      if(period==="monthly") key=d.format("YYYY-MM");
      if(period==="quarterly") key=d.format("YYYY-[Q]Q");
      if(period==="annual") key=d.format("YYYY");
      buckets[key]=(buckets[key]||0)+1;
    });
    const keys=Object.keys(buckets).sort();
    host.innerHTML=`<thead><tr><th>Period</th><th>Articles</th></tr></thead>
      <tbody>${keys.map(k=>makeRow([k,buckets[k]])).join("")}</tbody>`;
  }else if(type==="exceptions"){
    const missing=inScope.filter(r=> REQUIRED.some(k=>!String(r[k]||"").trim()));
    const seen=new Set(); const dups=[];
    inScope.forEach(r=>{ const k=String(r["article-number"]||""); if(!k) return; if(seen.has(k)) dups.push(r); else seen.add(k); });
    const aged=inScope.filter(r=>{
      const st=String(r["DELIVERY STATUS"]||"").toUpperCase(); if(st==="DELIVERED"||st==="EXCEPTION") return false;
      const d=dayjs(r["booking-date-time"]); if(!d.isValid()) return false;
      return dayjs().diff(d,"hour")>slaHoursFor(r);
    });
    host.innerHTML=`<thead><tr><th>Exception</th><th>Count</th></tr></thead>
      <tbody>${makeRow(["Missing requireds",missing.length])}${makeRow(["Duplicates (article-number)",dups.length])}${makeRow(["Aged pending (> SLA)",aged.length])}</tbody>`;
  }else if(type==="performance"){
    const delivered=inScope.filter(r=>String(r["DELIVERY STATUS"]||"").toUpperCase()==="DELIVERED");
    const deltas=delivered.map(r=>{
      const b=dayjs(r["booking-date-time"]); const d=dayjs(r["DELIVERY DATE"]);
      if(!b.isValid()||!d.isValid()) return null; return d.diff(b,"hour");
    }).filter(x=>x!=null);
    const avg=deltas.length?Math.round(deltas.reduce((a,b)=>a+b,0)/deltas.length):0;
    host.innerHTML=`<thead><tr><th>Metric</th><th>Value</th></tr></thead>
      <tbody>${makeRow(["Delivered count",delivered.length])}${makeRow(["Avg hours to deliver",avg])}</tbody>`;
  }else if(type==="compliance"){
    const aptMissing=inScope.filter(r=> String(r["APT 2.O updation"]||"").trim()==="");
    const mandatoryMissing=inScope.filter(r=> REQUIRED.some(k=>!String(r[k]||"").trim()));
    host.innerHTML=`<thead><tr><th>Check</th><th>Fail Count</th></tr></thead>
      <tbody>${makeRow(["APT 2.0 empty",aptMissing.length])}${makeRow(["Mandatory empty",mandatoryMissing.length])}</tbody>`;
  }else{
    const cols=template.filter(c=>c.enabled).map(c=>c.key);
    const head="<thead><tr>"+cols.map(c=>`<th>${c}</th>`).join("")+"</tr></thead>";
    const body="<tbody>"+inScope.map(r=>"<tr>"+cols.map(c=>`<td>${r[c]??""}</td>`).join("")+"</tr>").join("")+"</tbody>";
    host.innerHTML=head+body;
  }
  addInlineFilters($("reportTable"));
}
function reportExport(fmt){
  const tbl=$("reportTable");
  if(!tbl.rows.length) return alert("Build a report first.");
  const headers=[...tbl.querySelectorAll("thead tr:first-child th")].map(th=>th.textContent);
  const body=[...tbl.querySelectorAll("tbody tr")].filter(tr=>tr.style.display!=="none")
    .map(tr=>[...tr.children].map(td=>td.textContent));
  if(fmt==="pdf"){
    const {jsPDF}=window.jspdf; const doc=new jsPDF({orientation:"landscape"});
    doc.text("Report",14,12); doc.autoTable({head:[headers],body,startY:16,styles:{fontSize:8}}); doc.save("report.pdf");
  } else if(fmt==="xlsx"){
    const json=body.map(row=>Object.fromEntries(row.map((v,i)=>[headers[i],v])));
    const ws=XLSX.utils.json_to_sheet(json); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Report"); XLSX.writeFile(wb,"report.xlsx");
  } else {
    const ws=XLSX.utils.aoa_to_sheet([headers,...body]); const csv=XLSX.utils.sheet_to_csv(ws);
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="report.csv"; a.click();
  }
}

/* =================== Complaints =================== */
function toggleCustomIssue(){
  const sel=$("cmpType"); const cust=$("cmpTypeCustom");
  cust.classList.toggle("hidden", sel.value!=="Other/Custom");
}
function toggleCustomIssueBulk(){
  const sel=$("cmpBulkType"); const cust=$("cmpBulkTypeCustom");
  cust.classList.toggle("hidden", sel.value!=="Other/Custom");
}
function toggleRowBulkCustom(){
  const sel=$("cmpRowBulkStatus"); const cust=$("cmpRowBulkStatusCustom");
  cust.classList.toggle("hidden", sel.value!=="Other/Custom");
}
function pillForStatus(s){
  const map={Open:'#f59e0b','In-Progress':'#60a5fa',Escalated:'#ef4444',Resolved:'#16a34a',Closed:'#6b7280','Re-opened':'#c2410c'};
  const c=map[s]||'#6b7280';
  return `<span class="pill" style="border-color:${c};color:${c}">${s}</span>`;
}
function renderComplaints(){
  const tbl=$("cmpTable");
  tbl.innerHTML=`<thead><tr>
    <th><input type="checkbox" onclick="toggleAllCmp(this)"></th>
    <th>Article</th><th>Issue type</th><th>Status</th><th>Updates/Remarks</th>
  </tr></thead><tbody>`+
  complaints.map((c,i)=>`<tr>
    <td><input type="checkbox" data-id="${i}"></td>
    <td>${c.article}</td>
    <td>${c.type}</td>
    <td>${pillForStatus(c.status||"Open")}</td>
    <td>${(c.timeline||[]).map(ev=>`<div>• ${(ev.date||ev.ts||"").toString()} — ${ev.note||""}</div>`).join("")}</td>
  </tr>`).join("") + `</tbody>`;
  addInlineFilters(tbl);
}
function toggleAllCmp(master){
  document.querySelectorAll('#cmpTable tbody input[type="checkbox"]').forEach(ch=> ch.checked=master.checked);
}
function addComplaint(){
  const article=$("cmpArticle").value.trim();
  let type=$("cmpType").value;
  if(type==="Other/Custom") type=$("cmpTypeCustom").value.trim();
  const note=$("cmpDesc").value.trim();
  const status=$("cmpStatus").value;
  const dateVal=$("cmpDate").value;

  if(!article) return alert("article-number is required.");
  if(!type) return alert("Issue type is required.");

  const idx = complaints.findIndex(c=>c.article===article);
  const event = {date: dateVal || new Date().toLocaleDateString(), ts:new Date().toLocaleString(), note};

  if(idx>=0){
    complaints[idx].type = type;
    complaints[idx].status = status;
    complaints[idx].timeline = complaints[idx].timeline || [];
    complaints[idx].timeline.push(event);
  }else{
    complaints.push({article, type, status, timeline:[event]});
  }
  saveComplaints(); renderComplaints();
  $("cmpArticle").value=""; $("cmpType").value=""; $("cmpTypeCustom").value=""; $("cmpDate").value=""; $("cmpDesc").value="";
  $("cmpTypeCustom").classList.add("hidden");
  logAudit("complaint.upsert",{article,status});
}

/* Bulk apply same issue to multiple pasted articles */
function parseBulkArticles(txt){
  return txt.split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
}
function addComplaintBulk(){
  const list=parseBulkArticles($("cmpBulkArticles").value||"");
  if(!list.length) return alert("Paste article numbers first.");
  let type=$("cmpBulkType").value;
  if(type==="Other/Custom") type=$("cmpBulkTypeCustom").value.trim();
  if(!type) return alert("Choose an Issue type.");
  const dateVal=$("cmpBulkDate").value;
  const note=$("cmpBulkDesc").value.trim();
  let status=$("cmpBulkStatus").value;
  if(status==="Other/Custom") status=$("cmpBulkStatusCustom").value.trim()||"Open";

  const ev = {date: dateVal || new Date().toLocaleDateString(), ts:new Date().toLocaleString(), note};
  list.forEach(article=>{
    const idx = complaints.findIndex(c=>c.article===article);
    if(idx>=0){
      complaints[idx].type=type; complaints[idx].status=status;
      complaints[idx].timeline = complaints[idx].timeline||[]; complaints[idx].timeline.push(ev);
    }else{
      complaints.push({article, type, status, timeline:[ev]});
    }
  });
  saveComplaints(); renderComplaints(); logAudit("complaint.bulkAdd",{count:list.length,type,status});
  alert(`Applied to ${list.length} article(s).`);
}
function clearComplaintBulk(){
  $("cmpBulkArticles").value=""; $("cmpBulkType").value=""; $("cmpBulkTypeCustom").value="";
  $("cmpBulkDate").value=""; $("cmpBulkDesc").value="";
  $("cmpBulkStatus").value=""; $("cmpBulkStatusCustom").value="";
  $("cmpBulkTypeCustom").classList.add("hidden"); $("cmpBulkStatusCustom").classList.add("hidden");
}

/* Bulk change status for selected complaint rows (with Other/Custom) */
function applyComplaintBulk(){
  let s=$("cmpRowBulkStatus").value;
  if(!s) return alert("Choose a status.");
  if(s==="Other/Custom") s=$("cmpRowBulkStatusCustom").value.trim()||"Open";
  const ids=[...document.querySelectorAll('#cmpTable tbody input[type="checkbox"]:checked')].map(ch=>+ch.dataset.id);
  ids.forEach(i=> complaints[i].status=s);
  saveComplaints(); renderComplaints(); logAudit("complaint.bulkStatus",{count:ids.length,status:s});
}

/* Export complaints */
function exportComplaints(){
  const ws=XLSX.utils.json_to_sheet(complaints.map(c=>({
    article:c.article, type:c.type, status:c.status,
    timeline:(c.timeline||[]).map(ev=>`${(ev.date||"")} ${ev.ts?`(${ev.ts})`:""}: ${ev.note}`).join(" | ")
  })));
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Complaints"); XLSX.writeFile(wb,"complaints.xlsx");
}

/* =================== SLA Rules & Audit (with inline filters) =================== */
function buildRuleTable(){
  const tbl=$("ruleTable");
  tbl.innerHTML=`<thead><tr><th>Scope</th><th>Key</th><th>SLA (h)</th><th>#</th></tr></thead>
    <tbody>`+ rules.map((r,i)=>`<tr>
      <td>${r.scope}</td><td>${r.key}</td><td>${r.hours}</td>
      <td><button class="btn red" onclick="delRule(${i})" ${can("rulesEdit")?"":"disabled"}>Delete</button></td>
    </tr>`).join("")+`</tbody>`;
  addInlineFilters(tbl);
}
function addRule(){
  if(!can("rulesEdit")) return alert("Not allowed by role.");
  const scope=$("ruleScope").value;
  const key=$("ruleKey").value.trim()||(scope==="GLOBAL"?"GLOBAL":"");
  const hours=+($("ruleHours").value||"0");
  if(!hours) return alert("Enter SLA hours.");
  const i=rules.findIndex(r=>r.scope===scope && String(r.key)===String(key));
  const rec={scope,key,hours};
  if(i>=0) rules[i]=rec; else rules.push(rec);
  saveRules(); buildRuleTable(); refreshAll();
  logAudit("rules.upsert",{scope,key,hours});
}
function delRule(i){
  if(!can("rulesEdit")) return alert("Not allowed by role.");
  const {scope,key}=rules[i]||{};
  rules.splice(i,1); saveRules(); buildRuleTable(); refreshAll();
  logAudit("rules.delete",{scope,key});
}
function resetRules(){
  if(!can("rulesEdit")) return alert("Not allowed by role.");
  rules=[{scope:"GLOBAL",key:"GLOBAL",hours:72}]; saveRules(); buildRuleTable(); refreshAll();
  logAudit("rules.reset",{});
}

function logAudit(event,detail){
  const row={ts:new Date().toISOString(), user:profile.username, role:profile.role, region:profile.region, division:profile.division, event, detail};
  audit.unshift(row); saveAudit(); renderAudit();
}
function renderAudit(){
  const tbl=$("auditTable");
  tbl.innerHTML=`<thead><tr><th>Timestamp</th><th>User</th><th>Role</th><th>Region</th><th>Division</th><th>Event</th><th>Detail</th></tr></thead>
    <tbody>`+ audit.map(a=>`<tr>
      <td>${a.ts}</td><td>${a.user||"—"}</td><td>${a.role}</td>
      <td>${a.region||"—"}</td><td>${a.division||"—"}</td>
      <td>${a.event}</td><td>${JSON.stringify(a.detail||{})}</td>
    </tr>`).join("") + `</tbody>`;
  addInlineFilters(tbl);
}

/* =================== Import: Self-hosted XLSX + CSV fallback =================== */
async function ensureXLSX(){ return !!window.XLSX; } // local file loaded in <head>

/* Lightweight RFC4180 CSV parser */
function parseCSV(text){
  const rows = [];
  let row = [], field = '';
  let i = 0, inQuotes = false;
  while (i < text.length){
    const c = text[i];
    if (inQuotes){
      if (c === '"'){
        if (text[i+1] === '"'){ field += '"'; i += 2; continue; }
        inQuotes = false; i++; continue;
      } else { field += c; i++; continue; }
    } else {
      if (c === '"'){ inQuotes = true; i++; continue; }
      if (c === ','){ row.push(field); field = ''; i++; continue; }
      if (c === '\r'){ if (text[i+1] === '\n') i++; row.push(field); rows.push(row); row = []; field = ''; i++; continue; }
      if (c === '\n'){ row.push(field); rows.push(row); row = []; field = ''; i++; continue; }
      field += c; i++;
    }
  }
  row.push(field); rows.push(row);
  if (rows.length && rows[rows.length-1].length === 1 && rows[rows.length-1][0] === '') rows.pop();
  return rows;
}

window.handleFile = async function handleFile(){
  try {
    const input = $("fileInput");
    const f = input && input.files && input.files[0];
    if(!f) { alert("Choose a file first."); return; }

    const isCSV = /\.csv$/i.test(f.name) || (f.type && f.type.includes('csv'));
    const xlsxReady = await ensureXLSX();

    if (isCSV || !xlsxReady){
      const reader = new FileReader();
      reader.onerror = () => alert("Could not read the CSV file.");
      reader.onload = (e) => {
        try{
          const text = e.target.result;
          const aoa = parseCSV(text);
          if (!aoa.length) throw new Error("CSV appears empty.");
          let headerRow = -1;
          for(let i=0;i<aoa.length;i++){
            const nonEmpty = aoa[i].filter(v => String(v).trim() !== "");
            if(nonEmpty.length >= 3){ headerRow = i; break; }
          }
          if(headerRow === -1) throw new Error("No plausible header row found in CSV.");
          const headers = aoa[headerRow].map(h => String(h||"").trim());
          const rowsAOA = aoa.slice(headerRow+1).filter(r => r.some(v => String(v).trim() !== ""));
          const arr = rowsAOA.map(r => { const o={}; headers.forEach((h,idx)=> o[h] = r[idx] ?? ""); return o; });
          importRows(arr);
        }catch(err){
          console.error("CSV import error:", err);
          alert(`CSV parse error: ${err.message || err}`);
        }
      };
      reader.readAsText(f);
      return;
    }

    const reader = new FileReader();
    reader.onerror = () => alert("Could not read the Excel file.");
    reader.onload = (e) => {
      try{
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, { type: "array", cellDates: true, raw: false });
        let ws = null, chosenSheet = null;
        for(const name of wb.SheetNames){
          const w = wb.Sheets[name];
          if (w && w['!ref']) { ws = w; chosenSheet = name; break; }
        }
        if(!ws) throw new Error("Workbook has no populated sheets.");
        const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "", blankrows: false, raw: false });
        if(!aoa || !aoa.length) throw new Error(`Sheet "${chosenSheet}" is empty.`);
        let headerRow = -1;
        for(let i=0;i<aoa.length;i++){
          const nonEmpty = aoa[i].filter(v => String(v).trim() !== "");
          if(nonEmpty.length >= 3){ headerRow = i; break; }
        }
        if(headerRow === -1) throw new Error(`No plausible header row found in "${chosenSheet}".`);
        const headers = aoa[headerRow].map(h => String(h||"").trim());
        const rowsAOA = aoa.slice(headerRow+1).filter(r => r.some(v => String(v).trim() !== ""));
        const arr = rowsAOA.map(r => { const o={}; headers.forEach((h,idx)=> o[h]=r[idx] ?? ""); return o; });
        importRows(arr);
      }catch(err){
        console.error("Excel import error:", err);
        alert(`File parse error: ${err.message || err}`);
      }
    };
    reader.readAsArrayBuffer(f);

  } catch (e) {
    console.error(e);
    alert(e.message || String(e));
  }
};

function importRows(arr){
  const batchId = $("batchName").value.trim() || ("Batch_"+new Date().toISOString().slice(0,10));
  const batchType = $("batchType").value;
  const mode = $("importMode").value;
  if(mode==="replace" && !confirm("Replace ALL rows?")) return;
  if(mode==="replace") rows = [];

  const enabled = template.filter(c=>c.enabled).map(c=>c.key);
  const aliases = {
    "bookingdatetime":"booking-date-time","booking-date":"booking-date-time",
    "deliverystatus":"DELIVERY STATUS","deliverydate":"DELIVERY DATE",
    "paymentmodedescription":"payment_mode_description","payment-mode-description":"payment_mode_description",
    "paymentmodecode":"payment-mode-code","bookchannelid":"book-channel-id","bookchannelname":"book-channel-name",
    "booktypeid":"book-type-id","booktypename":"book-type-name","customerid":"customer-id","customername":"customer-name",
    "customertypeid":"customer-type-id","customertype":"customer-type","destinationpin":"destination-pin",
    "vpcodtype":"vp-cod-type","vpcodvalue":"vp-cod-value"
  };
  const norm = s=>_normKey(s);
  const normTemplate = enabled.map(k=>({key:k, n:norm(k)}));
  const sample = arr[0] || {};
  const headerMap = {};
  Object.keys(sample).forEach(sc=>{
    const ns = norm(sc);
    const aliasKey = aliases[ns];
    if (aliasKey && enabled.includes(aliasKey)) { headerMap[sc] = aliasKey; return; }
    const exact = normTemplate.find(t=>t.n===ns);
    if (exact) { headerMap[sc]=exact.key; return; }
    const soft = normTemplate.find(t=> t.n.startsWith(ns) || ns.startsWith(t.n));
    headerMap[sc] = soft ? soft.key : sc;
  });

  let dup=0, miss=0, add=0;
  const existing = new Set(rows.map(r=>String(r["article-number"]||"")));

  arr.forEach(src=>{
    const r={};
    for(const [k,v] of Object.entries(src)){
      const mapped = headerMap[k] || k;
      r[mapped] = v;
    }
    r._batchId = batchId; r._batchType = batchType;
    if(r["DELIVERY STATUS"]) r["DELIVERY STATUS"] = String(r["DELIVERY STATUS"]).toUpperCase();
    if(REQUIRED.some(k=>!String(r[k]||"").trim())) miss++;
    const key = String(r["article-number"]||"");
    if(key && existing.has(key)){ dup++; }
    else { if(key) existing.add(key); rows.push(r); add++; }
  });

  persist(); refreshAll();
  logAudit("import", {batchId,batchType,mode,added:add,duplicates:dup,missing:miss});
  alert(`Imported ${add} row(s).\nDuplicates: ${dup}\nMissing requireds flagged: ${miss}\nBatch: ${batchId} (${batchType})`);
}

/* =================== Dashboard / Charts =================== */
function refreshKPIs(){
  const inScope=rows.filter(scopeFilter);
  const total=inScope.length;
  const delivered=inScope.filter(r=>String(r["DELIVERY STATUS"]||"").toUpperCase()==="DELIVERED").length;
  const aged=inScope.filter(r=>{
    const st=String(r["DELIVERY STATUS"]||"").toUpperCase();
    if(st==="DELIVERED"||st==="EXCEPTION") return false;
    const dt=dayjs(r["booking-date-time"]); if(!dt.isValid()) return false;
    return dayjs().diff(dt,"hour")>slaHoursFor(r);
  }).length;
  const exception=inScope.filter(r=>String(r["DELIVERY STATUS"]||"").toUpperCase()==="EXCEPTION").length;
  $("kpiTotal").textContent=total; $("kpiDelivered").textContent=delivered; $("kpiAged").textContent=aged; $("kpiException").textContent=exception;
  applyKpiColoring();   // 🔹 colorize KPI tiles dynamically
}
function chart(id,cfg){ if(charts[id]) charts[id].destroy(); charts[id]=new Chart(document.getElementById(id),cfg); }
function refreshCharts(){
  const inScope=rows.filter(scopeFilter);
  const st=["DELIVERED","IN-TRANSIT","PENDING","EXCEPTION"];
  const cnt=st.map(s=> inScope.filter(r=>String(r["DELIVERY STATUS"]||"").toUpperCase()===s).length);
  chart("chartStatus",{type:"doughnut",data:{labels:st,datasets:[{data:cnt}]},options:{plugins:{legend:{position:"bottom"}}}});
  const regs=[...new Set(inScope.map(r=>r.Region).filter(Boolean))].sort(); const byReg=regs.map(reg=> inScope.filter(r=>r.Region===reg).length);
  chart("chartByRegion",{type:"bar",data:{labels:regs,datasets:[{label:"Articles",data:byReg}]},options:{plugins:{legend:{display:false}}}});
  const map={}; inScope.forEach(r=>{ const d=(String(r["booking-date-time"]||"").substring(0,10))||""; if(!d) return; map[d]=(map[d]||0)+1; }); const dates=Object.keys(map).sort();
  chart("chartTrend",{type:"line",data:{labels:dates,datasets:[{label:"Articles",data:dates.map(d=>map[d])}]},options:{plugins:{legend:{display:false}}}});
  
}

/* =================== Backup / Restore =================== */
function downloadBackup(){
  const payload={rows,template,complaints,settings,rules,audit,profile,ts:new Date().toISOString()};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="article_status_backup.json"; a.click();
}
function restoreBackup(e){
  const f=e.target.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      const o=JSON.parse(reader.result);
      if(o.rows) rows=o.rows;
      if(o.template) template=o.template;
      if(o.complaints) complaints=o.complaints;
      if(o.settings) Object.assign(settings,o.settings);
      if(o.rules) rules=o.rules;
      if(o.audit) audit=o.audit;
      if(o.profile) profile=o.profile;
      persist(); saveTemplate(); saveComplaints(); saveRules(); saveAudit(); persistSettings();
      localStorage.setItem(LS.PROFILE, JSON.stringify(profile));
      refreshAll(); logAudit("backup.restore",{});
      alert("Backup restored.");
    }catch(err){ alert("Invalid JSON."); }
  };
  reader.readAsText(f);
}

/* =================== Init =================== */
function renderAuditIfVisible(){ if(can("seeAudit")) renderAudit(); }
function refreshAll(){
  buildOptions();
  buildManualForm();
  renderTable();
  renderComplaints();
  buildRuleTable();
  renderAuditIfVisible();
  applyDynamicRowColors(document);   // 🔹 color all tables dynamically
  refreshKPIs();
  refreshCharts();
  renderAlertsHeader();

  // NEW: if user is looking at KPIs, re-render them to reflect latest data
  const kpiSection = document.querySelector('[data-tab="KPIs"]');
  if (kpiSection && kpiSection.style.display === "block") {
    renderKpiCards(activeKpiDomain);
  }
}

/* ===== Dynamic Color Coding Helpers ===== */

/* Robust status normalizer */
function normStatus(raw){
  const s = String(raw||'').trim().toUpperCase();
  const c = s.replace(/[\s\-]+/g,'');
  const any = (arr)=>arr.includes(s)||arr.includes(c);
  if (any(['DELIVERED','DEL','DLVD','DELIVERYDONE'])) return 'DELIVERED';
  if (any(['INTRANSIT','IN-TRANSIT','TRANSIT','OFD','OUTFORDELIVERY','DISPATCHED'])) return 'IN-TRANSIT';
  if (any(['EXCEPTION','RTO','RTS','RETURN','RETURNTOORIGIN','LOST','DAMAGE','DAMAGED'])) return 'EXCEPTION';
  return s || 'PENDING';
}

/* Default SLA picker (hours). If you have rules[], wire it here */
function slaHoursForRow(/*row*/) { return 72; }

/* Compute class from status + (optional) booking-date-time aging */
function classFromStatus(statusText, bookingDateText){
  const s = normStatus(statusText);
  if (s === 'EXCEPTION') return 'row-err';
  if (s === 'DELIVERED') return 'row-ok';

  // Pending/Transit aging check
  const d = new Date(bookingDateText || '');
  if (!isNaN(+d)) {
    const hours = (Date.now() - d.getTime()) / 36e5;
    if (hours > slaHoursForRow({})) return 'row-warn';
  }
  return 'row-info';
}

/* Find header indexes by label (case-insensitive) */
function headerIndexMap(tbl){
  const headRow = tbl.querySelector('thead tr') || tbl.querySelector('tr');
  if(!headRow) return {};
  const labels = [...headRow.children].map(th=>String(th.textContent||'').trim().toUpperCase());
  const idx = {};
  labels.forEach((t,i)=> idx[t]=i);
  return idx;
}

/* Apply row colors to any table that has a DELIVERY STATUS column */
function applyDynamicRowColors(root=document){
  const tables = root.querySelectorAll('table');
  tables.forEach(tbl=>{
    const idx = headerIndexMap(tbl);
    const iStatus = idx['DELIVERY STATUS'];
    if (iStatus == null) return; // skip tables without delivery status

    // Accept various booking date header names
    const iBook = [ 'BOOKING-DATE-TIME', 'BOOKING DATE TIME', 'BOOKING DATE', 'BOOKING_DATE' ]
      .map(k=>idx[k]).find(i => i!=null);

    const body = tbl.tBodies[0] || tbl;
    [...body.querySelectorAll('tr')].forEach(tr=>{
      const cells = [...tr.children];
      if (!cells.length) return;
      const statusText = (cells[iStatus]?.textContent||'').trim();
      const bookText = (iBook!=null ? (cells[iBook]?.textContent||'').trim() : '');
      const cls = classFromStatus(statusText, bookText);
      tr.classList.remove('row-ok','row-warn','row-err','row-info');
      tr.classList.add(cls);
    });
  });
}

/* Recolor on DOM changes inside hosts where tables update dynamically */
function attachColorObservers(){
  const targets = [
    document.getElementById('bulkHost'),
    document.getElementById('reportsHost'),
    document.querySelector('[data-tab="Bulk View & Update"]'),
    document.querySelector('[data-tab="Reports"]')
  ].filter(Boolean);

  const obs = new MutationObserver(()=>applyDynamicRowColors(document));
  targets.forEach(t => obs.observe(t, {childList:true, subtree:true}));
}

/* Dashboard KPI tiles coloring (4 quick KPI tiles) */
/* Dashboard KPI tiles coloring (supports both old & new IDs) */
function applyKpiColoring(){
  const tileOf = (id) => {
    const el = document.getElementById(id);
    return el ? el.closest('.tile') : null;
  };
  // Support both ID sets:
  const tTotal     = tileOf('kpiTotal');
  const tDelivered = tileOf('kpiDelivered');
  // Pending / Aged tile (either ID)
  const elPending  = document.getElementById('kpiPendingSla') || document.getElementById('kpiAged');
  const tPending   = elPending ? elPending.closest('.tile') : null;
  // Exceptions tile (either ID)
  const elExc      = document.getElementById('kpiExceptions') || document.getElementById('kpiException');
  const tExcept    = elExc ? elExc.closest('.tile') : null;

  // Reset classes
  [tTotal,tDelivered,tPending,tExcept].forEach(t=>{
    if(!t) return;
    t.classList.remove('k-ok','k-warn','k-err','k-info');
  });

  // Color logic
  if (tDelivered) tDelivered.classList.add('k-ok');

  if (tPending){
    const v = parseInt((elPending?.textContent||'0').replace(/\D+/g,'')) || 0;
    tPending.classList.add(v>0 ? 'k-warn' : 'k-info');
  }

  if (tExcept){
    const v = parseInt((elExc?.textContent||'0').replace(/\D+/g,'')) || 0;
    tExcept.classList.add(v>0 ? 'k-err' : 'k-info');
  }

  if (tTotal) tTotal.classList.add('k-info');
}



function boot(){
  loadTheme(); seedUsersIfEmpty();
  const session=JSON.parse(localStorage.getItem(LS.SESSION)||"null");
  if(session){
    const p=JSON.parse(localStorage.getItem(LS.PROFILE)||"{}");
    profile=Object.assign({username:session.user, role:"Operator", region:"", division:""}, p);
    $("chipUser").textContent=profile.username;
    showApp(true);
  } else {
    showApp(false);
  }
  loadAll();
  if(!rules.length){ rules=[{scope:"GLOBAL",key:"GLOBAL",hours:72}]; saveRules(); }
  buildTabs(); applyRole(); buildTemplateEditor(); refreshAll();
  bindEnterToLogin();              // ← add this line
  attachColorObservers();   // 🔹 watch for DOM updates and recolor automatically
  if(alertTimer) clearInterval(alertTimer);
  alertTimer=setInterval(renderAlertsHeader, 5000);
}


/* =============== KPI registry & helpers =============== */

/* Common selectors for sub-tabs (domains) */
const KPI_DOMAINS = [
  {id:"op",   label:"Operational"},
  {id:"sla",  label:"Performance & SLA"},
  {id:"fin",  label:"Financial"},
  {id:"cust", label:"Customer & Channel"},
  {id:"reg",  label:"Regional & Network"},
  {id:"qual", label:"Quality & Complaints"},
  {id:"comp", label:"Compliance & Governance"},
  {id:"drv",  label:"Derived & Forecast"}
];
let activeKpiDomain = "op";

/* Normalize status (same helper idea you okayed earlier) */
function kpiNormStatus(raw, row){
  const s = String(raw||"").trim().toUpperCase();
  const c = s.replace(/[\s-]+/g,'');
  const yes = (set)=> set.has(s) || set.has(c);
  if(yes(new Set(['DELIVERED','DEL','DLVD','DELIVERYDONE']))) return 'DELIVERED';
  if(yes(new Set(['INTRANSIT','IN-TRANSIT','TRANSIT','OFD','OUTFORDELIVERY','DISPATCHED']))) return 'IN-TRANSIT';
  if(yes(new Set(['EXCEPTION','RTO','RTS','RETURN','RETURNTOORIGIN','LOST','DAMAGE','DAMAGED']))) return 'EXCEPTION';
  if(row && row['DELIVERY DATE']) return 'DELIVERED';
  return 'PENDING';
}
function kpiInScope(){ return rows.filter(scopeFilter); }
function hoursBetween(a,b){ const d1=dayjs(a), d2=dayjs(b); if(!d1.isValid()||!d2.isValid()) return null; return d2.diff(d1,"hour"); }
function groupCount(arr, key){ const m={}; arr.forEach(r=>{ const v=r[key]||"—"; m[v]=(m[v]||0)+1; }); return m; }
function sum(arr, key){ return arr.reduce((a,r)=> a + (+r[key]||0), 0); }

/* ----- KPI definitions ----- */
/* Each KPI: { id, domain, title, desc, compute(): {value, sub?}, format? }  */
const KPIS = [
  // 1) Operational
  {id:'op_total', domain:'op', title:'Total Articles', desc:'All articles in the current scope (filters in Settings).',
    compute:()=>({value:kpiInScope().length})},
  {id:'op_delivered', domain:'op', title:'Delivered', desc:'Count of articles with “DELIVERED” status.',
    compute:()=>({value:kpiInScope().filter(r=>kpiNormStatus(r['DELIVERY STATUS'],r)==='DELIVERED').length})},
  {id:'op_intransit', domain:'op', title:'In-Transit', desc:'Count with “IN-TRANSIT”.',
    compute:()=>({value:kpiInScope().filter(r=>kpiNormStatus(r['DELIVERY STATUS'],r)==='IN-TRANSIT').length})},
  {id:'op_pending', domain:'op', title:'Pending (<SLA)', desc:'Not delivered/exception and within SLA.',
    compute:()=>({value:kpiInScope().filter(r=>{const s=kpiNormStatus(r['DELIVERY STATUS'],r); if(['DELIVERED','EXCEPTION'].includes(s))return false; const d=dayjs(r['booking-date-time']); return dayjs().diff(d,'hour')<=slaHoursFor(r);}).length})},
  {id:'op_aged', domain:'op', title:'Pending (>SLA)', desc:'Backlog that exceeded SLA.',
    compute:()=>({value:kpiInScope().filter(r=>{const s=kpiNormStatus(r['DELIVERY STATUS'],r); if(['DELIVERED','EXCEPTION'].includes(s))return false; const d=dayjs(r['booking-date-time']); return dayjs().diff(d,'hour')>slaHoursFor(r);}).length})},
  {id:'op_exception', domain:'op', title:'Exceptions', desc:'RTO/RTS/Lost/Damage etc.',
    compute:()=>({value:kpiInScope().filter(r=>kpiNormStatus(r['DELIVERY STATUS'],r)==='EXCEPTION').length})},
  {id:'op_book_today', domain:'op', title:'Booked Today', desc:'Articles with booking-date = today.',
    compute:()=>({value:kpiInScope().filter(r=>String(r['booking-date-time']||'').slice(0,10)===dayjs().format('YYYY-MM-DD')).length})},
  {id:'op_type_mix', domain:'op', title:'Type Mix', desc:'Distribution by article-type (top categories).',
    compute:()=>{const m=groupCount(kpiInScope(),'article-type'); const top=Object.entries(m).sort((a,b)=>b[1]-a[1]).slice(0,5); return {value:top.map(([k,v])=>`${k}: ${v}`).join('  •  '), sub:'Top 5'};}},

  // 2) Performance & SLA
  {id:'sla_avg', domain:'sla', title:'Avg Delivery Time (h)', desc:'Average hours from booking to delivery for delivered articles.',
    compute:()=>{const d=kpiInScope().filter(r=>kpiNormStatus(r['DELIVERY STATUS'],r)==='DELIVERED'); const arr=d.map(r=>hoursBetween(r['booking-date-time'], r['DELIVERY DATE'])).filter(x=>x!=null); const v=arr.length?Math.round(arr.reduce((a,b)=>a+b,0)/arr.length):0; return {value:v};}},
  {id:'sla_median', domain:'sla', title:'Median Delivery (h)', desc:'50th percentile delivery time among delivered.',
    compute:()=>{const d=kpiInScope().filter(r=>kpiNormStatus(r['DELIVERY STATUS'],r)==='DELIVERED'); const arr=d.map(r=>hoursBetween(r['booking-date-time'], r['DELIVERY DATE'])).filter(x=>x!=null).sort((a,b)=>a-b); const mid=Math.floor(arr.length/2); const v=arr.length?(arr.length%2?arr[mid]:Math.round((arr[mid-1]+arr[mid])/2)):0; return {value:v};}},
  {id:'sla_otd', domain:'sla', title:'On-Time Delivery %', desc:'(Delivered ≤ SLA / Delivered) × 100.',
    compute:()=>{const d=kpiInScope().filter(r=>kpiNormStatus(r['DELIVERY STATUS'],r)==='DELIVERED'); const ok=d.filter(r=>hoursBetween(r['booking-date-time'], r['DELIVERY DATE'])<=slaHoursFor(r)); const v=d.length?Math.round(ok.length/d.length*100):0; return {value:`${v}%`};}},
  {id:'sla_breach', domain:'sla', title:'SLA Breach %', desc:'(Delivered beyond SLA + Pending > SLA) / Total × 100.',
    compute:()=>{const all=kpiInScope(); const delivered=all.filter(r=>kpiNormStatus(r['DELIVERY STATUS'],r)==='DELIVERED'); const late=delivered.filter(r=>hoursBetween(r['booking-date-time'], r['DELIVERY DATE'])>slaHoursFor(r)); const aged=all.filter(r=>{const s=kpiNormStatus(r['DELIVERY STATUS'],r); if(['DELIVERED','EXCEPTION'].includes(s))return false; return dayjs().diff(dayjs(r['booking-date-time']),'hour')>slaHoursFor(r);}); const v=all.length?Math.round((late.length+aged.length)/all.length*100):0; return {value:`${v}%`};}},
  // Delivery office wise performance (KPIs in the office table/chart block; card shows a headline)
  {id:'sla_best_office', domain:'sla', title:'Best Delivery Office (OTD%)', desc:'Office with highest on-time delivery rate.',
    compute:()=>{const map={}; kpiInScope().forEach(r=>{const off=String(r['destination-office-name']||'—'); map[off] = map[off]||{del:0,ok:0}; if(kpiNormStatus(r['DELIVERY STATUS'],r)==='DELIVERED'){ map[off].del++; if(hoursBetween(r['booking-date-time'], r['DELIVERY DATE'])<=slaHoursFor(r)) map[off].ok++; }}); const arr=Object.entries(map).map(([o,v])=>[o, v.del?Math.round(v.ok/v.del*100):0]).sort((a,b)=>b[1]-a[1]); const top=arr[0]||['—',0]; return {value:`${top[0]} (${top[1]}%)`, sub:'On-Time %'};}},

  // 3) Financial
  {id:'fin_tariff', domain:'fin', title:'Total Tariff', desc:'Sum of tariff (₹).',
    compute:()=>({value:`₹ ${sum(kpiInScope(),'tariff').toLocaleString()}`})},
  {id:'fin_avg_tariff', domain:'fin', title:'Avg Tariff / Article', desc:'Total tariff divided by article count.',
    compute:()=>{const n=kpiInScope().length; const v=n? (sum(kpiInScope(),'tariff')/n):0; return {value:`₹ ${Math.round(v).toLocaleString()}`};}},
  {id:'fin_cod_total', domain:'fin', title:'Total COD Booked', desc:'Sum of vp-cod-value.',
    compute:()=>{const s=sum(kpiInScope().filter(r=>String(r['vp-cod-type']||'').toUpperCase()==='COD'),'vp-cod-value'); return {value:`₹ ${Math.round(s).toLocaleString()}`};}},
  {id:'fin_cod_pending', domain:'fin', title:'COD Pending', desc:'COD value for non-delivered articles.',
    compute:()=>{const s=sum(kpiInScope().filter(r=>String(r['vp-cod-type']||'').toUpperCase()==='COD' && kpiNormStatus(r['DELIVERY STATUS'],r)!=='DELIVERED'),'vp-cod-value'); return {value:`₹ ${Math.round(s).toLocaleString()}`};}},
  {id:'fin_high_value', domain:'fin', title:'High-Value Articles', desc:'Count of articles with tariff > ₹5000.',
    compute:()=>({value:kpiInScope().filter(r=>(+r['tariff']||0)>5000).length})},

  // 4) Customer & Channel
  {id:'cust_top_vol', domain:'cust', title:'Top Customer by Volume', desc:'Customer with highest article count.',
    compute:()=>{const m=groupCount(kpiInScope(),'customer-name'); const top=Object.entries(m).sort((a,b)=>b[1]-a[1])[0]||['—',0]; return {value:`${top[0]} (${top[1]})`};}},
  {id:'cust_type_split', domain:'cust', title:'Bulk vs Retail', desc:'Share by customer-type.',
    compute:()=>{const m=groupCount(kpiInScope(),'customer-type'); const e=Object.entries(m).sort((a,b)=>b[1]-a[1]); return {value:e.map(([k,v])=>`${k}: ${v}`).join(' • ')};}},
  {id:'channel_mix', domain:'cust', title:'Booking Channel Mix', desc:'Share by book-channel-name.',
    compute:()=>{const m=groupCount(kpiInScope(),'book-channel-name'); const e=Object.entries(m).sort((a,b)=>b[1]-a[1]).slice(0,4); return {value:e.map(([k,v])=>`${k}: ${v}`).join(' • '), sub:'Top 4'};}},

  // 5) Regional & Network
  {id:'reg_pincodes', domain:'reg', title:'Unique Destination PINs', desc:'Coverage breadth.',
    compute:()=>({value:[...new Set(kpiInScope().map(r=>r['destination-pin']).filter(Boolean))].length})},
  {id:'reg_region_deliv', domain:'reg', title:'Best Region (Delivery %)', desc:'Delivered / Total by Region.',
    compute:()=>{const inS=kpiInScope(); const by={}; inS.forEach(r=>{const g=r.Region||'—'; by[g]=by[g]||{t:0,d:0}; by[g].t++; if(kpiNormStatus(r['DELIVERY STATUS'],r)==='DELIVERED') by[g].d++;}); const arr=Object.entries(by).map(([k,v])=>[k, v.t?Math.round(v.d/v.t*100):0]).sort((a,b)=>b[1]-a[1]); const top=arr[0]||['—',0]; return {value:`${top[0]} (${top[1]}%)`};}},

  // 6) Quality & Complaints
  {id:'qual_open', domain:'qual', title:'Open Complaints', desc:'Open + In-Progress.',
    compute:()=>({value:complaints.filter(c=>['Open','In-Progress'].includes(c.status)).length})},
  {id:'qual_closed', domain:'qual', title:'Closed Complaints', desc:'Resolved + Closed.',
    compute:()=>({value:complaints.filter(c=>['Resolved','Closed'].includes(c.status)).length})},
  {id:'qual_reopen', domain:'qual', title:'Re-opened', desc:'Cases re-opened.',
    compute:()=>({value:complaints.filter(c=>c.status==='Re-opened').length})},
  {id:'qual_top_type', domain:'qual', title:'Top Complaint Type', desc:'Most frequent complaint type.',
    compute:()=>{const m={}; complaints.forEach(c=>m[c.type]=(m[c.type]||0)+1); const top=Object.entries(m).sort((a,b)=>b[1]-a[1])[0]||['—',0]; return {value:`${top[0]} (${top[1]})`};}},

  // 7) Compliance & Governance
  {id:'comp_apt_missing', domain:'comp', title:'APT 2.0 Missing', desc:'Articles with blank APT 2.0 updation.',
    compute:()=>({value:kpiInScope().filter(r=>!String(r['APT 2.O updation']||'').trim()).length})},
  {id:'comp_required_missing', domain:'comp', title:'Mandatory Fields Missing', desc:'Any of required fields empty.',
    compute:()=>({value:kpiInScope().filter(r=>REQUIRED.some(k=>!String(r[k]||'').trim())).length})},
  {id:'comp_audit_events', domain:'comp', title:'Audit Events (7d)', desc:'Number of actions logged in last 7 days.',
    compute:()=>{const cutoff=dayjs().subtract(7,'day'); return {value:audit.filter(a=>dayjs(a.ts).isAfter(cutoff)).length};}},

  // 8) Derived & Forecast
  {id:'drv_eff_ratio', domain:'drv', title:'Delivery Efficiency', desc:'Delivered / (Delivered + Pending).',
    compute:()=>{const inS=kpiInScope(); const del=inS.filter(r=>kpiNormStatus(r['DELIVERY STATUS'],r)==='DELIVERED').length; const pend=inS.filter(r=>!['DELIVERED','EXCEPTION'].includes(kpiNormStatus(r['DELIVERY STATUS'],r))).length; const v=(del+pend)?Math.round(del/(del+pend)*100):0; return {value:`${v}%`};}},
  {id:'drv_return_ratio', domain:'drv', title:'Return Ratio', desc:'RTS/RTO vs Delivered.',
    compute:()=>{const inS=kpiInScope(); const del=inS.filter(r=>kpiNormStatus(r['DELIVERY STATUS'],r)==='DELIVERED').length; const ret=inS.filter(r=>kpiNormStatus(r['DELIVERY STATUS'],r)==='EXCEPTION').length; const v=del? (ret/del*100):0; return {value:`${v.toFixed(1)}%`};}},
  {id:'drv_growth_mom', domain:'drv', title:'MoM Growth (Bookings)', desc:'(This month − Last month)/Last month.',
    compute:()=>{const m=dayjs().format('YYYY-MM'), lm=dayjs().subtract(1,'month').format('YYYY-MM'); const cnt=(tag)=>kpiInScope().filter(r=>String(r['booking-date-time']||'').startsWith(tag)).length; const a=cnt(m), b=cnt(lm); const v=b? Math.round((a-b)/b*100):0; return {value:`${v}%`};}}
];

/* Card renderer */
function renderKpiCards(domain){
  const host = $("kpiPanel");
  host.innerHTML = "";
  const list = KPIS.filter(k => k.domain === domain);
  const grid = document.createElement("div"); grid.className = "kpi-grid";

  list.forEach(k=>{
    const res = k.compute();
    const card = document.createElement("div"); 
    card.className = "kpi-card";
card.innerHTML = `
  <div class="kpi-title" title="${k.title}">
    ${k.title}
    <span class="info" onclick="this.nextElementSibling.classList.toggle('show')">i</span>
    <div class="tooltip">${k.desc}</div>
  </div>
  <div class="kpi-value">${res.value ?? '—'}</div>
  ${res.sub ? `<div class="kpi-sub" title="${res.sub}">${res.sub}</div>` : ''}
      <span class="info" title="More info"
        onclick="event.stopPropagation(); const t=this.nextElementSibling; document.querySelectorAll('.kpi-card .tooltip').forEach(x=>x!==t&&x.classList.remove('show')); t.classList.toggle('show');">i</span>
      <div class="tooltip">${k.desc}</div>
    `;
    grid.appendChild(card);
  });
  host.appendChild(grid);

  // Append domain-specific blocks (charts/tables)
  if(domain==='sla'){ renderOfficeBlocks(); }
  if(domain==='cust'){ renderParetoBlock('Top Customers by Volume','customer-name','chartKpiCust','kpiPanel'); }
  if(domain==='reg'){ renderParetoBlock('Regions by Volume','Region','chartKpiReg','kpiPanel'); }
  if(domain==='fin'){ renderParetoBlock('Top Customers by Revenue (Tariff)','customer-name','chartKpiFin','kpiPanel', true); }

  // Dynamic coloring by title keywords
  document.querySelectorAll('.kpi-card').forEach(card=>{
    const title = (card.querySelector('.kpi-title')?.textContent||'').toUpperCase();
    card.classList.remove('k-ok','k-warn','k-err','k-info');
    if (title.includes('EXCEPTION') || title.includes('BREACH')) card.classList.add('k-err');
    else if (title.includes('PENDING') || title.includes('AGED') || title.includes('> SLA')) card.classList.add('k-warn');
    else if (title.includes('DELIVERED') || title.includes('ON-TIME')) card.classList.add('k-ok');
    else card.classList.add('k-info');
  });
}

/* Sub-tabs for KPI domains */
function buildKpiSubTabs(){
  const bar=$("kpiSubTabs"); bar.innerHTML="";
  KPI_DOMAINS.forEach(d=>{
    const b=document.createElement("button");
    b.className="tab"+(d.id===activeKpiDomain?" active":"");
    b.textContent=d.label;
    b.onclick=()=>{ activeKpiDomain=d.id; [...bar.children].forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderKpiCards(activeKpiDomain); };
    bar.appendChild(b);
  });
}

/* Pareto/Line toggle block for a field (or tariff sum) */
function renderParetoBlock(title, field, chartId, attachToId, sumTariff=false){
  const wrap=document.createElement("div"); wrap.className="card"; wrap.style.marginTop="10px";
  const head=document.createElement("div"); head.className="block-head";
  head.innerHTML=`<strong>${title}</strong><div class="view-toggle"><button class="btn active" data-view="pareto">Pareto</button><button class="btn" data-view="line">Line</button></div>`;
  const cv=document.createElement("canvas"); cv.id=chartId;
  wrap.appendChild(head); wrap.appendChild(cv);
  document.getElementById(attachToId).appendChild(wrap);

  const inS=kpiInScope();
  const map={};
  if(sumTariff){
    inS.forEach(r=>{ const k=r[field]||'—'; map[k]=(map[k]||0)+(+r.tariff||0); });
  }else{
    inS.forEach(r=>{ const k=r[field]||'—'; map[k]=(map[k]||0)+1; });
  }
  const arr=Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const labels=arr.map(a=>a[0]); const values=arr.map(a=>a[1]);

  const togg=head.querySelector('.view-toggle');
  let mode='pareto';
  const draw=()=>{
    if(charts[chartId]) charts[chartId].destroy();
    if(mode==='pareto'){
      // Pareto: bars + cumulative %
      const total = values.reduce((a,b)=>a+b,0)||1;
      let cum=0; const cumPct=values.map(v=>{ cum+=v; return +(cum/total*100).toFixed(1); });
      charts[chartId]=new Chart(cv, {
        type:'bar',
        data:{ labels, datasets:[{label: sumTariff?'Tariff':'Count', data: values, yAxisID:'y'}, {label:'Cumulative %', data:cumPct, type:'line', yAxisID:'y1'}]},
        options:{ responsive:true, scales:{y:{beginAtZero:true}, y1:{beginAtZero:true, position:'right', max:100}}, plugins:{legend:{position:'bottom'}}}
      });
    }else{
      charts[chartId]=new Chart(cv, {
        type:'line', data:{labels, datasets:[{label: sumTariff?'Tariff':'Count', data:values}]},
        options:{plugins:{legend:{position:'bottom'}}}
      });
    }
  };
  togg.querySelectorAll('button').forEach(b=> b.onclick=()=>{ togg.querySelectorAll('button').forEach(x=>x.classList.remove('active')); b.classList.add('active'); mode=b.dataset.view; draw(); });
  draw();
}

/* Office-wise block (booking volume + delivery performance) */
function toggleOfficeBlock(){
  const d=$("officeDisclosure"); const b=$("officeBlock");
  const open=d.getAttribute('aria-expanded')==='true';
  d.setAttribute('aria-expanded', String(!open));
  d.querySelector('.badge').textContent = !open ? 'expanded' : 'collapsed';
  b.classList.toggle('show', !open);
  if(!open) renderOfficeBlocks(); // draw when opened
}

function renderOfficeBlocks(){
  // Charts toggles (Pareto default)
  buildViewToggle('bookViewTog', (view)=>drawOfficeBook(view));
  buildViewToggle('delivViewTog', (view)=>drawOfficeDeliv(view));

  drawOfficeBook('pareto');
  drawOfficeDeliv('pareto');

  // Table (booking & delivery KPIs per office)
  const tbl=$("officeTable");
  const byBook = groupCount(kpiInScope(),'booking-office-name');
  // delivery KPI per destination office: OTD%
  const mapDel={};
  kpiInScope().forEach(r=>{
    const off=r['destination-office-name']||'—';
    mapDel[off]=mapDel[off]||{del:0, ok:0, exc:0};
    const s=kpiNormStatus(r['DELIVERY STATUS'],r);
    if(s==='DELIVERED'){ mapDel[off].del++; if(hoursBetween(r['booking-date-time'], r['DELIVERY DATE'])<=slaHoursFor(r)) mapDel[off].ok++; }
    if(s==='EXCEPTION') mapDel[off].exc++;
  });
  const head=`<thead><tr><th>Booking Office</th><th>Booked</th><th>Delivery Office</th><th>Delivered</th><th>On-Time %</th><th>Exceptions</th></tr></thead>`;
  const bodyRows=[];
  const bookArr=Object.entries(byBook).sort((a,b)=>b[1]-a[1]).slice(0,20);
  const delArr=Object.entries(mapDel).map(([k,v])=>[k,v.del,v.del?Math.round(v.ok/v.del*100):0,v.exc]).sort((a,b)=>b[1]-a[1]).slice(0,20);
  const max=Math.max(bookArr.length, delArr.length);
  for(let i=0;i<max;i++){
    const L=bookArr[i]||['—','']; const R=delArr[i]||['—','','',''];
    bodyRows.push(`<tr><td>${L[0]}</td><td>${L[1]}</td><td>${R[0]}</td><td>${R[1]}</td><td>${R[2]}</td><td>${R[3]}</td></tr>`);
  }
  tbl.innerHTML = head + `<tbody>${bodyRows.join('')}</tbody>`;
  addInlineFilters(tbl);
}
function buildViewToggle(hostId, cb){
  const host=$(hostId); host.innerHTML=`<button class="btn active" data-v="pareto">Pareto</button><button class="btn" data-v="line">Line</button>`;
  host.querySelectorAll('button').forEach(b=> b.onclick=()=>{ host.querySelectorAll('button').forEach(x=>x.classList.remove('active')); b.classList.add('active'); cb(b.dataset.v); });
}


// --- REPLACE ONLY THESE TWO FUNCTIONS START ---

function drawOfficeBook(view){
  const cv = $("chartOfficeBook");
  if (charts.officeBook) charts.officeBook.destroy();

  const map = groupCount(kpiInScope(), 'booking-office-name');
  const arr = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,12);
  const labels = arr.map(a=>a[0]);
  const values = arr.map(a=>a[1]);

  if (view === 'pareto'){
    const total = values.reduce((a,b)=>a+b,0) || 1;
    let cum = 0;
    const cumPct = values.map(v => { cum += v; return +(cum/total*100).toFixed(1); });

    charts.officeBook = new Chart(cv, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'Booked', data: values, yAxisID: 'y' },
          { label: 'Cumulative %', data: cumPct, type: 'line', yAxisID: 'y1' }
        ]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true }, y1: { beginAtZero: true, position: 'right', max: 100 } },
        plugins: { legend: { position: 'bottom' } }
      }
    });
  } else {
    charts.officeBook = new Chart(cv, {
      type: 'line',
      data: { labels, datasets: [ { label: 'Booked', data: values } ] },
      options: { plugins: { legend: { position: 'bottom' } } }
    });
  }
}

function drawOfficeDeliv(view){
  const cv = $("chartOfficeDeliv");
  if (charts.officeDeliv) charts.officeDeliv.destroy();

  // compute On-Time Delivery % per delivery office
  const map = {};
  kpiInScope().forEach(r=>{
    const k = r['destination-office-name'] || '—';
    map[k] = map[k] || { del:0, ok:0 };
    const s = kpiNormStatus(r['DELIVERY STATUS'], r);
    if (s === 'DELIVERED'){
      map[k].del++;
      if (hoursBetween(r['booking-date-time'], r['DELIVERY DATE']) <= slaHoursFor(r)) map[k].ok++;
    }
  });

  const arr = Object.entries(map)
    .map(([k,v]) => [k, v.del ? Math.round(v.ok/v.del*100) : 0])
    .sort((a,b)=>b[1]-a[1])
    .slice(0,12);

  const labels = arr.map(a=>a[0]);
  const values = arr.map(a=>a[1]);

  if (view === 'pareto'){
    const total = values.reduce((a,b)=>a+b,0) || 1;
    let cum = 0;
    const cumPct = values.map(v => { cum += v; return +(cum/total*100).toFixed(1); });

    charts.officeDeliv = new Chart(cv, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'On-Time %', data: values, yAxisID: 'y' },
          { label: 'Cumulative %', data: cumPct, type: 'line', yAxisID: 'y1' }
        ]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true, max: 100 }, y1: { beginAtZero: true, position: 'right', max: 100 } },
        plugins: { legend: { position: 'bottom' } }
      }
    });
  } else {
    charts.officeDeliv = new Chart(cv, {
      type: 'line',
      data: { labels, datasets: [ { label: 'On-Time %', data: values } ] },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true, max: 100 } },
        plugins: { legend: { position: 'bottom' } }
      }
    });
  }
}
// --- REPLACE ONLY THESE TWO FUNCTIONS END ---

/* Build sub-tabs and initial render when the KPIs tab is activated */
function initKpiTabOnce(){
  if($("kpiSubTabs").dataset.ready) return;
  $("kpiSubTabs").dataset.ready="1";
  buildKpiSubTabs();
  renderKpiCards(activeKpiDomain);
}

  /* Let Enter submit the login form */
function bindEnterToLogin(){
  var u = document.getElementById('lgUser');
  var p = document.getElementById('lgPass');
  if (u && !u.__enterBound) {
    u.addEventListener('keydown', function(e){ if (e.key === 'Enter') doLogin(); });
    u.__enterBound = true; // prevent double-binding
  }
  if (p && !p.__enterBound) {
    p.addEventListener('keydown', function(e){ if (e.key === 'Enter') doLogin(); });
    p.__enterBound = true;
  }
}



boot();

/* One global click handler (alerts + KPI info tooltips) */
document.addEventListener('click', (e)=>{
  // 1) Alerts dropdown: close when clicking outside
  const slot = document.getElementById('alertsSlot');
  const menu = document.getElementById('alertMenu');
  if (slot && menu && !slot.contains(e.target)) {
    menu.classList.add('hidden');
  }

  // 2) KPI info tooltips: close when clicking anywhere outside the icon/tooltip
  const clickedInsideTooltip = e.target.closest('.kpi-card .tooltip');
  const clickedInfoIcon      = e.target.closest('.kpi-card .info');
  if (!clickedInsideTooltip && !clickedInfoIcon){
    document.querySelectorAll('.kpi-card .tooltip.show').forEach(t => t.classList.remove('show'));
  }
});

  // --- expose handlers for inline onclicks ---
  window.togglePw = togglePw;
  window.clearLogin = clearLogin;
  window.doLogin = doLogin;
  window.startChangePassword = startChangePassword;
  window.startForgot = startForgot;

</script>
</body>
</html>
