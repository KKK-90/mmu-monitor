<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MMU-Monitoring Dashboard (Single-File, Phase-1)</title>

<!-- Essentials for GH Pages prototype -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/dayjs.min.js"></script>

<style>
  /* ---------- THEMES ---------- */
  :root{
    --bg:#0f1420; --card:#121826; --ink:#eef2ff; --muted:#94a3b8;
    --accent:#34d399; --accent2:#60a5fa; --glass:rgba(255,255,255,.06); --glass-br:rgba(255,255,255,.15);
    --row-border:#22314e; --pill-good:#16a34a; --pill-warn:#f59e0b; --pill-info:#60a5fa; --pill-bad:#ef4444;
  }
  html[data-theme="light"]{
    --bg:#f6f8ff; --card:#ffffff; --ink:#0b1220; --muted:#5b6475;
    --accent:#059669; --accent2:#2563eb; --glass:rgba(0,0,0,.04); --glass-br:rgba(0,0,0,.1);
    --row-border:#e5e7eb; --pill-good:#15803d; --pill-warn:#b45309; --pill-info:#1d4ed8; --pill-bad:#b91c1c;
  }

  /* ---------- BASE ---------- */
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(160deg,var(--bg), #131a2a40 40%, var(--bg));color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;z-index:30;backdrop-filter:blur(12px);
    background:linear-gradient(90deg, var(--glass), transparent);
    border-bottom:1px solid var(--glass-br);padding:10px 14px;}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .title{font-weight:800;letter-spacing:.3px;display:flex;gap:10px;align-items:center}
  .badge{font-size:12px;padding:2px 8px;border-radius:999px;background:var(--glass);border:1px solid var(--glass-br);color:var(--muted)}
  .tabs{display:flex;gap:6px;flex-wrap:wrap}
  .tab{padding:8px 12px;background:var(--glass);border:1px solid var(--glass-br);border-radius:999px;color:var(--ink);cursor:pointer;font-weight:600}
  .tab.active{background:linear-gradient(180deg,rgba(52,211,153,.25),rgba(96,165,250,.18));border-color:var(--accent2)}
  .grid{display:grid;gap:14px}
  .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px}
  .card{background:var(--card);border:1px solid var(--glass-br);border-radius:14px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
  .card h3{margin:0 0 8px 0;font-size:16px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .grow{flex:1 1 auto}
  input,select,textarea,button{background:color-mix(in oklab,var(--card) 85%,#000 15%);color:var(--ink);border:1px solid var(--glass-br);border-radius:10px;padding:8px 10px}
  input::placeholder{color:var(--muted)}
  button{cursor:pointer;font-weight:700}
  .btn{background:linear-gradient(180deg, color-mix(in oklab,var(--accent) 30%, transparent), color-mix(in oklab,var(--accent2) 25%, transparent)); border-color:var(--accent2)}
  .btn.red{background:linear-gradient(180deg, color-mix(in oklab,var(--pill-bad) 35%, transparent), color-mix(in oklab,var(--pill-warn) 25%, transparent)); border-color:var(--pill-bad)}
  .btn.gray{background:linear-gradient(180deg, rgba(0,0,0,.06), rgba(0,0,0,.03))}
  .btn.link{background:transparent;border:1px dashed var(--glass-br)}
  .table-wrap{overflow:auto;border:1px solid var(--glass-br);border-radius:12px}
  table{border-collapse:separate;border-spacing:0;width:100%;min-width:900px}
  th,td{padding:8px 10px;border-bottom:1px solid var(--row-border)} th{position:sticky;top:0;background:color-mix(in oklab,var(--card) 90%,#000 10%);text-align:left;font-size:12px;text-transform:uppercase;letter-spacing:.4px}
  tr:hover td{background:color-mix(in oklab,var(--card) 80%,#000 20%)}
  .pill{padding:2px 6px;border-radius:999px;border:1px solid var(--glass-br);background:var(--glass);font-size:12px}
  .status-delivered{background:color-mix(in oklab,var(--pill-good) 20%, transparent); border-color:var(--pill-good)}
  .status-intransit{background:color-mix(in oklab,var(--pill-info) 20%, transparent); border-color:var(--pill-info)}
  .status-pending{background:color-mix(in oklab,var(--pill-warn) 20%, transparent); border-color:var(--pill-warn)}
  .status-exception{background:color-mix(in oklab,var(--pill-bad) 20%, transparent); border-color:var(--pill-bad)}
  .muted{color:var(--muted)}
  .sr{position:absolute;left:-9999px}
  .divider{height:1px;background:var(--glass-br);margin:12px 0}
  .note{font-size:12px;color:var(--muted)}
  .sticky-actions{position:sticky;bottom:0;background:linear-gradient(180deg,transparent 0%, color-mix(in oklab,var(--bg) 98%, #000 2%) 40%);padding-top:10px}
  .kpi{font-size:28px;font-weight:800}
  .right{margin-left:auto}
  .hidden{display:none!important}

  /* ---------- LOGIN SCREEN ---------- */
  #loginScreen{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:linear-gradient(160deg,var(--bg), #131a2a60 40%, var(--bg));
    z-index:1000;
  }
  .login-card{
    width:min(420px,92vw); background:var(--card); border:1px solid var(--glass-br); border-radius:16px; padding:20px;
    box-shadow:0 20px 60px rgba(0,0,0,.35)
  }
  .login-card h1{margin:0 0 4px 0; font-size:20px}
  .helper{font-size:12px; color:var(--muted)}
</style>
</head>
<body>

<!-- ================= LOGIN ================= -->
<div id="loginScreen">
  <div class="login-card">
    <h1>MMU-Monitoring Dashboard</h1>
    <div class="helper">Sign in to continue (prototype login, stored locally).</div>
    <div class="divider"></div>
    <div class="row"><label class="grow">Username <input id="loginUser" placeholder="username"/></label></div>
    <div class="row"><label class="grow">Password <input id="loginPass" type="password" placeholder="password"/></label></div>
    <div class="row">
      <button class="btn" onclick="doLogin()">Login</button>
      <button class="btn gray right" onclick="fillDemo()">Use Demo (operator/Op@123)</button>
    </div>
    <div class="divider"></div>
    <div class="helper">Demo users → viewer/View@123, operator/Op@123, supervisor/Sup@123, admin/Admin@123, superadmin/Sa@123</div>
  </div>
</div>

<!-- ================= APP HEADER ================= -->
<header id="appHeader" class="hidden">
  <div class="wrap row" style="justify-content:space-between;">
    <div class="title">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="color:var(--accent)"><path d="M12 2l4 4-4 4-4-4 4-4zm0 6l4 4-4 4-4-4 4-4zm0 6l4 4-4 4-4-4 4-4z"/></svg>
      <div>MMU-Monitoring Dashboard <span class="badge">Single-File Prototype</span></div>
    </div>
    <div class="row">
      <button class="tab btn gray" id="themeBtn" title="Toggle theme" onclick="toggleTheme()">Light/Dark</button>
      <span class="badge" id="userBadge">—</span>
      <span class="badge">Scope:
        <select id="scopeRegion" onchange="persistProfile();refreshAll()"><option value="">All Regions</option></select>
        <select id="scopeDivision" onchange="persistProfile();refreshAll()"><option value="">All Divisions</option></select>
      </span>
      <span class="badge">Local Time: <span id="clock"></span></span>
      <button class="tab btn gray" onclick="downloadBackup()">Backup</button>
      <label class="tab">Restore <input class="sr" type="file" accept=".json" onchange="restoreBackup(event)"><span class="badge">JSON</span></label>
      <button class="tab btn red" onclick="logout()">Logout</button>
    </div>
  </div>
</header>

<!-- ================= MAIN ================= -->
<div id="appBody" class="wrap grid hidden">
  <!-- Tabs -->
  <div class="tabs" id="tabs"></div>

  <!-- Upload -->
  <section class="card" data-tab="Upload">
    <h3>Upload Data (Excel / CSV) & Recurring Batches</h3>
    <div class="row">
      <input type="file" id="fileInput" accept=".xlsx,.xls,.csv"/>
      <input id="batchName" placeholder="Batch name e.g. Daily_2025-10-07"/>
      <select id="batchType">
        <option value="ad-hoc">Ad-hoc</option><option value="daily">Daily</option>
        <option value="weekly">Weekly</option><option value="monthly" selected>Monthly</option>
      </select>
      <label class="row">Mode:
        <select id="importMode">
          <option value="append" selected>Append</option>
          <option value="replace">Replace All</option>
        </select>
      </label>
      <button class="btn" onclick="handleFile()">Import</button>
      <button class="btn gray" onclick="downloadTemplate('xlsx')">Template (XLSX)</button>
      <button class="btn gray" onclick="downloadTemplate('csv')">Template (CSV)</button>
    </div>
    <div class="note">Appends by default and tags each record with <code>_batchId</code> and <code>_batchType</code>. “Replace All” clears data first.</div>
    <div class="divider"></div>
    <h3>Bulk Status Patch (CSV)</h3>
    <div class="row">
      <input type="file" id="patchFile" accept=".csv,.xlsx,.xls"/>
      <button class="btn" onclick="applyPatch()">Apply Patch</button>
      <button class="btn gray" onclick="downloadPatchSample()">Sample CSV</button>
    </div>
  </section>

  <!-- Manual Entry -->
  <section class="card" data-tab="Manual Entry">
    <h3>Manual Add / Edit</h3>
    <form id="manualForm" class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));"></form>
    <div class="row sticky-actions">
      <button class="btn" onclick="saveManual()">Save Row</button>
      <button class="btn gray" onclick="document.getElementById('manualForm').reset()">Clear</button>
    </div>
  </section>

  <!-- Dashboard -->
  <section class="card" data-tab="Dashboard">
    <h3>Analytics Dashboard</h3>
    <div class="cards">
      <div class="card"><div class="muted">Total Articles (in scope)</div><div class="kpi" id="kpiTotal">0</div></div>
      <div class="card"><div class="muted">Delivered</div><div class="kpi" id="kpiDelivered">0</div></div>
      <div class="card"><div class="muted">Pending (&gt; SLA)</div><div class="kpi" id="kpiAged">0</div></div>
      <div class="card"><div class="muted">Exceptions</div><div class="kpi" id="kpiException">0</div></div>
    </div>
    <div class="divider"></div>
    <div class="cards">
      <div class="card"><canvas id="chartStatus"></canvas></div>
      <div class="card"><canvas id="chartByRegion"></canvas></div>
      <div class="card"><canvas id="chartTrend"></canvas></div>
    </div>
  </section>

  <!-- Browse -->
  <section class="card" data-tab="Browse">
    <h3>Browse, Filter & Drill-down</h3>
    <div class="row" id="filterBar">
      <input class="grow" id="q" placeholder="Search (name, article, office…)" oninput="renderTable()"/>
      <input type="date" id="fromDate" oninput="renderTable()"/>
      <input type="date" id="toDate" oninput="renderTable()"/>
      <select id="fStatus" onchange="renderTable()">
        <option value="">All Status</option><option>DELIVERED</option><option>IN-TRANSIT</option><option>PENDING</option><option>EXCEPTION</option>
      </select>
      <select id="fRegion" onchange="renderTable()"><option value="">All Regions</option></select>
      <select id="fDivision" onchange="renderTable()"><option value="">All Divisions</option></select>
      <select id="fBatch" onchange="renderTable()"><option value="">All Batches</option></select>
      <button class="btn" onclick="exportTable('csv')">CSV</button>
      <button class="btn" onclick="exportTable('xlsx')">Excel</button>
      <button class="btn" onclick="exportPDF()">PDF</button>
    </div>
    <div class="divider"></div>
    <div class="table-wrap"><table id="dataTable"></table></div>
    <div class="row sticky-actions">
      <label class="row">Bulk Status:
        <select id="bulkStatus">
          <option value="">— choose —</option><option>DELIVERED</option><option>IN-TRANSIT</option><option>PENDING</option><option>EXCEPTION</option>
        </select>
      </label>
      <label class="row">Delivery Date: <input type="date" id="bulkDate"></label>
      <button class="btn" onclick="applyBulk()">Apply to Selected</button>
      <button class="btn gray right" id="btnDelete" onclick="deleteSelected()">Delete Selected</button>
    </div>
  </section>

  <!-- Templates -->
  <section class="card" data-tab="Templates">
    <h3>Template Manager</h3>
    <div class="note">Enable/disable, re-order columns. Uploads and forms follow this structure.</div>
    <div id="templateEditor" class="grid" style="grid-template-columns:repeat(auto-fit,minmax(280px,1fr));margin-top:8px"></div>
    <div class="row sticky-actions">
      <button class="btn" onclick="downloadTemplate('xlsx')">Template (XLSX)</button>
      <button class="btn" onclick="downloadTemplate('csv')">Template (CSV)</button>
      <button class="btn gray" onclick="resetTemplate()">Reset to Default</button>
    </div>
  </section>

  <!-- Reports -->
  <section class="card" data-tab="Reports">
    <h3>Reports (Summary, Trend, Exceptions, Performance, Compliance, Custom)</h3>
    <div class="row">
      <select id="reportType" class="grow">
        <option value="summary">Summary</option><option value="trend">Trend (daily/weekly/monthly)</option>
        <option value="exceptions">Exceptions</option><option value="performance">Performance (SLA, avg time)</option>
        <option value="compliance">Compliance (APT 2.0, mandatory)</option><option value="custom">Custom / User-defined</option>
      </select>
      <button class="btn" onclick="buildReport()">Build</button>
      <button class="btn" onclick="reportExport('pdf')">PDF</button>
      <button class="btn" onclick="reportExport('xlsx')">Excel</button>
      <button class="btn" onclick="reportExport('csv')">CSV</button>
    </div>
    <div class="divider"></div>
    <div id="reportHost" class="table-wrap"><table id="reportTable"></table></div>
  </section>

  <!-- Complaints -->
  <section class="card" data-tab="Complaints">
    <h3>Complaints / Issues Monitoring</h3>
    <div class="row">
      <input id="cmpArticle" placeholder="article-number"/>
      <input id="cmpType" placeholder="issue type (delay, damage…)"/>
      <input id="cmpDesc" class="grow" placeholder="short description"/>
      <button class="btn" onclick="addComplaint()">Log Issue</button>
    </div>
    <div class="divider"></div>
    <div class="table-wrap"><table id="cmpTable"></table></div>
  </section>

  <!-- Alerts -->
  <section class="card" data-tab="Alerts">
    <h3>Critical & Necessary Alerts</h3>
    <div id="alertsList" class="grid"></div>
  </section>

  <!-- SLA Rules -->
  <section class="card" data-tab="SLA Rules">
    <h3>SLA & Compliance Rules</h3>
    <div class="row">
      <select id="ruleScope">
        <option value="GLOBAL" selected>GLOBAL</option><option value="REGION">REGION</option>
        <option value="DIVISION">DIVISION</option><option value="CUSTOMER">CUSTOMER</option>
        <option value="ARTICLE-TYPE">ARTICLE-TYPE</option>
      </select>
      <input id="ruleKey" placeholder="Scope value (e.g., South, Belagavi, customer-id)"/>
      <input type="number" id="ruleHours" placeholder="SLA hours" min="1" style="width:140px"/>
      <button class="btn" onclick="addRule()">Add / Update Rule</button>
      <button class="btn gray" onclick="resetRules()">Reset</button>
    </div>
    <div class="divider"></div>
    <div class="table-wrap"><table id="ruleTable"></table></div>
  </section>

  <!-- Audit -->
  <section class="card" data-tab="Audit">
    <h3>Audit Log</h3>
    <div class="note">Every import, patch, manual add, bulk update, delete, complaint, settings/rules change is recorded here.</div>
    <div class="table-wrap"><table id="auditTable"></table></div>
    <div class="row sticky-actions">
      <button class="btn gray" onclick="downloadAudit()">Export Audit (CSV)</button>
      <button class="btn red" onclick="clearAudit()">Clear Audit</button>
    </div>
  </section>

  <!-- Settings -->
  <section class="card" data-tab="Settings">
    <h3>Settings</h3>
    <div class="row">
      <label>Default Period:
        <select id="defaultPeriod" onchange="persistSettings()">
          <option value="daily">Daily</option><option value="weekly">Weekly</option>
          <option value="monthly" selected>Monthly</option><option value="quarterly">Quarterly</option><option value="annual">Annual</option>
        </select>
      </label>
      <label class="row">Manual Delete Allowed:
        <select id="allowDelete" onchange="persistSettings()">
          <option value="role">By Role</option><option value="never">Never</option><option value="always">Always</option>
        </select>
      </label>
    </div>
  </section>
</div>

<script>
/* ===================== KEYS & CONSTANTS ===================== */
const DEFAULT_COLUMNS = [
  "customer-id","customer-name","customer-type-id","customer-type","contract-id",
  "payment-mode-code","payment_mode_description","book-channel-id","book-channel-name",
  "book-type-id","book-type-name","user-id","user-name","article-number","article-type",
  "booking-date-time","booking-office-pin","booking-office-id","booking-office-name",
  "destination-country","destination-pin","Region","Division","destination-office-name",
  "DELIVERY STATUS","DELIVERY DATE","APT 2.O updation","sender-name","sender-address",
  "receiver-name","receiver-address","event-code","event-description","tariff","weight",
  "vp-cod-type","vp-cod-value","remarks"
];
const REQUIRED = ["article-number","booking-date-time","booking-office-name","Region","Division","DELIVERY STATUS"];

const LS = {
  ROWS:"as_rows_v2", TEMPLATE:"as_template_v2", COMPLAINTS:"as_complaints_v2",
  SETTINGS:"as_settings_v2", RULES:"as_rules_v1", AUDIT:"as_audit_v1",
  PROFILE:"as_profile_v1", USERS:"as_users_v1", THEME:"as_theme_v1", SESSION:"as_session_v1"
};

const ROLE = { Viewer:0, Operator:1, Supervisor:2, Admin:3, Superadmin:4 };
const DEFAULT_USERS = [
  {username:"viewer",     password:"View@123", role:"Viewer",     display:"Viewer"},
  {username:"operator",   password:"Op@123",   role:"Operator",   display:"Operator"},
  {username:"supervisor", password:"Sup@123",  role:"Supervisor", display:"Supervisor"},
  {username:"admin",      password:"Admin@123",role:"Admin",      display:"Admin"},
  {username:"superadmin", password:"Sa@123",   role:"Superadmin", display:"Superadmin"}
];

/* =============== GLOBAL STATE =============== */
let rows=[], template=[], complaints=[], rules=[], audit=[], profile={role:"Viewer", region:"", division:"", user:""};
let settings={ defaultPeriod:"monthly", allowDelete:"role" };
let charts={}, session=null;

/* =============== HELPERS =============== */
const $ = id => document.getElementById(id);
function tickClock(){ $("clock").textContent = new Date().toLocaleString(); }
setInterval(tickClock, 1000); tickClock();

/* =============== AUTH =============== */
function ensureUsers(){
  const u = JSON.parse(localStorage.getItem(LS.USERS)||"null");
  if(!u) localStorage.setItem(LS.USERS, JSON.stringify(DEFAULT_USERS));
}
function doLogin(){
  ensureUsers();
  const u = $("loginUser").value.trim(), p = $("loginPass").value;
  const users = JSON.parse(localStorage.getItem(LS.USERS)||"[]");
  const hit = users.find(x=> x.username===u && x.password===p);
  if(!hit){ alert("Invalid credentials"); return; }
  session = { username:hit.username, role:hit.role, display:hit.display };
  localStorage.setItem(LS.SESSION, JSON.stringify(session));
  profile = { role:hit.role, user:hit.username, region:"", division:"" };
  localStorage.setItem(LS.PROFILE, JSON.stringify(profile));
  logAudit("auth.login",{user:hit.username, role:hit.role});
  postLoginUI();
}
function fillDemo(){ $("loginUser").value="operator"; $("loginPass").value="Op@123"; }
function logout(){
  logAudit("auth.logout",{user:session?.username});
  session=null; localStorage.removeItem(LS.SESSION);
  document.getElementById("loginScreen").style.display="flex";
  document.getElementById("appHeader").classList.add("hidden");
  document.getElementById("appBody").classList.add("hidden");
}
function postLoginUI(){
  $("userBadge").textContent = `${session.display} (${session.role})`;
  document.getElementById("loginScreen").style.display="none";
  document.getElementById("appHeader").classList.remove("hidden");
  document.getElementById("appBody").classList.remove("hidden");
  bootAppAfterAuth();
}

/* =============== THEME =============== */
function applyTheme(t){
  document.documentElement.setAttribute("data-theme", t);
  localStorage.setItem(LS.THEME, t);
  $("themeBtn").textContent = (t==="dark")?"Light":"Dark";
}
function toggleTheme(){
  const cur = document.documentElement.getAttribute("data-theme") || "dark";
  applyTheme(cur==="dark"?"light":"dark");
}

/* =============== LOAD/PERSIST =============== */
function loadAll(){
  rows = JSON.parse(localStorage.getItem(LS.ROWS)||"[]");
  template = JSON.parse(localStorage.getItem(LS.TEMPLATE)||"null") || DEFAULT_COLUMNS.map(k=>({key:k,label:k,enabled:true}));
  complaints = JSON.parse(localStorage.getItem(LS.COMPLAINTS)||"[]");
  rules = JSON.parse(localStorage.getItem(LS.RULES)||"[]");
  audit = JSON.parse(localStorage.getItem(LS.AUDIT)||"[]");
  const prof = JSON.parse(localStorage.getItem(LS.PROFILE)||"null");
  if(prof) profile = Object.assign(profile, prof);
  const theme = localStorage.getItem(LS.THEME) || "dark";
  applyTheme(theme);
  const sess = JSON.parse(localStorage.getItem(LS.SESSION)||"null");
  if(sess){ session=sess; postLoginUI(); }
}
function persist(){ localStorage.setItem(LS.ROWS, JSON.stringify(rows)); }
function saveTemplate(){ localStorage.setItem(LS.TEMPLATE, JSON.stringify(template)); }
function saveComplaints(){ localStorage.setItem(LS.COMPLAINTS, JSON.stringify(complaints)); }
function saveRules(){ localStorage.setItem(LS.RULES, JSON.stringify(rules)); }
function saveAudit(){ localStorage.setItem(LS.AUDIT, JSON.stringify(audit)); }
function persistSettings(){
  settings.defaultPeriod = $("defaultPeriod").value;
  settings.allowDelete = $("allowDelete").value;
  localStorage.setItem(LS.SETTINGS, JSON.stringify(settings));
  logAudit("settings.update", {settings});
  refreshAll();
}
function persistProfile(){
  profile.region = $("scopeRegion").value;
  profile.division = $("scopeDivision").value;
  localStorage.setItem(LS.PROFILE, JSON.stringify(profile));
}

/* =============== RBAC =============== */
function roleLevel(){ return ROLE[profile.role] ?? ROLE.Viewer; }
function can(action){
  const lvl = roleLevel();
  const matrix = {
    import: 1, manualAdd:1, bulkUpdate:1,
    delete: (settings.allowDelete==="always") ? 0 : (settings.allowDelete==="never" ? 99 : 3),
    templateEdit:3, rulesEdit:3, auditClear:4
  };
  return lvl >= (matrix[action] ?? 99);
}
function applyRole(){
  document.querySelector('[data-tab="Templates"]').classList.toggle("hidden", !can("templateEdit"));
  document.querySelector('[data-tab="SLA Rules"]').classList.toggle("hidden", !can("rulesEdit"));
  $("btnDelete").classList.toggle("hidden", !can("delete"));
}

/* =============== TABS =============== */
const TAB_ORDER = ["Upload","Manual Entry","Dashboard","Browse","Templates","Reports","Complaints","Alerts","SLA Rules","Audit","Settings"];
function buildTabs(){
  const host=$("tabs"); host.innerHTML="";
  TAB_ORDER.forEach((name,i)=>{
    const b=document.createElement("button");
    b.className="tab"+(i===2?" active":"");
    b.textContent=name;
    b.onclick=()=>activateTab(name,b);
    host.appendChild(b);
  });
  activateTab("Dashboard", host.children[2]);
}
function activateTab(name,btn){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  btn.classList.add("active");
  document.querySelectorAll("[data-tab]").forEach(sec=>{
    sec.style.display=(sec.getAttribute("data-tab")===name)?"block":"none";
  });
}

/* =============== IMPORT / PATCH =============== */
function handleFile(){
  if(!can("import")) return alert("Not allowed by role.");
  const file=$("fileInput").files[0];
  if(!file) return alert("Choose a file first.");
  const reader=new FileReader();
  reader.onload=(e)=>{
    const data=new Uint8Array(e.target.result);
    const wb=XLSX.read(data,{type:"array"});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const arr=XLSX.utils.sheet_to_json(ws,{defval:""});
    importRows(arr);
  };
  reader.readAsArrayBuffer(file);
}
function importRows(arr){
  const batchId = $("batchName").value.trim() || ("Batch_"+new Date().toISOString().slice(0,10));
  const batchType = $("batchType").value;
  const mode = $("importMode").value;

  if(mode==="replace" && !confirm("Replace ALL existing rows? This cannot be undone.")) return;
  if(mode==="replace"){ rows=[]; }

  const enabled = template.filter(c=>c.enabled).map(c=>c.key);
  const norm = s=>String(s||"").trim().toLowerCase();
  const headerMap={};
  if(arr.length){
    Object.keys(arr[0]).forEach(sc=>{
      const clean=norm(sc).replaceAll("_","-").replace(/\s+/g," ");
      const hit = enabled.find(k=>norm(k)===clean);
      headerMap[sc]=hit||sc;
    });
  }

  let dup=0, miss=0, add=0;
  const existing = new Set(rows.map(r=>String(r["article-number"]||"")));
  arr.forEach(src=>{
    const r={};
    for(const [k,v] of Object.entries(src)){ r[headerMap[k]||k]=v; }
    r._batchId=batchId; r._batchType=batchType;
    const requiredMissing = REQUIRED.some(k=>!String(r[k]||"").trim()); if(requiredMissing) miss++;
    const key=String(r["article-number"]||"");
    if(key && existing.has(key)){ dup++; } else { if(key) existing.add(key); rows.push(r); add++; }
  });

  persist(); refreshAll();
  logAudit("import", {user:session.username, batchId,batchType,mode,added:add,duplicates:dup,missing:miss});
  alert(`Imported ${add} row(s).\nDuplicates skipped: ${dup}\nMissing requireds flagged: ${miss}\nBatch: ${batchId} (${batchType})`);
}
function downloadTemplate(fmt){
  const cols=template.filter(c=>c.enabled).map(c=>c.label||c.key);
  const ws=XLSX.utils.aoa_to_sheet([cols]);
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Template");
  if(fmt==="csv"){
    const csv=XLSX.utils.sheet_to_csv(ws);
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="article_template.csv"; a.click();
  } else { XLSX.writeFile(wb,"article_template.xlsx"); }
}
function downloadPatchSample(){
  const ws = XLSX.utils.aoa_to_sheet([
    ["article-number","DELIVERY STATUS","DELIVERY DATE"],
    ["EX12345","DELIVERED","2025-10-07"]
  ]);
  const csv = XLSX.utils.sheet_to_csv(ws);
  const blob = new Blob([csv],{type:"text/csv;charset=utf-8"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="patch_sample.csv"; a.click();
}
function applyPatch(){
  if(!can("bulkUpdate")) return alert("Not allowed by role.");
  const file=$("patchFile").files[0];
  if(!file) return alert("Choose the patch file.");
  const reader=new FileReader();
  reader.onload=(e)=>{
    const data=new Uint8Array(e.target.result);
    const wb=XLSX.read(data,{type:"array"});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const arr=XLSX.utils.sheet_to_json(ws,{defval:""});
    let applied=0, missing=0;
    const byKey=new Map(rows.map((r,i)=>[String(r["article-number"]||""), i]));
    arr.forEach(p=>{
      const key=String(p["article-number"]||"").trim();
      if(!key || !byKey.has(key)){ missing++; return; }
      const idx=byKey.get(key);
      if(p["DELIVERY STATUS"]) rows[idx]["DELIVERY STATUS"]=String(p["DELIVERY STATUS"]).toUpperCase();
      if(p["DELIVERY DATE"]) rows[idx]["DELIVERY DATE"]=p["DELIVERY DATE"];
      applied++;
    });
    persist(); refreshAll();
    logAudit("patch.apply",{user:session.username, applied,missing});
    alert(`Patch applied.\nUpdated: ${applied}\nNot found: ${missing}`);
  };
  reader.readAsArrayBuffer(file);
}

/* =============== MANUAL ENTRY & BROWSE =============== */
function buildManualForm(){
  const host=$("manualForm"); host.innerHTML="";
  template.filter(c=>c.enabled).forEach(col=>{
    const el=document.createElement("label"); el.className="grow";
    const ph=col.label||col.key;
    const type=/date/i.test(col.key)?"datetime-local":"text";
    el.innerHTML=`<div style="font-size:12px;color:var(--muted);margin-bottom:4px">${ph}${REQUIRED.includes(col.key)?" *":""}</div>
      <input name="${col.key}" placeholder="${ph}" type="${type}"/>`;
    host.appendChild(el);
  });
}
function saveManual(){
  if(!can("manualAdd")) return alert("Not allowed by role.");
  const form=$("manualForm");
  const rec={};
  template.filter(c=>c.enabled).forEach(c=>{
    let v=(form.querySelector(`[name="${c.key}"]`)?.value ?? "").trim();
    if(c.key==="DELIVERY STATUS") v=v.toUpperCase();
    rec[c.key]=v;
  });
  const miss=REQUIRED.filter(k=>!String(rec[k]||"").trim());
  if(miss.length) return alert("Missing required: "+miss.join(", "));
  const k=String(rec["article-number"]||"");
  if(k && rows.some(r=>String(r["article-number"]||"")===k)){
    if(!confirm("Duplicate article-number detected. Add anyway?")) return;
  }
  rec._batchId = "Manual_"+new Date().toISOString();
  rec._batchType = "manual";
  rows.push(rec); persist(); form.reset(); refreshAll();
  logAudit("manual.add",{user:session.username, article:k});
  alert("Saved.");
}

function scopeFilter(r){
  if(profile.region && r.Region !== profile.region) return false;
  if(profile.division && r.Division !== profile.division) return false;
  return true;
}
function getFilters(){
  const q=$("q").value.trim().toLowerCase();
  const from=$("fromDate").value? dayjs($("fromDate").value):null;
  const to=$("toDate").value? dayjs($("toDate").value):null;
  const st=$("fStatus").value;
  const reg=$("fRegion").value;
  const div=$("fDivision").value;
  const batch=$("fBatch").value;
  return {q,from,to,st,reg,div,batch};
}
function passFilters(r, F){
  if(!scopeFilter(r)) return false;
  const text=JSON.stringify(r).toLowerCase();
  if(F.q && !text.includes(F.q)) return false;
  if(F.st && String(r["DELIVERY STATUS"]||"")!==F.st) return false;
  if(F.reg && String(r["Region"]||"")!==F.reg) return false;
  if(F.div && String(r["Division"]||"")!==F.div) return false;
  if(F.batch && String(r["_batchId"]||"")!==F.batch) return false;

  if(F.from || F.to){
    const raw=String(r["booking-date-time"]||"").substring(0,10);
    const d=dayjs(raw || r["booking-date-time"]);
    if(F.from && d.isBefore(F.from,"day")) return false;
    if(F.to && d.isAfter(F.to,"day")) return false;
  }
  return true;
}
function buildOptions(){
  const regs=[...new Set(rows.map(r=>r.Region).filter(Boolean))].sort();
  const divs=[...new Set(rows.map(r=>r.Division).filter(Boolean))].sort();
  const batches=[...new Set(rows.map(r=>r._batchId).filter(Boolean))].sort();
  $("fRegion").innerHTML='<option value="">All Regions</option>'+regs.map(x=>`<option>${x}</option>`).join("");
  $("fDivision").innerHTML='<option value="">All Divisions</option>'+divs.map(x=>`<option>${x}</option>`).join("");
  $("fBatch").innerHTML='<option value="">All Batches</option>'+batches.map(x=>`<option>${x}</option>`).join("");

  // header scope selectors
  $("scopeRegion").innerHTML='<option value="">All Regions</option>'+regs.map(x=>`<option ${x===profile.region?"selected":""}>${x}</option>`).join("");
  $("scopeDivision").innerHTML='<option value="">All Divisions</option>'+divs.map(x=>`<option ${x===profile.division?"selected":""}>${x}</option>`).join("");
}
function renderTable(){
  const F=getFilters();
  const cols=template.filter(c=>c.enabled).map(c=>c.key);
  const tbl=$("dataTable"); tbl.innerHTML="";
  const thead=document.createElement("thead");
  thead.innerHTML=`<tr><th><input type="checkbox" onclick="toggleAll(this)"></th>${cols.map(k=>`<th>${k}</th>`).join("")}</tr>`;
  tbl.appendChild(thead);

  const tbody=document.createElement("tbody");
  rows.filter(r=>passFilters(r,F)).forEach(r=>{
    const tr=document.createElement("tr");
    const idx=rows.indexOf(r);
    const status=String(r["DELIVERY STATUS"]||"").toUpperCase();
    const sc = status==="DELIVERED"?"status-delivered": status==="IN-TRANSIT"?"status-intransit": status==="EXCEPTION"?"status-exception":"status-pending";
    let html = `<td><input type="checkbox" data-id="${idx}"></td>`;
    cols.forEach(c=>{
      let v=r[c]??"";
      if(c==="DELIVERY STATUS"){ v=`<span class="pill ${sc}">${status||"—"}</span>`; }
      html += `<td>${v}</td>`;
    });
    tr.innerHTML=html;
    tr.onclick=(e)=>{ if(e.target.tagName.toLowerCase()==="input") return; showDetails(r); };
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);
}
function toggleAll(master){ document.querySelectorAll('#dataTable tbody input[type="checkbox"]').forEach(ch=> ch.checked=master.checked); }
function showDetails(r){
  const keys=template.filter(c=>c.enabled).map(c=>c.key);
  const msg=keys.map(k=>`${k}: ${r[k]??""}`).join("\n");
  alert(`Record details (Batch: ${r._batchId||"—"}, Type: ${r._batchType||"—"}):\n\n`+msg);
}
function applyBulk(){
  if(!can("bulkUpdate")) return alert("Not allowed by role.");
  const status=$("bulkStatus").value; const d=$("bulkDate").value;
  const ids=[...document.querySelectorAll('#dataTable tbody input[type="checkbox"]:checked')].map(ch=>+ch.dataset.id);
  if(ids.length===0) return alert("Select rows first.");
  ids.forEach(i=>{ if(status) rows[i]["DELIVERY STATUS"]=status; if(d) rows[i]["DELIVERY DATE"]=d; });
  persist(); refreshAll();
  logAudit("bulk.update",{user:session.username, count:ids.length,status,date:d});
  alert("Bulk update applied.");
}
function deleteSelected(){
  if(!can("delete")) return alert("Not allowed by role.");
  const ids=new Set([...document.querySelectorAll('#dataTable tbody input[type="checkbox"]:checked')].map(ch=>+ch.dataset.id));
  if(ids.size===0) return alert("Select rows first.");
  if(!confirm(`Delete ${ids.size} selected row(s)?`)) return;
  rows=rows.filter((r,idx)=>!ids.has(idx));
  persist(); refreshAll();
  logAudit("rows.delete",{user:session.username, count:ids.size});
}

/* =============== EXPORTS =============== */
function exportTable(fmt){
  const F=getFilters();
  const cols=template.filter(c=>c.enabled).map(c=>c.key);
  const data=rows.filter(r=>passFilters(r,F)).map(r=>{
    const o={}; cols.forEach(k=>o[k]=r[k]??""); o._batchId=r._batchId||""; return o;
  });
  if(fmt==="csv"){
    const ws=XLSX.utils.json_to_sheet(data);
    const csv=XLSX.utils.sheet_to_csv(ws);
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="browse_export.csv"; a.click();
  } else {
    const ws=XLSX.utils.json_to_sheet(data);
    const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Browse");
    XLSX.writeFile(wb,"browse_export.xlsx");
  }
}
function exportPDF(){
  const { jsPDF }=window.jspdf;
  const doc=new jsPDF({orientation:"landscape"});
  const cols=template.filter(c=>c.enabled).map(c=>c.key);
  const F=getFilters();
  const data=rows.filter(r=>passFilters(r,F)).map(r=> cols.map(k=> String(r[k]??"")));
  doc.text("Browse Export",14,12);
  doc.autoTable({head:[cols],body:data,startY:16,styles:{fontSize:8}});
  doc.save("browse_export.pdf");
}

/* =============== DASHBOARD / CHARTS =============== */
function slaHoursFor(r){
  const look = [["CUSTOMER", r["customer-id"]],["ARTICLE-TYPE", r["article-type"]],["DIVISION", r["Division"]],["REGION", r["Region"]],["GLOBAL","GLOBAL"]];
  for(const [scope,key] of look){ const hit=rules.find(x=>x.scope===scope && String(x.key||"")===String(key||"")); if(hit) return +hit.hours; }
  return 72;
}
function refreshKPIs(){
  const inScope = rows.filter(r=>scopeFilter(r));
  const total=inScope.length;
  const delivered=inScope.filter(r=>String(r["DELIVERY STATUS"]||"").toUpperCase()==="DELIVERED").length;
  const aged=inScope.filter(r=>{
    const st=String(r["DELIVERY STATUS"]||"").toUpperCase();
    if(st==="DELIVERED"||st==="EXCEPTION") return false;
    const dt=dayjs(r["booking-date-time"]); if(!dt.isValid()) return false;
    return dayjs().diff(dt,"hour") > slaHoursFor(r);
  }).length;
  const exception=inScope.filter(r=>String(r["DELIVERY STATUS"]||"").toUpperCase()==="EXCEPTION").length;
  $("kpiTotal").textContent=total; $("kpiDelivered").textContent=delivered;
  $("kpiAged").textContent=aged; $("kpiException").textContent=exception;
}
let chartsRef={};
function chart(id,cfg){ if(chartsRef[id]) chartsRef[id].destroy(); chartsRef[id]=new Chart(document.getElementById(id),cfg); }
function refreshCharts(){
  const inScope = rows.filter(r=>scopeFilter(r));
  const st=["DELIVERED","IN-TRANSIT","PENDING","EXCEPTION"];
  const cnt=st.map(s=> inScope.filter(r=>String(r["DELIVERY STATUS"]||"").toUpperCase()===s).length);
  chart("chartStatus",{type:"doughnut",data:{labels:st,datasets:[{data:cnt}]},
    options:{plugins:{legend:{position:"bottom"}},
      onClick:(e,els)=>{ if(els[0]){$("fStatus").value=st[els[0].index]; activateTab("Browse",document.querySelectorAll(".tab")[3]); renderTable();}}}});
  const regs=[...new Set(inScope.map(r=>r.Region).filter(Boolean))].sort();
  const byReg=regs.map(reg=> inScope.filter(r=>r.Region===reg).length);
  chart("chartByRegion",{type:"bar",data:{labels:regs,datasets:[{label:"Articles",data:byReg}]},
    options:{plugins:{legend:{display:false}},
      onClick:(e,els)=>{ if(els[0]){$("fRegion").value=regs[els[0].index]; activateTab("Browse",document.querySelectorAll(".tab")[3]); renderTable();}}}});
  const map={}; inScope.forEach(r=>{ const d=(String(r["booking-date-time"]||"").substring(0,10))||""; if(!d) return; map[d]=(map[d]||0)+1; });
  const dates=Object.keys(map).sort();
  chart("chartTrend",{type:"line",data:{labels:dates,datasets:[{label:"Articles",data:dates.map(d=>map[d])}]},options:{plugins:{legend:{display:false}}}});
}

/* =============== REPORTS / RULES / AUDIT / TEMPLATE =============== */
function buildReport(){
  const type=$("reportType").value; const host=$("reportTable"); host.innerHTML="";
  const makeRow=(arr)=>"<tr>"+arr.map(x=>`<td>${x}</td>`).join("")+"</tr>";
  const inScope=rows.filter(r=>scopeFilter(r));
  if(type==="summary"){
    const total=inScope.length;
    const byStatus=["DELIVERED","IN-TRANSIT","PENDING","EXCEPTION"].map(s=>[s,inScope.filter(r=>String(r["DELIVERY STATUS"]||"").toUpperCase()===s).length]);
    const byRegion=countBy("Region", inScope); const byDivision=countBy("Division", inScope);
    host.innerHTML=`<thead><tr><th>Metric</th><th>Value</th></tr></thead><tbody>
      ${makeRow(["Total Articles",total])}${byStatus.map(x=>makeRow([x[0],x[1]])).join("")}
      <tr><th colspan="2">By Region</th></tr>${byRegion.map(x=>makeRow(x)).join
